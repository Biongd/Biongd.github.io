<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="数字IC," />










<meta name="description" content="项目梳理">
<meta property="og:type" content="article">
<meta property="og:title" content="实验过程">
<meta property="og:url" content="http://yoursite.com/2020/10/06/IC%E9%AA%8C%E8%AF%81-%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B/index.html">
<meta property="og:site_name" content="悦来客栈">
<meta property="og:description" content="项目梳理">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210708183029.png">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210708205714.png">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210708223857.png">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210709202114.png">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210711150438.png">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210719203725.png">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210719111922.png">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210719151120.png">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210725083843.png">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210725093928.png">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210725095206.png">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210725100011.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210222232335976.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5Nzk0MDYy,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2021022223272566.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5Nzk0MDYy,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210223002453273.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5Nzk0MDYy,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210223002724759.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5Nzk0MDYy,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210223115209417.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5Nzk0MDYy,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210223162412676.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5Nzk0MDYy,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210726100216.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210223164131969.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5Nzk0MDYy,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210725212500.png">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210726104104.png">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210726104515.png">
<meta property="og:image" content="https://gitee.com/biongd/img/raw/master/img/20210727205241.png">
<meta property="article:published_time" content="2020-10-06T06:25:30.000Z">
<meta property="article:modified_time" content="2021-07-29T15:01:25.341Z">
<meta property="article:author" content="xujunjie&#39;blog">
<meta property="article:tag" content="数字IC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/biongd/img/raw/master/img/20210708183029.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","display_updated":true,"offset":12,"b2t":true,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/10/06/IC验证-实验过程/"/>





  <title>实验过程 | 悦来客栈</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">悦来客栈</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">learn and better</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/06/IC%E9%AA%8C%E8%AF%81-%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xujunjie'blog">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="悦来客栈">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">实验过程</h1>
        

        <div class="post-meta">
          <span class="post-time">
              
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-10-06T14:25:30+08:00">
                2020-10-06
              </time>
            
            
                <span class="post-updated">
                     &nbsp; | &nbsp; 更新于
                     <time itemprop="dateUpdated" datetime="2021-07-29T23:01:25+08:00" content="2021-07-29">
                          2021-07-29
                     </time>
                 </span>
             

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E5%AD%97-SystemVerilog-verilog%E5%9F%BA%E7%A1%80-mcdf%E5%AE%9E%E9%AA%8C-UVM/" itemprop="url" rel="index">
                    <span itemprop="name">数字-SystemVerilog.verilog基础.mcdf实验.UVM.</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>项目梳理</p>
<a id="more"></a>
<h1 id="实验3-1：SystemVerilog的真正引入"><a href="#实验3-1：SystemVerilog的真正引入" class="headerlink" title="实验3-1：SystemVerilog的真正引入"></a>实验3-1：SystemVerilog的真正引入</h1><p><img src="https://gitee.com/biongd/img/raw/master/img/20210708183029.png" alt="image-20210708183029815" style="zoom: 80%;" /></p>
<p>问1：generator中的run方法规定了执行次数，initiator方法未规定执行次数，test类中的如何finish（）？</p>
<p>答：agent封装类中的run方法在调用chnl_generator和chnl_initiator的run方法时，用的是fork-join_any块，即只要数据发送完run方法结束</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fork</span></span><br><span class="line">  gen<span class="variable">.run</span>();</span><br><span class="line">  init<span class="variable">.run</span>();</span><br><span class="line"><span class="keyword">join_any</span></span><br></pre></td></tr></table></figure>
<p>问2：如何保证generator生成一个，initiator发送一个？</p>
<p>答：通过mailbox建立的握手行为，initiator执行get完才能写，generator执行完get才能进入下一次生成数据的循环</p>
<p>问3：如何通过指令控制仿真环境</p>
<ul>
<li><p>重启仿真：”restart”</p>
</li>
<li><p>生成随机数（改变随机种子）：</p>
<p>“vsim -novopt -solvefaildebug -sv_seed 0 work.tb1”</p>
<p>“vsim -novopt -solvefaildebug -sv seed random work.tb1”，每次</p>
<ul>
<li>参数solvefaildebug：随机化失败时会提示错误信息</li>
<li>参数0：随机种子编号，通过改变随机种子即可以改变每次生成的随机值</li>
</ul>
</li>
<li><p>添加参数并通过参数判断是否执行语句：</p>
<p>“+TESTNAME=testname”</p>
</li>
</ul>
<h2 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h2><h3 id="包chnl-pck"><a href="#包chnl-pck" class="headerlink" title="包chnl_pck"></a>包chnl_pck</h3><ul>
<li><p>class chnl_trans：定义激励数据的格式（数据包间隔，数据间隔，通道id，数据包id）</p>
<ul>
<li><p>初始化：记录创建了多少个对象</p>
</li>
<li><p>constraint cstr：</p>
<p>​    通过约束+randomize（）定义数据的初始值（被generator调用）</p>
</li>
<li><p>function chnl_trans clone()：</p>
<p>​    对实例化对象进行复制！！（无需通过new+参数初始化）</p>
</li>
</ul>
</li>
<li><p>class chnl_initiator：构建和dut、generator相连的初始化模型（驱动器）</p>
<ul>
<li><p>初始化：命名</p>
<ul>
<li>属性变量只要interface（沟通dut）和name，还有interface</li>
</ul>
</li>
<li><p>set_interface(virtual chnl_intf intf)：</p>
<p>​    传入实际的interface，给interface句柄赋值</p>
</li>
<li><p><strong>driver（）：</strong></p>
<p>​    <strong>从generator、get数据，然后执行chnl_write(input chnl_trans t)将数据发给dut</strong>，因为write方法内有时钟和reday信号进行阻塞，所以必须等到write方法执行完后才能用mailbox的put，这样generator就被mailbox的get阻塞，无法进行下一次的数据发送</p>
<p>​    通过mailbox和generator进行数据交换，先调用mailbox的get方法，从generator获取数据</p>
</li>
<li><p><strong>chnl_write(input chnl_trans t)：</strong></p>
<p>​    <strong>和dut进行数据交流</strong></p>
<p>​    身为驱动类的必备功能，给dut传数据</p>
</li>
<li><p>chnl_idle()：</p>
<p>​    将valid和data置0，结合数据包间隔，数据间隔，给数据传输添加空窗期</p>
</li>
<li><p><strong>run（）：</strong></p>
<p>​    <strong>执行driver（）</strong></p>
</li>
</ul>
</li>
<li><p><strong>class chnl_generator：</strong>生成数据并发送给initiator</p>
<ul>
<li><p>初始化：（1）在此处对和initiatot交流的mailbox进行实例化；（2）对数据包id，通道id和ntrans赋初值；</p>
<ul>
<li>属性变量包括：通道id，数据包id，对chnl_trans的随机化对象进行约束；ntrans决定数据包的发送次数；</li>
</ul>
</li>
<li><p>send_trans()：</p>
<p>​    对应initiator的driver（）方法</p>
<ul>
<li>此处实例化chnl_trans的req和rsp两个对象，req随机化成功（ this.pkt_id++;），发送给mailbox（也就是initiator），initiator克隆一份后将rsp中的rsp变量修改为1，rsp传回generator后通过rsp属性值判断，作为此次发送是否成功的断言！！！失败则打印</li>
</ul>
</li>
<li><p>run（）：</p>
<p>​    <strong>执行send_trans()</strong></p>
</li>
</ul>
</li>
<li><p>class chnl_agent：对chnl_generator和chnl_initiator进行封装，将对外接口进一步优化</p>
<ul>
<li>初始化：传入chnl_generator和chnl_initiator需要的参数</li>
<li>set_interface(virtual chnl_intf vif)：给chnl_initiator的set_interface方法传入参数</li>
<li>run()：将generator和initiator的run方法进行封装，同时用句柄赋值的方式，让generator和initiator的mailbox指向同一个地址</li>
</ul>
</li>
<li><p>chnl_root_test：最顶层封装，tb文件直接调用的对象，创建3个agent，调用run和set_interface方法</p>
<ul>
<li>初始化：创建3个agent</li>
</ul>
</li>
</ul>
<h3 id="tb文件"><a href="#tb文件" class="headerlink" title="tb文件"></a>tb文件</h3><ul>
<li><p>interface：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> chnl_intf(<span class="keyword">input</span> clk, <span class="keyword">input</span> rstn);</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] ch_data;</span><br><span class="line">  <span class="keyword">logic</span>        ch_valid;</span><br><span class="line">  <span class="keyword">logic</span>        ch_ready;</span><br><span class="line">  <span class="keyword">logic</span> [ <span class="number">5</span>:<span class="number">0</span>] ch_margin;</span><br><span class="line">  <span class="keyword">clocking</span> drv_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">output</span> ch_data, ch_valid;</span><br><span class="line">    <span class="keyword">input</span> ch_ready, ch_margin;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line"><span class="keyword">endinterface</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>module：</p>
<ul>
<li><p>dut的输入输出连接</p>
</li>
<li><p>分配时钟和复位信号</p>
</li>
<li><p>启动test（导包，声明接口，声明句柄并实例化，调用run方法）</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">module</span> tb1;</span><br><span class="line">  <span class="keyword">logic</span>         clk;</span><br><span class="line">  <span class="keyword">logic</span>         rstn;</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>]  mcdt_data;</span><br><span class="line">  <span class="keyword">logic</span>         mcdt_val;</span><br><span class="line">  <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>]  mcdt_id;</span><br><span class="line">  </span><br><span class="line">  mcdt dut(</span><br><span class="line">     <span class="variable">.clk_i</span>       (clk                )</span><br><span class="line">    ,<span class="variable">.rstn_i</span>      (rstn               )</span><br><span class="line">    ,<span class="variable">.ch0_data_i</span>  (chnl0_if<span class="variable">.ch_data</span>   )</span><br><span class="line">    ,<span class="variable">.ch0_valid_i</span> (chnl0_if<span class="variable">.ch_valid</span>  )</span><br><span class="line">    ,<span class="variable">.ch0_ready_o</span> (chnl0_if<span class="variable">.ch_ready</span>  )</span><br><span class="line">    ,<span class="variable">.ch0_margin_o</span>(chnl0_if<span class="variable">.ch_margin</span> )</span><br><span class="line">    ,<span class="variable">.ch1_data_i</span>  (chnl1_if<span class="variable">.ch_data</span>   )</span><br><span class="line">    ,<span class="variable">.ch1_valid_i</span> (chnl1_if<span class="variable">.ch_valid</span>  )</span><br><span class="line">    ,<span class="variable">.ch1_ready_o</span> (chnl1_if<span class="variable">.ch_ready</span>  )</span><br><span class="line">    ,<span class="variable">.ch1_margin_o</span>(chnl1_if<span class="variable">.ch_margin</span> )</span><br><span class="line">    ,<span class="variable">.ch2_data_i</span>  (chnl2_if<span class="variable">.ch_data</span>   )</span><br><span class="line">    ,<span class="variable">.ch2_valid_i</span> (chnl2_if<span class="variable">.ch_valid</span>  )</span><br><span class="line">    ,<span class="variable">.ch2_ready_o</span> (chnl2_if<span class="variable">.ch_ready</span>  )</span><br><span class="line">    ,<span class="variable">.ch2_margin_o</span>(chnl2_if<span class="variable">.ch_margin</span> )</span><br><span class="line">    ,<span class="variable">.mcdt_data_o</span> (mcdt_data          )</span><br><span class="line">    ,<span class="variable">.mcdt_val_o</span>  (mcdt_val           )</span><br><span class="line">    ,<span class="variable">.mcdt_id_o</span>   (mcdt_id            )</span><br><span class="line">  );</span><br><span class="line">      <span class="comment">// clock generation</span></span><br><span class="line">  <span class="keyword">initial</span> <span class="keyword">begin</span> </span><br><span class="line">    clk &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">      #<span class="number">5</span> clk &lt;= !clk;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// reset trigger</span></span><br><span class="line">  <span class="keyword">initial</span> <span class="keyword">begin</span> </span><br><span class="line">    #<span class="number">10</span> rstn &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">repeat</span>(<span class="number">10</span>) @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    rstn &lt;= <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h1 id="实验3-2：generator提取"><a href="#实验3-2：generator提取" class="headerlink" title="实验3-2：generator提取"></a>实验3-2：generator提取</h1><p>爲了更方便的控制generator生成数据，将generator从agent中拿出，直接由test控制</p>
<p><img src="https://gitee.com/biongd/img/raw/master/img/20210708205714.png" alt="image-20210708205714482" style="zoom:80%;" /></p>
<p><img src="https://gitee.com/biongd/img/raw/master/img/20210708223857.png" alt="image-20210708223857777" style="zoom: 80%;" /></p>
<h2 id="文件变化"><a href="#文件变化" class="headerlink" title="文件变化"></a>文件变化</h2><p>vsim+TESTNAME = chnl_burst_test work.tb2</p>
<h3 id="包chnl-pck-1"><a href="#包chnl-pck-1" class="headerlink" title="包chnl_pck"></a>包chnl_pck</h3><ul>
<li><p><strong>chnl_generator：</strong></p>
<p>属性变量连原本由chnl_trans控制的data_size，pkt_nidles也加入了进来，目的也是让test可以完全掌握数据生成</p>
<p>通过一层层的约束</p>
<p><strong>注意：为什么随机化里面用的是local：：而不用this？</strong></p>
<p>local指的是generator 的实例对象，如果在这里使用this，指的是调用randomsize方法的数据实例对象</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> pkt_id = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> ch_id = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> data_nidles = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> pkt_nidles = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> data_size = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> ntrans = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">constraint</span> cstr&#123;</span><br><span class="line">      <span class="keyword">soft</span> ch_id == -<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">soft</span> pkt_id == -<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">soft</span> data_size == -<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">soft</span> data_nidles == -<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">soft</span> pkt_nidles == -<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">soft</span> ntrans == <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">task</span> send_trans();</span><br><span class="line">      chnl_trans req, rsp;</span><br><span class="line">      req = <span class="keyword">new</span>();</span><br><span class="line">	<span class="keyword">assert</span>(req<span class="variable">.randomize</span> <span class="keyword">with</span> &#123;<span class="keyword">local</span>::ch_id &gt;= <span class="number">0</span> -&gt; ch_id == <span class="keyword">local</span>::ch_id; </span><br><span class="line">                                 <span class="keyword">local</span>::pkt_id &gt;= <span class="number">0</span> -&gt; pkt_id == <span class="keyword">local</span>::pkt_id;</span><br><span class="line">                                 <span class="keyword">local</span>::data_nidles &gt;= <span class="number">0</span> -&gt; data_nidles == <span class="keyword">local</span>::data_nidles;</span><br><span class="line">                                 <span class="keyword">local</span>::pkt_nidles &gt;= <span class="number">0</span> -&gt; pkt_nidles == <span class="keyword">local</span>::pkt_nidles;</span><br><span class="line">                                 <span class="keyword">local</span>::data_size &gt;<span class="number">0</span> -&gt; data<span class="variable">.size</span>() == <span class="keyword">local</span>::data_size; </span><br><span class="line">                               &#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>class chnl_agent：将generator摘除</p>
</li>
<li><p>class chnl_root_test：变化最大</p>
<ul>
<li><p>初始化：agent和generator分别创建3个</p>
<p>​    因为generator从agent中提出，建立initiator和generator的mailbox连接的任务交由test完成</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"chnl_root_test"</span>);</span><br><span class="line">    <span class="keyword">foreach</span>(agent[i]) <span class="keyword">begin</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.agent</span>[i] = <span class="keyword">new</span>(<span class="built_in">$sformatf</span>(<span class="string">"chnl_agent%0d"</span>,i));</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.gen</span>[i] = <span class="keyword">new</span>();</span><br><span class="line">      <span class="comment">// USER TODO 2.1</span></span><br><span class="line">      <span class="comment">// Connect the mailboxes handles of gen[i] and agent[i].init</span></span><br><span class="line">        agent[i]<span class="variable">.init</span><span class="variable">.req_mb</span> = gen[i]<span class="variable">.req_mb</span>;</span><br><span class="line">        agent[i]<span class="variable">.init</span><span class="variable">.rsp_mb</span> = gen[i]<span class="variable">.rsp_mb</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">this</span><span class="variable">.name</span> = name;</span><br><span class="line">    <span class="built_in">$display</span>(<span class="string">"%s instantiate objects"</span>, <span class="keyword">this</span><span class="variable">.name</span>);</span><br><span class="line">  <span class="keyword">endfunction</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>do_config()：对创建的3个generator实例进行随机化(赋予数据)，对比3-1中在generator中的随机化，明显对外暴露了更多接口可以自定义（只需在test中修改）</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assert</span>(gen[<span class="number">0</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans==<span class="number">100</span>; data_nidles==<span class="number">0</span>; pkt_nidles==<span class="number">1</span>; data_size==<span class="number">8</span>;&#125;)</span><br><span class="line"><span class="keyword">assert</span>(req<span class="variable">.randomize</span> <span class="keyword">with</span> &#123;ch_id == <span class="keyword">local</span>::ch_id; pkt_id == <span class="keyword">local</span>::pkt_id;&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>run()：同样因为gen和init的分离，run方法如何执行和结束也是一个问题</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span><span class="variable">.do_config</span>();</span><br><span class="line">  <span class="keyword">fork</span></span><br><span class="line">    agent[<span class="number">0</span>]<span class="variable">.run</span>();</span><br><span class="line">    agent[<span class="number">1</span>]<span class="variable">.run</span>();</span><br><span class="line">    agent[<span class="number">2</span>]<span class="variable">.run</span>();</span><br><span class="line">  <span class="keyword">join_none</span></span><br><span class="line">  <span class="keyword">fork</span></span><br><span class="line">    gen[<span class="number">0</span>]<span class="variable">.run</span>();</span><br><span class="line">    gen[<span class="number">1</span>]<span class="variable">.run</span>();</span><br><span class="line">    gen[<span class="number">2</span>]<span class="variable">.run</span>();</span><br><span class="line">  <span class="keyword">join</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h1 id="实验3-3：增加新组件monitor和checker"><a href="#实验3-3：增加新组件monitor和checker" class="headerlink" title="实验3-3：增加新组件monitor和checker"></a>实验3-3：增加新组件monitor和checker</h1><p><strong>monitor和checker干了嘛?</strong></p>
<ul>
<li><p>monitor: 分为chnl_monitor监控输入和mcdt_monitor监控输出</p>
<ul>
<li><p>如何保证采集数有效：就是允许数据传输的条件</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//chnl</span></span><br><span class="line">@(<span class="keyword">posedge</span> intf<span class="variable">.clk</span> <span class="keyword">iff</span> (intf<span class="variable">.mon_ck</span><span class="variable">.ch_valid</span>===<span class="number">'b1</span> &amp;&amp; intf<span class="variable">.mon_ck</span><span class="variable">.ch_ready</span>===<span class="number">'b1</span>));</span><br><span class="line"> m<span class="variable">.data</span> = intf<span class="variable">.mon_ck</span><span class="variable">.ch_data</span>;</span><br><span class="line">        mon_mb<span class="variable">.put</span>(m);</span><br><span class="line"><span class="comment">//mcdt</span></span><br><span class="line">@(<span class="keyword">posedge</span> intf<span class="variable">.clk</span> <span class="keyword">iff</span> intf<span class="variable">.mon_ck</span><span class="variable">.mcdt_val</span>===<span class="number">'b1</span>);</span><br><span class="line">m<span class="variable">.data</span> = intf<span class="variable">.mon_ck</span><span class="variable">.mcdt_data</span>;</span><br><span class="line">        m<span class="variable">.id</span> = intf<span class="variable">.mon_ck</span><span class="variable">.mcdt_id</span>;</span><br><span class="line">        mon_mb<span class="variable">.put</span>(m);</span><br></pre></td></tr></table></figure>
</li>
<li><p>monitor的run方法：就是为了将采集数据放入mailbox</p>
</li>
</ul>
</li>
<li><p>checker：run方法就是从monitor发送的mailbox中获取数据，比较chnl的mailbox和mcdt的mailbox的数据是否一致</p>
</li>
</ul>
<p><strong>问1：chnl_monitor和mcdt_monitor的数据对比如何保证数据的顺序是对应的？</strong></p>
<p>两者的mailbox保证了上下的数据都是进到队列里面，然后从头部拿出比较，一方为空则比较，或者说checker的run就无法执行</p>
<p><strong>问2：不用$finish()了，如何结束的进程</strong></p>
<ul>
<li><p>结束整个进程：test自定义<code>run_stop_callback()</code>方法。方法内部通过获取3把钥匙进行阻塞，每有一个gen执行完发送，put一个钥匙</p>
<p>在整个文件的最开始建立旗语， <code>semaphore run_stop_flags = new();</code> 在generator中每有一个发送了ntrans个数据包截止的时候put进去一个钥匙，当三个gen都执行完，run_stop_flags获得三把钥匙，执行$finish()，归根结底还是用的finish</p>
</li>
<li><p>full_test中结束generator：先看一下full_test中给gen赋值的随机化约束：ntrans是不定值</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assert</span>(gen[<span class="number">0</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans <span class="keyword">inside</span> &#123;[<span class="number">1000</span>:<span class="number">2000</span>]&#125;; data_nidles==<span class="number">0</span>; pkt_nidles==<span class="number">1</span>; data_size <span class="keyword">inside</span> &#123;<span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>&#125;;&#125;)</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">$fatal</span>(<span class="string">"[RNDFAIL] gen[0] randomization failure!"</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>问3：mailbox有几个，在哪些组件间建立连接</strong></p>
<p>答：共有6个</p>
<ul>
<li><p>4个被checker和monitor持有，3个是agent的monitor和checker之间建立的连接，1个是mcdt的monitor和checker的连接</p>
</li>
<li><p>2个被gen和init持有，用于两者的握手协议</p>
</li>
<li><p>注意: 可以看到monitor的数据<code>mon_data_t</code>声明非常简单，其和checker的数据传输单纯就是一个存储的队列</p>
</li>
<li><p>同样在root_test中建立连接</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(agents[i]) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.agents</span>[i] = <span class="keyword">new</span>(<span class="built_in">$sformatf</span>(<span class="string">"chnl_agent%0d"</span>,i));</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.gen</span>[i] = <span class="keyword">new</span>();</span><br><span class="line">        <span class="comment">// USER TODO 2.1</span></span><br><span class="line">        <span class="comment">// Connect the mailboxes handles of gen[i] and agents[i].init</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.agents</span>[i]<span class="variable">.init</span><span class="variable">.req_mb</span> = <span class="keyword">this</span><span class="variable">.gen</span>[i]<span class="variable">.req_mb</span>;</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.agents</span>[i]<span class="variable">.init</span><span class="variable">.rsp_mb</span> = <span class="keyword">this</span><span class="variable">.gen</span>[i]<span class="variable">.rsp_mb</span>;</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.agents</span>[i]<span class="variable">.mon</span><span class="variable">.mon_mb</span> = <span class="keyword">this</span><span class="variable">.chker</span><span class="variable">.in_mbs</span>[i];</span><br><span class="line">      <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="https://gitee.com/biongd/img/raw/master/img/20210709202114.png" alt="image-20210709202107429"></p>
<h2 id="新加入文件结构"><a href="#新加入文件结构" class="headerlink" title="新加入文件结构"></a>新加入文件结构</h2><h3 id="包chnl-pack"><a href="#包chnl-pack" class="headerlink" title="包chnl_pack"></a>包chnl_pack</h3><ul>
<li><p>typedef struct packed：</p>
<p>低配版的chnl_trans，作为monitor里的数据容器</p>
</li>
<li><p>class chnl_monitor：获取dut输入，发送给checker</p>
<ul>
<li><p>属性：name，interface，mailbox（未实例化）</p>
</li>
<li><p>set_interface：传入接口</p>
</li>
<li><p>mon_trans：发mail给ckecker</p>
<ul>
<li><p><code>@(posedge intf.clk iff (intf.mon_ck.ch_valid===&#39;b1 &amp;&amp; intf.mon_ck.ch_ready===&#39;b1))</code></p>
<p>保证在数据传输的时候进行采样；</p>
</li>
<li><p>并且将数据线上的数据装盒，放入mailbox</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>class mcdt_monitor：获取dut输出，发送给checker</p>
</li>
<li><p>class chnl_agent更新：将chnl_monitor加入，run方法中加入monitor.run();</p>
</li>
<li><p>class chnl_checker：</p>
<ul>
<li>属性：name，error_count，cmp_count，mailbox</li>
<li>初始化：对邮箱实例化，错误和完成计数初始化<ul>
<li>注意：chnl_monitor有3个，需创建3个mailbox与之对应，监控3个chnl</li>
</ul>
</li>
<li>do_compare()：这里的阻塞</li>
</ul>
</li>
<li><p>chnl_root_test：作为所有测试类的基类</p>
<p>功能：</p>
<ul>
<li>初始化：实例化各部分组件，连接mailbox（generator和driver的连接，monitor和checker的连接）</li>
<li>虚方法（do_config）：执行随机化，可以通过断言判断随机化是否成功（在子类中实现）</li>
</ul>
</li>
<li><p>chnl_basic_test：实现随机化的config方法</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">virtual</span> <span class="keyword">function</span> <span class="keyword">void</span> do_config();</span><br><span class="line">      <span class="keyword">super</span><span class="variable">.do_config</span>();</span><br><span class="line">      <span class="keyword">assert</span>(gen[<span class="number">0</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans==<span class="number">100</span>; data_nidles==<span class="number">0</span>; pkt_nidles==<span class="number">1</span>; data_size==<span class="number">8</span>;&#125;)</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">$fatal</span>(<span class="string">"[RNDFAIL] gen[0] randomization failure!"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">assert</span>(gen[<span class="number">1</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans==<span class="number">50</span>; data_nidles <span class="keyword">inside</span> &#123;[<span class="number">1</span>:<span class="number">2</span>]&#125;; pkt_nidles <span class="keyword">inside</span> &#123;[<span class="number">3</span>:<span class="number">5</span>]&#125;; data_size==<span class="number">6</span>;&#125;)</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">$fatal</span>(<span class="string">"[RNDFAIL] gen[1] randomization failure!"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">assert</span>(gen[<span class="number">2</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans==<span class="number">80</span>; data_nidles <span class="keyword">inside</span> &#123;[<span class="number">0</span>:<span class="number">1</span>]&#125;; pkt_nidles <span class="keyword">inside</span> &#123;[<span class="number">1</span>:<span class="number">2</span>]&#125;; data_size==<span class="number">32</span>;&#125;)</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">$fatal</span>(<span class="string">"[RNDFAIL] gen[2] randomization failure!"</span>);</span><br><span class="line">    <span class="keyword">endfunction</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>chnl_burst_test：随机化存在差别，</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">virtual</span> <span class="keyword">function</span> <span class="keyword">void</span> do_config();</span><br><span class="line">  <span class="keyword">super</span><span class="variable">.do_config</span>();</span><br><span class="line">  <span class="keyword">assert</span>(gen[<span class="number">0</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans <span class="keyword">inside</span> &#123;[<span class="number">80</span>:<span class="number">100</span>]&#125;; data_nidles==<span class="number">0</span>; pkt_nidles==<span class="number">1</span>; data_size <span class="keyword">inside</span> &#123;<span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>&#125;;&#125;)</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">$fatal</span>(<span class="string">"[RNDFAIL] gen[0] randomization failure!"</span>);</span><br><span class="line">  <span class="keyword">assert</span>(gen[<span class="number">1</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans <span class="keyword">inside</span> &#123;[<span class="number">80</span>:<span class="number">100</span>]&#125;; data_nidles==<span class="number">0</span>; pkt_nidles==<span class="number">1</span>; data_size <span class="keyword">inside</span> &#123;<span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>&#125;;&#125;)</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">$fatal</span>(<span class="string">"[RNDFAIL] gen[1] randomization failure!"</span>);</span><br><span class="line">  <span class="keyword">assert</span>(gen[<span class="number">2</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans <span class="keyword">inside</span> &#123;[<span class="number">80</span>:<span class="number">100</span>]&#125;; data_nidles==<span class="number">0</span>; pkt_nidles==<span class="number">1</span>; data_size <span class="keyword">inside</span> &#123;<span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>&#125;;&#125;)</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">$fatal</span>(<span class="string">"[RNDFAIL] gen[2] randomization failure!"</span>);</span><br><span class="line"><span class="keyword">endfunction</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>chnl_fifo_full_test：大数据量冲击</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">virtual</span> <span class="keyword">function</span> <span class="keyword">void</span> do_config();</span><br><span class="line">  <span class="keyword">super</span><span class="variable">.do_config</span>();</span><br><span class="line">  <span class="keyword">assert</span>(gen[<span class="number">0</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans <span class="keyword">inside</span> &#123;[<span class="number">1000</span>:<span class="number">2000</span>]&#125;; data_nidles==<span class="number">0</span>; pkt_nidles==<span class="number">1</span>; data_size <span class="keyword">inside</span> &#123;<span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>&#125;;&#125;)</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">$fatal</span>(<span class="string">"[RNDFAIL] gen[0] randomization failure!"</span>);</span><br><span class="line">  <span class="keyword">assert</span>(gen[<span class="number">1</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans <span class="keyword">inside</span> &#123;[<span class="number">1000</span>:<span class="number">2000</span>]&#125;; data_nidles==<span class="number">0</span>; pkt_nidles==<span class="number">1</span>; data_size <span class="keyword">inside</span> &#123;<span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>&#125;;&#125;)</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">$fatal</span>(<span class="string">"[RNDFAIL] gen[1] randomization failure!"</span>);</span><br><span class="line">  <span class="keyword">assert</span>(gen[<span class="number">2</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans <span class="keyword">inside</span> &#123;[<span class="number">1000</span>:<span class="number">2000</span>]&#125;; data_nidles==<span class="number">0</span>; pkt_nidles==<span class="number">1</span>; data_size <span class="keyword">inside</span> &#123;<span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>&#125;;&#125;)</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">$fatal</span>(<span class="string">"[RNDFAIL] gen[2] randomization failure!"</span>);</span><br><span class="line"><span class="keyword">endfunction</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="tb文件-1"><a href="#tb文件-1" class="headerlink" title="tb文件"></a>tb文件</h3><p>优化：通过外部指令决定执行那个类</p>
<p>核心知识点：</p>
<ul>
<li>字符串索引的关联数组：类似哈希表，不过是将key变成了数组下标，实现字符串到数组元素的映射</li>
<li>将3个实例化的test模块放入数组，通过命令键入的字符串取出，用父类test接收，决定执行那个test的方法！！！</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">import</span> chnl_pkg3::*;</span><br><span class="line"></span><br><span class="line">  chnl_intf chnl0_if(.*);</span><br><span class="line">  chnl_intf chnl1_if(.*);</span><br><span class="line">  chnl_intf chnl2_if(.*);</span><br><span class="line">  mcdt_intf mcdt_if(.*);</span><br><span class="line"></span><br><span class="line">  chnl_basic_test basic_test;</span><br><span class="line">  chnl_burst_test burst_test;</span><br><span class="line">  chnl_fifo_full_test fifo_full_test;</span><br><span class="line">  chnl_root_test tests[<span class="keyword">string</span>];</span><br><span class="line">  <span class="keyword">string</span> name;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">initial</span> <span class="keyword">begin</span> </span><br><span class="line">    basic_test = <span class="keyword">new</span>();</span><br><span class="line">    burst_test = <span class="keyword">new</span>();</span><br><span class="line">    fifo_full_test = <span class="keyword">new</span>();</span><br><span class="line">    tests[<span class="string">"chnl_basic_test"</span>] = basic_test;</span><br><span class="line">    tests[<span class="string">"chnl_burst_test"</span>] = burst_test;</span><br><span class="line">    tests[<span class="string">"chnl_fifo_full_test"</span>] = fifo_full_test;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">$value$plusargs</span>(<span class="string">"TESTNAME=%s"</span>, name)) <span class="keyword">begin</span></span><br><span class="line">      <span class="keyword">if</span>(tests<span class="variable">.exists</span>(name)) <span class="keyword">begin</span></span><br><span class="line">        tests[name]<span class="variable">.set_interface</span>(chnl0_if, chnl1_if, chnl2_if, mcdt_if);</span><br><span class="line">        tests[name]<span class="variable">.run</span>();</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="built_in">$fatal</span>(<span class="built_in">$sformatf</span>(<span class="string">"[ERRTEST], test name %s is invalid, please specify a valid name!"</span>, name));</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">      <span class="built_in">$display</span>(<span class="string">"NO runtime optiont +TESTNAME=xxx is configured, and run default test chnl_basic_test"</span>);</span><br><span class="line">      tests[<span class="string">"chnl_basic_test"</span>]<span class="variable">.set_interface</span>(chnl0_if, chnl1_if, chnl2_if, mcdt_if);</span><br><span class="line">      tests[<span class="string">"chnl_basic_test"</span>]<span class="variable">.run</span>(); </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>
<h1 id="实验4：新增结构"><a href="#实验4：新增结构" class="headerlink" title="实验4：新增结构"></a>实验4：新增结构</h1><p>问1：param_def.v</p>
<p>如图：将reg，formatter拿入考量</p>
<p><img src="https://gitee.com/biongd/img/raw/master/img/20210711150438.png" alt="image-20210711150431833" style="zoom:67%;" /></p>
<h2 id="文件结构-1"><a href="#文件结构-1" class="headerlink" title="文件结构"></a>文件结构</h2><h3 id="param-def-v"><a href="#param-def-v" class="headerlink" title="param_def.v"></a>param_def.v</h3><p>通过宏（<code>&#39;define</code>）对部分参数进行定义，硬件部分使用</p>
<ul>
<li>reg输入、输出：<ul>
<li>地址位宽</li>
<li>数据位宽</li>
<li>3个命令（对应2位2进制）</li>
<li>6个寄存器地址</li>
<li>6个寄存器编号</li>
</ul>
</li>
<li>chnl：（输入reg的状态寄存器）<ul>
<li>slave_fifo的余量位宽：`define FIFO_MARGIN_WIDTH</li>
</ul>
</li>
<li>优先级：（输出，给arbiter）</li>
<li>数据包长度：（输出，给formatter）</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span>  ADDR_WIDTH 8</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span>  CMD_DATA_WIDTH 32</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span>  WRITE 2'b10          //Register operation command</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span>  READ  2'b01</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span>  IDLE  2'b00</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> SLV0_RW_ADDR 8'h00    //Register address </span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> SLV1_RW_ADDR 8'h04</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> SLV2_RW_ADDR 8'h08</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> SLV0_R_ADDR  8'h10</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> SLV1_R_ADDR  8'h14</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> SLV2_R_ADDR  8'h18</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> SLV0_RW_REG 0</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> SLV1_RW_REG 1</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> SLV2_RW_REG 2</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> SLV0_R_REG  3</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> SLV1_R_REG  4</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> SLV2_R_REG  5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> FIFO_MARGIN_WIDTH 8</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> PRIO_WIDTH 2</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> PRIO_HIGH 2</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> PRIO_LOW  1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> PAC_LEN_WIDTH 3</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> PAC_LEN_HIGH 5</span></span><br><span class="line"><span class="meta">`<span class="meta-keyword">define</span> PAC_LEN_LOW  3</span></span><br></pre></td></tr></table></figure>
<h3 id="1-包chnl-pack-基层包，无需导包"><a href="#1-包chnl-pack-基层包，无需导包" class="headerlink" title="1. 包chnl_pack(基层包，无需导包)"></a>1. 包chnl_pack(基层包，无需导包)</h3><p>变化：结构更加规范：</p>
<ul>
<li>class mcdt_monitor，class chnl_checker还有test均从该包拿出；</li>
<li>仅保留和chnl相关的功能，即生成激励gen，发送数据driver（initiator改名），监控数据monitor；</li>
<li>driver存在些许改变，增加reset方法对复位信号做出响应</li>
</ul>
<h4 id="interface"><a href="#interface" class="headerlink" title="interface"></a>interface</h4><p>和硬件交流的信号</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> chnl_intf(<span class="keyword">input</span> clk, <span class="keyword">input</span> rstn);</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] ch_data;</span><br><span class="line">  <span class="keyword">logic</span>        ch_valid;</span><br><span class="line">  <span class="keyword">logic</span>        ch_ready;</span><br><span class="line">  <span class="keyword">clocking</span> drv_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">output</span> ch_data, ch_valid;</span><br><span class="line">    <span class="keyword">input</span> ch_ready;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line">  <span class="keyword">clocking</span> mon_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">input</span> ch_data, ch_valid, ch_ready;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line"><span class="keyword">endinterface</span></span><br></pre></td></tr></table></figure>
<h4 id="transcation"><a href="#transcation" class="headerlink" title="transcation"></a>transcation</h4><p>driver需要的数据：只有data是被硬件需要的，其他的ch_id，pkt_id是所在通道和包的信息，data_nidles，pkt_nidles是对间隔时间的配置</p>
<p>这里的clone（）和sprint（）方法，在UVM中可以通过自动化域的方法取代</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> chnl_trans;</span><br><span class="line">  <span class="keyword">rand</span> <span class="keyword">bit</span>[<span class="number">31</span>:<span class="number">0</span>] data[];</span><br><span class="line">  <span class="keyword">rand</span> <span class="keyword">int</span> ch_id;</span><br><span class="line">  <span class="keyword">rand</span> <span class="keyword">int</span> pkt_id;</span><br><span class="line">  <span class="keyword">rand</span> <span class="keyword">int</span> data_nidles;</span><br><span class="line">  <span class="keyword">rand</span> <span class="keyword">int</span> pkt_nidles;</span><br><span class="line">  <span class="keyword">bit</span> rsp;</span><br><span class="line">  <span class="keyword">constraint</span> cstr&#123;</span><br><span class="line">    <span class="keyword">soft</span> data<span class="variable">.size</span> <span class="keyword">inside</span> &#123;[<span class="number">4</span>:<span class="number">32</span>]&#125;;</span><br><span class="line">    <span class="keyword">foreach</span>(data[i]) data[i] == <span class="number">'hC000_0000</span> + (<span class="keyword">this</span><span class="variable">.ch_id</span>&lt;&lt;<span class="number">24</span>) + (<span class="keyword">this</span><span class="variable">.pkt_id</span>&lt;&lt;<span class="number">8</span>) + i;</span><br><span class="line">    <span class="keyword">soft</span> ch_id == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">soft</span> pkt_id == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">soft</span> data_nidles <span class="keyword">inside</span> &#123;[<span class="number">0</span>:<span class="number">2</span>]&#125;;</span><br><span class="line">    <span class="keyword">soft</span> pkt_nidles <span class="keyword">inside</span> &#123;[<span class="number">1</span>:<span class="number">10</span>]&#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> chnl_trans clone();</span><br><span class="line">    chnl_trans c = <span class="keyword">new</span>();</span><br><span class="line">    c<span class="variable">.data</span> = <span class="keyword">this</span><span class="variable">.data</span>;</span><br><span class="line">    c<span class="variable">.ch_id</span> = <span class="keyword">this</span><span class="variable">.ch_id</span>;</span><br><span class="line">    c<span class="variable">.pkt_id</span> = <span class="keyword">this</span><span class="variable">.pkt_id</span>;</span><br><span class="line">    c<span class="variable">.data_nidles</span> = <span class="keyword">this</span><span class="variable">.data_nidles</span>;</span><br><span class="line">    c<span class="variable">.pkt_nidles</span> = <span class="keyword">this</span><span class="variable">.pkt_nidles</span>;</span><br><span class="line">    c<span class="variable">.rsp</span> = <span class="keyword">this</span><span class="variable">.rsp</span>;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">string</span> sprint();</span><br><span class="line">    <span class="keyword">string</span> s;</span><br><span class="line">    s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>)&#125;;</span><br><span class="line">    s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"chnl_trans object content is as below: \n"</span>)&#125;;</span><br><span class="line">    <span class="keyword">foreach</span>(data[i]) s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"data[%0d] = %8x \n"</span>, i, <span class="keyword">this</span><span class="variable">.data</span>[i])&#125;;</span><br><span class="line">    s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"ch_id = %0d: \n"</span>, <span class="keyword">this</span><span class="variable">.ch_id</span>)&#125;;</span><br><span class="line">    s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"pkt_id = %0d: \n"</span>, <span class="keyword">this</span><span class="variable">.pkt_id</span>)&#125;;</span><br><span class="line">    s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"data_nidles = %0d: \n"</span>, <span class="keyword">this</span><span class="variable">.data_nidles</span>)&#125;;</span><br><span class="line">    s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"pkt_nidles = %0d: \n"</span>, <span class="keyword">this</span><span class="variable">.pkt_nidles</span>)&#125;;</span><br><span class="line">    s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"rsp = %0d: \n"</span>, <span class="keyword">this</span><span class="variable">.rsp</span>)&#125;;</span><br><span class="line">    s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>)&#125;;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"><span class="keyword">endclass</span>: chnl_trans</span><br></pre></td></tr></table></figure>
<h4 id="driver"><a href="#driver" class="headerlink" title="driver"></a>driver</h4><p>核心功能：</p>
<ul>
<li><p>从generator接收激励：mailbox，do_driver()；</p>
</li>
<li><p>对接口进行驱动：do_driver{mailbox.get(REQ)；chnl_write()；mailbox.put（RSP）}</p>
<p>将mailbox中拿出的trans类型的req，把数据放到接口上，vaild信号置为1；然后等待ready信号来就可以执行idle把数据关闭了</p>
</li>
<li><p>复位：独立的监控线程，一旦检测复位信号，vailid和data信号拉低</p>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> chnl_driver;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">string</span> name;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">virtual</span> chnl_intf intf;</span><br><span class="line">    mailbox <span class="variable">#(chnl_trans)</span> req_mb;</span><br><span class="line">    mailbox <span class="variable">#(chnl_trans)</span> rsp_mb;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"chnl_driver"</span>);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.name</span> = name;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> set_interface(<span class="keyword">virtual</span> chnl_intf intf);</span><br><span class="line">      <span class="keyword">if</span>(intf == <span class="literal">null</span>)</span><br><span class="line">        <span class="built_in">$error</span>(<span class="string">"interface handle is NULL, please check if target interface has been intantiated"</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.intf</span> = intf;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> run();</span><br><span class="line">      <span class="keyword">fork</span></span><br><span class="line">       <span class="keyword">this</span><span class="variable">.do_drive</span>();</span><br><span class="line">       <span class="keyword">this</span><span class="variable">.do_reset</span>();</span><br><span class="line">      <span class="keyword">join</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_reset();</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        @(<span class="keyword">negedge</span> intf<span class="variable">.rstn</span>);</span><br><span class="line">        intf<span class="variable">.ch_valid</span> &lt;= <span class="number">0</span>;</span><br><span class="line">        intf<span class="variable">.ch_data</span> &lt;= <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_drive();</span><br><span class="line">      chnl_trans req, rsp;</span><br><span class="line">      @(<span class="keyword">posedge</span> intf<span class="variable">.rstn</span>);</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.req_mb</span><span class="variable">.get</span>(req);</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.chnl_write</span>(req);</span><br><span class="line">        rsp = req<span class="variable">.clone</span>();</span><br><span class="line">        rsp<span class="variable">.rsp</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.rsp_mb</span><span class="variable">.put</span>(rsp);</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">task</span> chnl_write(<span class="keyword">input</span> chnl_trans t);</span><br><span class="line">      <span class="keyword">foreach</span>(t<span class="variable">.data</span>[i]) <span class="keyword">begin</span></span><br><span class="line">        @(<span class="keyword">posedge</span> intf<span class="variable">.clk</span>);</span><br><span class="line">        intf<span class="variable">.drv_ck</span><span class="variable">.ch_valid</span> &lt;= <span class="number">1</span>;</span><br><span class="line">        intf<span class="variable">.drv_ck</span><span class="variable">.ch_data</span> &lt;= t<span class="variable">.data</span>[i];</span><br><span class="line">        @(<span class="keyword">negedge</span> intf<span class="variable">.clk</span>);</span><br><span class="line">        <span class="keyword">wait</span>(intf<span class="variable">.ch_ready</span> === <span class="number">'b1</span>);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">"%0t channel driver [%s] sent data %x"</span>, <span class="built_in">$time</span>, name, t<span class="variable">.data</span>[i]);</span><br><span class="line">        <span class="keyword">repeat</span>(t<span class="variable">.data_nidles</span>) chnl_idle();</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">repeat</span>(t<span class="variable">.pkt_nidles</span>) chnl_idle();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">task</span> chnl_idle();</span><br><span class="line">      @(<span class="keyword">posedge</span> intf<span class="variable">.clk</span>);</span><br><span class="line">      intf<span class="variable">.drv_ck</span><span class="variable">.ch_valid</span> &lt;= <span class="number">0</span>;</span><br><span class="line">      intf<span class="variable">.drv_ck</span><span class="variable">.ch_data</span> &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">  <span class="keyword">endclass</span>: chnl_driver</span><br></pre></td></tr></table></figure>
<h4 id="generator"><a href="#generator" class="headerlink" title="generator"></a>generator</h4><p>成员变量和transcation基本相同，无data数组，改为data.size；</p>
<p>generator的随机化约束只是为了使其内部随机化无法生效，需要外部控制</p>
<p>核心功能：send_trans()，实例化trans类型变量req，对req做transcation的随机化，然后将req传入mailbox，发送给driver！！</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> chnl_generator;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> pkt_id = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> ch_id = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> data_nidles = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> pkt_nidles = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> data_size = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> ntrans = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    mailbox <span class="variable">#(chnl_trans)</span> req_mb;</span><br><span class="line">    mailbox <span class="variable">#(chnl_trans)</span> rsp_mb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constraint</span> cstr&#123;</span><br><span class="line">      <span class="keyword">soft</span> ch_id == -<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">soft</span> pkt_id == <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">soft</span> data_size == -<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">soft</span> data_nidles == -<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">soft</span> pkt_nidles == -<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">soft</span> ntrans == <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.req_mb</span> = <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.rsp_mb</span> = <span class="keyword">new</span>();</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> start();</span><br><span class="line">      <span class="keyword">repeat</span>(ntrans) send_trans();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> send_trans();</span><br><span class="line">      chnl_trans req, rsp;</span><br><span class="line">      req = <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">assert</span>(req<span class="variable">.randomize</span> <span class="keyword">with</span> &#123;<span class="keyword">local</span>::ch_id &gt;= <span class="number">0</span> -&gt; ch_id == <span class="keyword">local</span>::ch_id; </span><br><span class="line">                                 <span class="keyword">local</span>::pkt_id &gt;= <span class="number">0</span> -&gt; pkt_id == <span class="keyword">local</span>::pkt_id;</span><br><span class="line">                                 <span class="keyword">local</span>::data_nidles &gt;= <span class="number">0</span> -&gt; data_nidles == <span class="keyword">local</span>::data_nidles;</span><br><span class="line">                                 <span class="keyword">local</span>::pkt_nidles &gt;= <span class="number">0</span> -&gt; pkt_nidles == <span class="keyword">local</span>::pkt_nidles;</span><br><span class="line">                                 <span class="keyword">local</span>::data_size &gt;<span class="number">0</span> -&gt; data<span class="variable">.size</span>() == <span class="keyword">local</span>::data_size; </span><br><span class="line">                               &#125;)</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">$fatal</span>(<span class="string">"[RNDFAIL] channel packet randomization failure!"</span>);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.pkt_id</span>++;</span><br><span class="line">      <span class="built_in">$display</span>(req<span class="variable">.sprint</span>());</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.req_mb</span><span class="variable">.put</span>(req);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.rsp_mb</span><span class="variable">.get</span>(rsp);</span><br><span class="line">      <span class="built_in">$display</span>(rsp<span class="variable">.sprint</span>());</span><br><span class="line">      <span class="keyword">assert</span>(rsp<span class="variable">.rsp</span>)</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">$error</span>(<span class="string">"[RSPERR] %0t error response received!"</span>, <span class="built_in">$time</span>);</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">string</span> sprint();</span><br><span class="line">      <span class="keyword">string</span> s;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"chnl_generator object content is as below: \n"</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"ntrans = %0d: \n"</span>, <span class="keyword">this</span><span class="variable">.ntrans</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"ch_id = %0d: \n"</span>, <span class="keyword">this</span><span class="variable">.ch_id</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"pkt_id = %0d: \n"</span>, <span class="keyword">this</span><span class="variable">.pkt_id</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"data_nidles = %0d: \n"</span>, <span class="keyword">this</span><span class="variable">.data_nidles</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"pkt_nidles = %0d: \n"</span>, <span class="keyword">this</span><span class="variable">.pkt_nidles</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"data_size = %0d: \n"</span>, <span class="keyword">this</span><span class="variable">.data_size</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>)&#125;;</span><br><span class="line">      <span class="keyword">return</span> s;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> post_randomize();</span><br><span class="line">      <span class="keyword">string</span> s;</span><br><span class="line">      s = &#123;<span class="string">"AFTER RANDOMIZATION \n"</span>, <span class="keyword">this</span><span class="variable">.sprint</span>()&#125;;</span><br><span class="line">      <span class="built_in">$display</span>(s);</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"><span class="keyword">endclass</span>: chnl_generator</span><br></pre></td></tr></table></figure>
<h4 id="monitor"><a href="#monitor" class="headerlink" title="monitor"></a>monitor</h4><p>定义monitor传输的数据类型，此时没有trans那么复杂了，因为只需要验证数据的一致性</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="keyword">packed</span> &#123;</span><br><span class="line">    <span class="keyword">bit</span>[<span class="number">31</span>:<span class="number">0</span>] data;</span><br><span class="line">    <span class="keyword">bit</span>[<span class="number">1</span>:<span class="number">0</span>] id;</span><br><span class="line">  &#125; mon_data_t;</span><br></pre></td></tr></table></figure>
<p>monitor组件</p>
<p>同样需要传入接口，因为要从接口上拿数据</p>
<p>核心方法：mon_trans()</p>
<p>当vaild和ready信号都有效，即真正进行数据传输时，采集interface上的时钟块中的data！！！</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> chnl_monitor;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">string</span> name;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">virtual</span> chnl_intf intf;</span><br><span class="line">    mailbox <span class="variable">#(mon_data_t)</span> mon_mb;</span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name=<span class="string">"chnl_monitor"</span>);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.name</span> = name;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> set_interface(<span class="keyword">virtual</span> chnl_intf intf);</span><br><span class="line">      <span class="keyword">if</span>(intf == <span class="literal">null</span>)</span><br><span class="line">        <span class="built_in">$error</span>(<span class="string">"interface handle is NULL, please check if target interface has been intantiated"</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.intf</span> = intf;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">    <span class="keyword">task</span> run();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.mon_trans</span>();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> mon_trans();</span><br><span class="line">      mon_data_t m;</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        @(<span class="keyword">posedge</span> intf<span class="variable">.clk</span> <span class="keyword">iff</span> (intf<span class="variable">.mon_ck</span><span class="variable">.ch_valid</span>===<span class="number">'b1</span> &amp;&amp; intf<span class="variable">.mon_ck</span><span class="variable">.ch_ready</span>===<span class="number">'b1</span>));</span><br><span class="line">        m<span class="variable">.data</span> = intf<span class="variable">.mon_ck</span><span class="variable">.ch_data</span>;</span><br><span class="line">        mon_mb<span class="variable">.put</span>(m);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">"%0t %s monitored channle data %8x"</span>, <span class="built_in">$time</span>, <span class="keyword">this</span><span class="variable">.name</span>, m<span class="variable">.data</span>);</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h4 id="agent"><a href="#agent" class="headerlink" title="agent"></a>agent</h4><p>整个chnl_pkg的顶层封装！！！实例化driver，monitor</p>
<p>核心方法run（）：调用driver和monitor的run（）方法，两者并行执行</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> chnl_agent;</span><br><span class="line">  <span class="keyword">local</span> <span class="keyword">string</span> name;</span><br><span class="line">  chnl_driver driver;</span><br><span class="line">  chnl_monitor monitor;</span><br><span class="line">  <span class="keyword">local</span> <span class="keyword">virtual</span> chnl_intf vif;</span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"chnl_agent"</span>);</span><br><span class="line">    <span class="keyword">this</span><span class="variable">.name</span> = name;</span><br><span class="line">    <span class="keyword">this</span><span class="variable">.driver</span> = <span class="keyword">new</span>(&#123;name, <span class="string">".driver"</span>&#125;);</span><br><span class="line">    <span class="keyword">this</span><span class="variable">.monitor</span> = <span class="keyword">new</span>(&#123;name, <span class="string">".monitor"</span>&#125;);</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> set_interface(<span class="keyword">virtual</span> chnl_intf vif);</span><br><span class="line">    <span class="keyword">this</span><span class="variable">.vif</span> = vif;</span><br><span class="line">    driver<span class="variable">.set_interface</span>(vif);</span><br><span class="line">    monitor<span class="variable">.set_interface</span>(vif);</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">task</span> run();</span><br><span class="line">    <span class="keyword">fork</span></span><br><span class="line">      driver<span class="variable">.run</span>();</span><br><span class="line">      monitor<span class="variable">.run</span>();</span><br><span class="line">    <span class="keyword">join</span></span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"><span class="keyword">endclass</span>: chnl_agent</span><br></pre></td></tr></table></figure>
<h3 id="2-package-rpt-pkg（report工具包）"><a href="#2-package-rpt-pkg（report工具包）" class="headerlink" title="2. package rpt_pkg（report工具包）"></a>2. package rpt_pkg（report工具包）</h3><p>梳理下功能，然后再看下在test中是如何被调用的</p>
<ul>
<li><p>枚举类型：</p>
<ul>
<li>信息类型</li>
<li>通过权重对输出的信息进行过滤</li>
<li>通过action选择选择执行步骤</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;INFO, WARNING, ERROR, FATAL&#125; report_t;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;LOW, MEDIUM, HIGH, TOP&#125; severity_t;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;LOG, STOP, EXIT&#125; action_t;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置初始值:</p>
<ul>
<li>权重为low时，表示最低一级的消息都被记录；后期验证次数多了之后，功能逐渐完善，就可以将过滤等级调高</li>
<li>文件名，将日志导出</li>
<li>对各条信息的输出次数进行计数</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> severity_t svrt = LOW;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">string</span> logname = <span class="string">"report.log"</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> info_count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> warning_count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> error_count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> fatal_count = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>最关键的一点：</strong>信息收集方法<code>rpt_msg（）</code> ，在<code>do_report（）</code>方法中被调用，看下调用时传入参数的含义</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="keyword">void</span> rpt_msg(<span class="keyword">string</span> src, <span class="keyword">string</span> i, report_t r=INFO, severity_t s=LOW, action_t a=LOG);</span><br><span class="line">  <span class="keyword">integer</span> logf;</span><br><span class="line">  <span class="keyword">string</span> msg;</span><br><span class="line">  <span class="keyword">case</span>(r)</span><br><span class="line">    INFO: info_count++;</span><br><span class="line">    WARNING: warning_count++;</span><br><span class="line">    ERROR: error_count++;</span><br><span class="line">    FATAL: fatal_count++;</span><br><span class="line">  <span class="keyword">endcase</span></span><br><span class="line">  <span class="keyword">if</span>(s &gt;= svrt) <span class="keyword">begin</span></span><br><span class="line">    msg = <span class="built_in">$sformatf</span>(<span class="string">"@%0t [%s] %s : %s"</span>, <span class="built_in">$time</span>, r, src, i);</span><br><span class="line">    logf = <span class="built_in">$fopen</span>(logname, <span class="string">"a+"</span>);</span><br><span class="line">    <span class="built_in">$display</span>(msg);</span><br><span class="line">    <span class="built_in">$fwrite</span>(logf, <span class="built_in">$sformatf</span>(<span class="string">"%s\n"</span>, msg));</span><br><span class="line">    <span class="built_in">$fclose</span>(logf);</span><br><span class="line">    <span class="keyword">if</span>(a == STOP) <span class="keyword">begin</span></span><br><span class="line">      <span class="built_in">$stop</span>();</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(a == EXIT) <span class="keyword">begin</span></span><br><span class="line">      <span class="built_in">$finish</span>();</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endfunction</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">function</span> <span class="keyword">void</span> do_report();</span><br><span class="line">  <span class="keyword">string</span> s;</span><br><span class="line">  s = <span class="string">"\n---------------------------------------------------------------\n"</span>;</span><br><span class="line">  s = &#123;s, <span class="string">"REPORT SUMMARY\n"</span>&#125;; </span><br><span class="line">  s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"info count: %0d \n"</span>, info_count)&#125;; </span><br><span class="line">  s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"warning count: %0d \n"</span>, warning_count)&#125;; </span><br><span class="line">  s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"error count: %0d \n"</span>, error_count)&#125;; </span><br><span class="line">  s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"fatal count: %0d \n"</span>, fatal_count)&#125;; </span><br><span class="line">  s = &#123;s, <span class="string">"---------------------------------------------------------------\n"</span>&#125;;</span><br><span class="line">  rpt_msg(<span class="string">"[REPORT]"</span>, s, rpt_pkg::INFO, rpt_pkg::TOP);</span><br><span class="line"><span class="keyword">endfunction</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>src：提前声明的默认值，实际使用时传入执行者（调用他的类，如checker或agent等）</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpt_pkg::rpt_msg(<span class="built_in">$sformatf</span>(<span class="string">"[%s]"</span>,<span class="keyword">this</span><span class="variable">.name</span>), s, rpt_pkg::INFO, rpt_pkg::TOP);</span><br></pre></td></tr></table></figure>
<p>当然，也可以传入一下象征意义的字符串，如”[CMPFAIL]”，”[CMPSUCD]”等</p>
</li>
<li><p>i：见do_report的s，对各类型的信息进行计数；</p>
<p>也可以传入自己定义的字符串，如checker中的report；</p>
</li>
<li><p>report_t r：通过case语句，给相应的信息类型计数++</p>
</li>
<li><p>severity_t s：筛选等级，和定义好的svrt进行比较，比它大才能执行后面的打印信息，导出日志等操作</p>
</li>
<li><p>action_t：直接默认就好，此时只执行导出日志</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="keyword">void</span> do_report();</span><br><span class="line">  <span class="keyword">string</span> s;</span><br><span class="line">  s = <span class="string">"\n---------------------------------------------------------------\n"</span>;</span><br><span class="line">  s = &#123;s, <span class="string">"CHECKER SUMMARY \n"</span>&#125;; </span><br><span class="line">  s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"total comparison count: %0d \n"</span>, <span class="keyword">this</span><span class="variable">.total_count</span>)&#125;; </span><br><span class="line">  <span class="keyword">foreach</span>(<span class="keyword">this</span><span class="variable">.chnl_count</span>[i]) s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">" channel[%0d] comparison count: %0d \n"</span>, i, <span class="keyword">this</span><span class="variable">.chnl_count</span>[i])&#125;;</span><br><span class="line">  s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"total error count: %0d \n"</span>, <span class="keyword">this</span><span class="variable">.err_count</span>)&#125;; </span><br><span class="line">  <span class="keyword">foreach</span>(<span class="keyword">this</span><span class="variable">.chnl_mbs</span>[i]) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span><span class="variable">.chnl_mbs</span>[i]<span class="variable">.num</span>() != <span class="number">0</span>)</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"WARNING:: chnl_mbs[%0d] is not empty! size = %0d \n"</span>, i, <span class="keyword">this</span><span class="variable">.chnl_mbs</span>[i]<span class="variable">.num</span>())&#125;; </span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">this</span><span class="variable">.fmt_mb</span><span class="variable">.num</span>() != <span class="number">0</span>)</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"WARNING:: fmt_mb is not empty! size = %0d \n"</span>, <span class="keyword">this</span><span class="variable">.fmt_mb</span><span class="variable">.num</span>())&#125;; </span><br><span class="line">  s = &#123;s, <span class="string">"---------------------------------------------------------------\n"</span>&#125;;</span><br><span class="line">  rpt_pkg::rpt_msg(<span class="built_in">$sformatf</span>(<span class="string">"[%s]"</span>,<span class="keyword">this</span><span class="variable">.name</span>), s, rpt_pkg::INFO, rpt_pkg::TOP);</span><br><span class="line"><span class="keyword">endfunction</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="3-package-reg-pkg-导包：-include-“param-def-v”"><a href="#3-package-reg-pkg-导包：-include-“param-def-v”" class="headerlink" title="3. package reg_pkg(导包：`include “param_def.v”)"></a>3. package reg_pkg(导包：`include “param_def.v”)</h3><p>组件结构和chnl_pkg很像</p>
<p><img src="https://gitee.com/biongd/img/raw/master/img/20210719203725.png" alt="image-20210719203717852" style="zoom:50%;" /></p>
<h4 id="问："><a href="#问：" class="headerlink" title="问："></a>问：</h4><p><strong>1.为什么do_writer方法中，传入的trans中cmd == `READ，也就是执行READ时，要等待两个下降沿再获取数据？？？</strong></p>
<p>答：上升沿来，将命令cmd和地址addr放到interface上；下一个上升沿来，寄存器reg获取到cmd和addr，将内部数据放到interface上；之后的下降沿来，就可以把interface上的data拿走了</p>
<h4 id="interface-1"><a href="#interface-1" class="headerlink" title="interface"></a>interface</h4><p>cmd：读、写或等待命令</p>
<p>cmd_addr：寄存器地址</p>
<p>cmd_data_s2m：写入读写寄存器的配置信息</p>
<p>cmd_data_m2s：从读寄存器中读出salve_fifo余量</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> reg_intf(<span class="keyword">input</span> clk, <span class="keyword">input</span> rstn);</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">1</span>:<span class="number">0</span>]                 cmd;</span><br><span class="line">  <span class="keyword">logic</span> [<span class="meta">`ADDR_WIDTH-1:0]     cmd_addr;</span></span><br><span class="line">  <span class="keyword">logic</span> [<span class="meta">`CMD_DATA_WIDTH-1:0] cmd_data_s2m;</span></span><br><span class="line">  <span class="keyword">logic</span> [<span class="meta">`CMD_DATA_WIDTH-1:0] cmd_data_m2s;</span></span><br><span class="line">  <span class="keyword">clocking</span> drv_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">output</span> cmd, cmd_addr, cmd_data_m2s;</span><br><span class="line">    <span class="keyword">input</span> cmd_data_s2m;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line">  <span class="keyword">clocking</span> mon_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">input</span> cmd, cmd_addr, cmd_data_m2s, cmd_data_s2m;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line"><span class="keyword">endinterface</span></span><br></pre></td></tr></table></figure>
<h4 id="transcation-1"><a href="#transcation-1" class="headerlink" title="transcation"></a>transcation</h4><p>不需要id，idle和重复产生激励，所以只生成需要的信号</p>
<p>注意随机化中：对约束增加了关系限制，不允许不合理的激励传入，否则报错</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> reg_trans;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">bit</span>[<span class="number">7</span>:<span class="number">0</span>] addr;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">bit</span>[<span class="number">1</span>:<span class="number">0</span>] cmd;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">bit</span>[<span class="number">31</span>:<span class="number">0</span>] data;</span><br><span class="line">    <span class="keyword">bit</span> rsp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constraint</span> cstr &#123;</span><br><span class="line">      <span class="keyword">soft</span> cmd <span class="keyword">inside</span> &#123;<span class="meta">`WRITE, `READ, `IDLE&#125;;</span></span><br><span class="line">      <span class="keyword">soft</span> addr <span class="keyword">inside</span> &#123;<span class="meta">`SLV0_RW_ADDR, `SLV1_RW_ADDR, `SLV2_RW_ADDR, `SLV0_R_ADDR, `SLV1_R_ADDR, `SLV2_R_ADDR&#125;;</span></span><br><span class="line">      addr[<span class="number">7</span>:<span class="number">4</span>]==<span class="number">0</span> &amp;&amp; cmd==<span class="meta">`WRITE -&gt; soft data[31:6]==0;</span></span><br><span class="line">      <span class="keyword">soft</span> addr[<span class="number">7</span>:<span class="number">5</span>]==<span class="number">0</span>;</span><br><span class="line">      addr[<span class="number">4</span>]==<span class="number">1</span> -&gt; <span class="keyword">soft</span> cmd == <span class="meta">`READ;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> reg_trans clone();</span><br><span class="line">      reg_trans c = <span class="keyword">new</span>();</span><br><span class="line">      c<span class="variable">.addr</span> = <span class="keyword">this</span><span class="variable">.addr</span>;</span><br><span class="line">      c<span class="variable">.cmd</span> = <span class="keyword">this</span><span class="variable">.cmd</span>;</span><br><span class="line">      c<span class="variable">.data</span> = <span class="keyword">this</span><span class="variable">.data</span>;</span><br><span class="line">      c<span class="variable">.rsp</span> = <span class="keyword">this</span><span class="variable">.rsp</span>;</span><br><span class="line">      <span class="keyword">return</span> c;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">string</span> sprint();</span><br><span class="line">      <span class="keyword">string</span> s;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"reg_trans object content is as below: \n"</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"addr = %2x: \n"</span>, <span class="keyword">this</span><span class="variable">.addr</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"cmd = %2b: \n"</span>, <span class="keyword">this</span><span class="variable">.cmd</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"data = %8x: \n"</span>, <span class="keyword">this</span><span class="variable">.data</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"rsp = %0d: \n"</span>, <span class="keyword">this</span><span class="variable">.rsp</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>)&#125;;</span><br><span class="line">      <span class="keyword">return</span> s;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h4 id="driver-1"><a href="#driver-1" class="headerlink" title="driver"></a>driver</h4><p>核心方法：do_drive（）——reg_write()+mailbox传激励</p>
<ul>
<li>写方法，将地址，命令，数据放在接口上</li>
<li>读方法，将地址，命令，放在接口上，下个时钟的下降沿从接口上拿数据（<code>t.data &lt;= intf.cmd_data_s2m;</code>）</li>
</ul>
<p>不需要等待ready</p>
<p>generator是在时钟下降沿判断ready信号；</p>
<p>reg是在第二个时钟下降沿采集寄存器中的数据；读命令的时候要把读到的寄存器状态放入rsp</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> reg_driver;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">string</span> name;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">virtual</span> reg_intf intf;</span><br><span class="line">    mailbox <span class="variable">#(reg_trans)</span> req_mb;</span><br><span class="line">    mailbox <span class="variable">#(reg_trans)</span> rsp_mb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"reg_driver"</span>);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.name</span> = name;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> set_interface(<span class="keyword">virtual</span> reg_intf intf);</span><br><span class="line">      <span class="keyword">if</span>(intf == <span class="literal">null</span>)</span><br><span class="line">        <span class="built_in">$error</span>(<span class="string">"interface handle is NULL, please check if target interface has been intantiated"</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.intf</span> = intf;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> run();</span><br><span class="line">      <span class="keyword">fork</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.do_drive</span>();</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.do_reset</span>();</span><br><span class="line">      <span class="keyword">join</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_reset();</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        @(<span class="keyword">negedge</span> intf<span class="variable">.rstn</span>);</span><br><span class="line">        intf<span class="variable">.cmd_addr</span> &lt;= <span class="number">0</span>;</span><br><span class="line">        intf<span class="variable">.cmd</span> &lt;= <span class="meta">`IDLE;</span></span><br><span class="line">        intf<span class="variable">.cmd_data_m2s</span> &lt;= <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_drive();</span><br><span class="line">      reg_trans req, rsp;</span><br><span class="line">      @(<span class="keyword">posedge</span> intf<span class="variable">.rstn</span>);</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.req_mb</span><span class="variable">.get</span>(req);</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.reg_write</span>(req);</span><br><span class="line">        rsp = req<span class="variable">.clone</span>();</span><br><span class="line">        rsp<span class="variable">.rsp</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.rsp_mb</span><span class="variable">.put</span>(rsp);</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">task</span> reg_write(reg_trans t);</span><br><span class="line">      @(<span class="keyword">posedge</span> intf<span class="variable">.clk</span> <span class="keyword">iff</span> intf<span class="variable">.rstn</span>);</span><br><span class="line">      <span class="keyword">case</span>(t<span class="variable">.cmd</span>)</span><br><span class="line">        <span class="meta">`WRITE: begin </span></span><br><span class="line">                  intf<span class="variable">.drv_ck</span><span class="variable">.cmd_addr</span> &lt;= t<span class="variable">.addr</span>; </span><br><span class="line">                  intf<span class="variable">.drv_ck</span><span class="variable">.cmd</span> &lt;= t<span class="variable">.cmd</span>; </span><br><span class="line">                  intf<span class="variable">.drv_ck</span><span class="variable">.cmd_data_m2s</span> &lt;= t<span class="variable">.data</span>; </span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">        <span class="meta">`READ:  begin </span></span><br><span class="line">                  intf<span class="variable">.drv_ck</span><span class="variable">.cmd_addr</span> &lt;= t<span class="variable">.addr</span>; </span><br><span class="line">                  intf<span class="variable">.drv_ck</span><span class="variable">.cmd</span> &lt;= t<span class="variable">.cmd</span>; </span><br><span class="line">                  <span class="keyword">repeat</span>(<span class="number">2</span>) @(<span class="keyword">negedge</span> intf<span class="variable">.clk</span>);</span><br><span class="line">                  t<span class="variable">.data</span> = intf<span class="variable">.cmd_data_s2m</span>; </span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">        <span class="meta">`IDLE:  begin </span></span><br><span class="line">                  <span class="keyword">this</span><span class="variable">.reg_idle</span>(); </span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">default</span>: <span class="built_in">$error</span>(<span class="string">"command %b is illegal"</span>, t<span class="variable">.cmd</span>);</span><br><span class="line">      <span class="keyword">endcase</span></span><br><span class="line">      <span class="built_in">$display</span>(<span class="string">"%0t reg driver [%s] sent addr %2x, cmd %2b, data %8x"</span>, <span class="built_in">$time</span>, name, t<span class="variable">.addr</span>, t<span class="variable">.cmd</span>, t<span class="variable">.data</span>);</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">task</span> reg_idle();</span><br><span class="line">      @(<span class="keyword">posedge</span> intf<span class="variable">.clk</span>);</span><br><span class="line">      intf<span class="variable">.drv_ck</span><span class="variable">.cmd_addr</span> &lt;= <span class="number">0</span>;</span><br><span class="line">      intf<span class="variable">.drv_ck</span><span class="variable">.cmd</span> &lt;= <span class="meta">`IDLE;</span></span><br><span class="line">      intf<span class="variable">.drv_ck</span><span class="variable">.cmd_data_m2s</span> &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h4 id="generator-1"><a href="#generator-1" class="headerlink" title="generator"></a>generator</h4><p>核心方法：send_trans()，通chnl的send_trans</p>
<p>区别：cmd是read的时候，driver会把rsp中的数据改为读到的数据再发给generator，generator的组件实例可以将其获取到</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> reg_generator;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">bit</span>[<span class="number">7</span>:<span class="number">0</span>] addr = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">bit</span>[<span class="number">1</span>:<span class="number">0</span>] cmd = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">bit</span>[<span class="number">31</span>:<span class="number">0</span>] data = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    mailbox <span class="variable">#(reg_trans)</span> req_mb;</span><br><span class="line">    mailbox <span class="variable">#(reg_trans)</span> rsp_mb;</span><br><span class="line"></span><br><span class="line">    reg_trans reg_req[$];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constraint</span> cstr&#123;</span><br><span class="line">      <span class="keyword">soft</span> addr == -<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">soft</span> cmd == -<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">soft</span> data == -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.req_mb</span> = <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.rsp_mb</span> = <span class="keyword">new</span>();</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> start();</span><br><span class="line">      send_trans();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// generate transaction and put into local mailbox</span></span><br><span class="line">    <span class="keyword">task</span> send_trans();</span><br><span class="line">      reg_trans req, rsp;</span><br><span class="line">      req = <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">assert</span>(req<span class="variable">.randomize</span> <span class="keyword">with</span> &#123;<span class="keyword">local</span>::addr &gt;= <span class="number">0</span> -&gt; addr == <span class="keyword">local</span>::addr;</span><br><span class="line">                                 <span class="keyword">local</span>::cmd &gt;= <span class="number">0</span> -&gt; cmd == <span class="keyword">local</span>::cmd;</span><br><span class="line">                                 <span class="keyword">local</span>::data &gt;= <span class="number">0</span> -&gt; data == <span class="keyword">local</span>::data;</span><br><span class="line">                               &#125;)</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">$fatal</span>(<span class="string">"[RNDFAIL] register packet randomization failure!"</span>);</span><br><span class="line">      <span class="built_in">$display</span>(req<span class="variable">.sprint</span>());</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.req_mb</span><span class="variable">.put</span>(req);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.rsp_mb</span><span class="variable">.get</span>(rsp);</span><br><span class="line">      <span class="built_in">$display</span>(rsp<span class="variable">.sprint</span>());</span><br><span class="line">      <span class="keyword">if</span>(req<span class="variable">.cmd</span> == <span class="meta">`READ) </span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.data</span> = rsp<span class="variable">.data</span>;</span><br><span class="line">      <span class="keyword">assert</span>(rsp<span class="variable">.rsp</span>)</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">$error</span>(<span class="string">"[RSPERR] %0t error response received!"</span>, <span class="built_in">$time</span>);</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">string</span> sprint();</span><br><span class="line">      <span class="keyword">string</span> s;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"reg_generator object content is as below: \n"</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"addr = %2x: \n"</span>, <span class="keyword">this</span><span class="variable">.addr</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"cmd = %2b: \n"</span>, <span class="keyword">this</span><span class="variable">.cmd</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"data = %8x: \n"</span>, <span class="keyword">this</span><span class="variable">.data</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>)&#125;;</span><br><span class="line">      <span class="keyword">return</span> s;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> post_randomize();</span><br><span class="line">      <span class="keyword">string</span> s;</span><br><span class="line">      s = &#123;<span class="string">"AFTER RANDOMIZATION \n"</span>, <span class="keyword">this</span><span class="variable">.sprint</span>()&#125;;</span><br><span class="line">      <span class="built_in">$display</span>(s);</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h4 id="monitor-1"><a href="#monitor-1" class="headerlink" title="monitor"></a>monitor</h4><p>核心方法：mon_trans()：将接口上的cmd，addr，data都放入（reg_trans）m，然后将m放入mailbox</p>
<p>区别于chnl，没有定义monitor的数据类型，直接使用reg_trans</p>
<p>chnl：时钟上升沿<code>+valid===1+ready===1</code></p>
<p>reg：时钟上升沿+复位（==1）+<code>intf.mon.clk != IDLE</code></p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> reg_monitor;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">string</span> name;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">virtual</span> reg_intf intf;</span><br><span class="line">    mailbox <span class="variable">#(reg_trans)</span> mon_mb;</span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name=<span class="string">"reg_monitor"</span>);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.name</span> = name;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> set_interface(<span class="keyword">virtual</span> reg_intf intf);</span><br><span class="line">      <span class="keyword">if</span>(intf == <span class="literal">null</span>)</span><br><span class="line">        <span class="built_in">$error</span>(<span class="string">"interface handle is NULL, please check if target interface has been intantiated"</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.intf</span> = intf;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">    <span class="keyword">task</span> run();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.mon_trans</span>();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> mon_trans();</span><br><span class="line">      reg_trans m;</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        @(<span class="keyword">posedge</span> intf<span class="variable">.clk</span> <span class="keyword">iff</span> (intf<span class="variable">.rstn</span> &amp;&amp; intf<span class="variable">.mon_ck</span><span class="variable">.cmd</span> != <span class="meta">`IDLE));</span></span><br><span class="line">        m = <span class="keyword">new</span>();</span><br><span class="line">        m<span class="variable">.addr</span> = intf<span class="variable">.mon_ck</span><span class="variable">.cmd_addr</span>;</span><br><span class="line">        m<span class="variable">.cmd</span> = intf<span class="variable">.mon_ck</span><span class="variable">.cmd</span>;</span><br><span class="line">        <span class="keyword">if</span>(intf<span class="variable">.mon_ck</span><span class="variable">.cmd</span> == <span class="meta">`WRITE) begin</span></span><br><span class="line">          m<span class="variable">.data</span> = intf<span class="variable">.mon_ck</span><span class="variable">.cmd_data_m2s</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(intf<span class="variable">.mon_ck</span><span class="variable">.cmd</span> == <span class="meta">`READ) begin</span></span><br><span class="line">          @(<span class="keyword">posedge</span> intf<span class="variable">.clk</span>);</span><br><span class="line">          m<span class="variable">.data</span> = intf<span class="variable">.mon_ck</span><span class="variable">.cmd_data_s2m</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        mon_mb<span class="variable">.put</span>(m);</span><br><span class="line">        <span class="built_in">$display</span>(<span class="string">"%0t %s monitored addr %2x, cmd %2b, data %8x"</span>, <span class="built_in">$time</span>, <span class="keyword">this</span><span class="variable">.name</span>, m<span class="variable">.addr</span>, m<span class="variable">.cmd</span>, m<span class="variable">.data</span>);</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h4 id="agent-1"><a href="#agent-1" class="headerlink" title="agent"></a>agent</h4><p>省略</p>
<h3 id="4-package-fmt-pkg"><a href="#4-package-fmt-pkg" class="headerlink" title="4. package fmt_pkg"></a>4. package fmt_pkg</h3><p><img src="https://gitee.com/biongd/img/raw/master/img/20210719111922.png" alt=""></p>
<h4 id="interface-2"><a href="#interface-2" class="headerlink" title="interface"></a>interface</h4><p>忽然变复杂，信号有些多，理清输入输出！！</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> fmt_intf(<span class="keyword">input</span> clk, <span class="keyword">input</span> rstn);</span><br><span class="line">  <span class="keyword">logic</span>        fmt_grant;</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">1</span>:<span class="number">0</span>]  fmt_chid;</span><br><span class="line">  <span class="keyword">logic</span>        fmt_req;</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">5</span>:<span class="number">0</span>]  fmt_length;</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] fmt_data;</span><br><span class="line">  <span class="keyword">logic</span>        fmt_start;</span><br><span class="line">  <span class="keyword">logic</span>        fmt_end;</span><br><span class="line">  <span class="keyword">clocking</span> drv_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">input</span> fmt_chid, fmt_req, fmt_length, fmt_data, fmt_start;</span><br><span class="line">    <span class="keyword">output</span> fmt_grant;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line">  <span class="keyword">clocking</span> mon_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">input</span> fmt_grant, fmt_chid, fmt_req, fmt_length, fmt_data, fmt_start;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line"><span class="keyword">endinterface</span></span><br></pre></td></tr></table></figure>
<h4 id="enum"><a href="#enum" class="headerlink" title="enum"></a>enum</h4><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;SHORT_FIFO, MED_FIFO, LONG_FIFO, ULTRA_FIFO&#125; fmt_fifo_t;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;LOW_WIDTH, MED_WIDTH, HIGH_WIDTH, ULTRA_WIDTH&#125; fmt_bandwidth_t;</span><br></pre></td></tr></table></figure>
<p>本质上对fmt的驱动，就是模拟一个fifo，这里对模拟的fifo进行自定义的范围</p>
<h4 id="transcation-2"><a href="#transcation-2" class="headerlink" title="transcation"></a>transcation</h4><p>只关心length，data，通道id，接口中的响应信号在driver中见</p>
<p>不需要对这3这进行随机化，本身就是接收数据的容器，不用产生激励，只需要对容器多变变形状</p>
<p>多了一个比较方法，因为最后checker中还是对数据包的对比，采用fmt_trans的类型，所以直接在这里定义比较方法</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> fmt_trans;</span><br><span class="line">    <span class="keyword">rand</span> fmt_fifo_t fifo;</span><br><span class="line">    <span class="keyword">rand</span> fmt_bandwidth_t bandwidth;</span><br><span class="line">    <span class="keyword">bit</span> [<span class="number">9</span>:<span class="number">0</span>] length;</span><br><span class="line">    <span class="keyword">bit</span> [<span class="number">31</span>:<span class="number">0</span>] data[];</span><br><span class="line">    <span class="keyword">bit</span> [<span class="number">1</span>:<span class="number">0</span>] ch_id;</span><br><span class="line">    <span class="keyword">bit</span> rsp;</span><br><span class="line">    <span class="keyword">constraint</span> cstr&#123;</span><br><span class="line">      <span class="keyword">soft</span> fifo == MED_FIFO;</span><br><span class="line">      <span class="keyword">soft</span> bandwidth == MED_WIDTH;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">function</span> fmt_trans clone();</span><br><span class="line">      fmt_trans c = <span class="keyword">new</span>();</span><br><span class="line">      c<span class="variable">.fifo</span> = <span class="keyword">this</span><span class="variable">.fifo</span>;</span><br><span class="line">      c<span class="variable">.bandwidth</span> = <span class="keyword">this</span><span class="variable">.bandwidth</span>;</span><br><span class="line">      c<span class="variable">.length</span> = <span class="keyword">this</span><span class="variable">.length</span>;</span><br><span class="line">      c<span class="variable">.data</span> = <span class="keyword">this</span><span class="variable">.data</span>;</span><br><span class="line">      c<span class="variable">.ch_id</span> = <span class="keyword">this</span><span class="variable">.ch_id</span>;</span><br><span class="line">      c<span class="variable">.rsp</span> = <span class="keyword">this</span><span class="variable">.rsp</span>;</span><br><span class="line">      <span class="keyword">return</span> c;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">string</span> sprint();</span><br><span class="line">      <span class="keyword">string</span> s;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"fmt_trans object content is as below: \n"</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"fifo = %s: \n"</span>, <span class="keyword">this</span><span class="variable">.fifo</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"bandwidth = %s: \n"</span>, <span class="keyword">this</span><span class="variable">.bandwidth</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"length = %s: \n"</span>, <span class="keyword">this</span><span class="variable">.length</span>)&#125;;</span><br><span class="line">      <span class="keyword">foreach</span>(data[i]) s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"data[%0d] = %8x \n"</span>, i, <span class="keyword">this</span><span class="variable">.data</span>[i])&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"ch_id = %0d: \n"</span>, <span class="keyword">this</span><span class="variable">.ch_id</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"rsp = %0d: \n"</span>, <span class="keyword">this</span><span class="variable">.rsp</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>)&#125;;</span><br><span class="line">      <span class="keyword">return</span> s;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">bit</span> compare(fmt_trans t);</span><br><span class="line">      <span class="keyword">string</span> s;</span><br><span class="line">      compare = <span class="number">1</span>;</span><br><span class="line">      s = <span class="string">"\n=======================================\n"</span>;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"COMPARING fmt_trans object at time %0d \n"</span>, <span class="built_in">$time</span>)&#125;;</span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">this</span><span class="variable">.length</span> != t<span class="variable">.length</span>) <span class="keyword">begin</span></span><br><span class="line">        compare = <span class="number">0</span>;</span><br><span class="line">        s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"sobj length %0d != tobj length %0d \n"</span>, <span class="keyword">this</span><span class="variable">.length</span>, t<span class="variable">.length</span>)&#125;;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">this</span><span class="variable">.ch_id</span> != t<span class="variable">.ch_id</span>) <span class="keyword">begin</span></span><br><span class="line">        compare = <span class="number">0</span>;</span><br><span class="line">        s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"sobj ch_id %0d != tobj ch_id %0d\n"</span>, <span class="keyword">this</span><span class="variable">.ch_id</span>, t<span class="variable">.ch_id</span>)&#125;;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">foreach</span>(<span class="keyword">this</span><span class="variable">.data</span>[i]) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span><span class="variable">.data</span>[i] != t<span class="variable">.data</span>[i]) <span class="keyword">begin</span></span><br><span class="line">          compare = <span class="number">0</span>;</span><br><span class="line">          s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"sobj data[%0d] %8x != tobj data[%0d] %8x\n"</span>, i, <span class="keyword">this</span><span class="variable">.data</span>[i], i, t<span class="variable">.data</span>[i])&#125;;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">if</span>(compare == <span class="number">1</span>) s = &#123;s, <span class="string">"COMPARED SUCCESS!\n"</span>&#125;;</span><br><span class="line">      <span class="keyword">else</span>  s = &#123;s, <span class="string">"COMPARED FAILURE!\n"</span>&#125;;</span><br><span class="line">      s = &#123;s, <span class="string">"=======================================\n"</span>&#125;;</span><br><span class="line">      rpt_pkg::rpt_msg(<span class="string">"[CMPOBJ]"</span>, s, rpt_pkg::INFO, rpt_pkg::MEDIUM);</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h4 id="driver-2"><a href="#driver-2" class="headerlink" title="driver"></a>driver</h4><p>用mailbox充当接收数据的fifo，定义fifo的宽度（32位），定义fifo的深度（fifo_bound），定义fifo的数据消耗速度（data_consum_peroid，1代表一个时钟周期就消耗掉一个data）</p>
<p>fifo_bound：对应trans的fmt_fifo_t fifo；</p>
<p>data_consum_peroid：对应trans的fmt_bandwidth_t bandwidth;</p>
<p>核心方法：do_run()</p>
<ul>
<li><p>this.do_receive()：forever监控线程，条件满足时将数据放入fifo</p>
<ul>
<li><p><code>@(posedge intf.fmt_req)</code>：fmt提出发送数据</p>
<p>forever判断：fifo深度的余量是否大于length，小于则一直循环，大于往下执行(给fmt一个grant==1)</p>
</li>
<li><p>一旦检测到start上升沿，开始数据传输（length个下降沿，将接口上的数据放到fifo中），同时将grant拉低（fork-join_none）</p>
</li>
</ul>
</li>
<li><p>this.do_config()：同样是forever监控线程，对自建的fifo进行揉捏</p>
<ul>
<li>generator可以对宽度和深度进行随机化，再通过mailbox发送到driver</li>
</ul>
</li>
<li><p>this.do_consume()：try_get（）从自建fifo中取数，取数的速度由随机方法定义</p>
<ul>
<li><p>repeat($urandom_range(1, this.data_consum_peroid)) @(posedge intf.clk);</p>
</li>
<li><p>将buffer中的信号导出（减小this.fifo.num()，这样才有空放新数）:do_consume()</p>
</li>
<li>消耗和接收是并行的 ，所以消耗的速度不一定和接收速度一样就得是1个周期完成，消耗的慢接收就不执行呗</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> fmt_driver;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">string</span> name;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">virtual</span> fmt_intf intf;</span><br><span class="line">    mailbox <span class="variable">#(fmt_trans)</span> req_mb;</span><br><span class="line">    mailbox <span class="variable">#(fmt_trans)</span> rsp_mb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> mailbox <span class="variable">#(bit[31:0])</span> fifo;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">int</span> fifo_bound;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">int</span> data_consum_peroid;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"fmt_driver"</span>);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.name</span> = name;</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.fifo</span> = <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.fifo_bound</span> = <span class="number">4096</span>;</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.data_consum_peroid</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> set_interface(<span class="keyword">virtual</span> fmt_intf intf);</span><br><span class="line">      <span class="keyword">if</span>(intf == <span class="literal">null</span>)</span><br><span class="line">        <span class="built_in">$error</span>(<span class="string">"interface handle is NULL, please check if target interface has been intantiated"</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.intf</span> = intf;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> run();</span><br><span class="line">      <span class="keyword">fork</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.do_receive</span>();</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.do_consume</span>();</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.do_config</span>();</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.do_reset</span>();</span><br><span class="line">      <span class="keyword">join</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_config();</span><br><span class="line">      fmt_trans req, rsp;</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.req_mb</span><span class="variable">.get</span>(req);</span><br><span class="line">        <span class="keyword">case</span>(req<span class="variable">.fifo</span>)</span><br><span class="line">          SHORT_FIFO: <span class="keyword">this</span><span class="variable">.fifo_bound</span> = <span class="number">64</span>;</span><br><span class="line">          MED_FIFO: <span class="keyword">this</span><span class="variable">.fifo_bound</span> = <span class="number">256</span>;</span><br><span class="line">          LONG_FIFO: <span class="keyword">this</span><span class="variable">.fifo_bound</span> = <span class="number">512</span>;</span><br><span class="line">          ULTRA_FIFO: <span class="keyword">this</span><span class="variable">.fifo_bound</span> = <span class="number">2048</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.fifo</span> = <span class="keyword">new</span>(<span class="keyword">this</span><span class="variable">.fifo_bound</span>);</span><br><span class="line">        <span class="keyword">case</span>(req<span class="variable">.bandwidth</span>)</span><br><span class="line">          LOW_WIDTH: <span class="keyword">this</span><span class="variable">.data_consum_peroid</span> = <span class="number">8</span>;</span><br><span class="line">          MED_WIDTH: <span class="keyword">this</span><span class="variable">.data_consum_peroid</span> = <span class="number">4</span>;</span><br><span class="line">          HIGH_WIDTH: <span class="keyword">this</span><span class="variable">.data_consum_peroid</span> = <span class="number">2</span>;</span><br><span class="line">          ULTRA_WIDTH: <span class="keyword">this</span><span class="variable">.data_consum_peroid</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">        rsp = req<span class="variable">.clone</span>();</span><br><span class="line">        rsp<span class="variable">.rsp</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.rsp_mb</span><span class="variable">.put</span>(rsp);</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_reset();</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        @(<span class="keyword">negedge</span> intf<span class="variable">.rstn</span>) </span><br><span class="line">        intf<span class="variable">.fmt_grant</span> &lt;= <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_receive();</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        @(<span class="keyword">posedge</span> intf<span class="variable">.fmt_req</span>);</span><br><span class="line">        <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">          @(<span class="keyword">posedge</span> intf<span class="variable">.clk</span>);</span><br><span class="line">          <span class="keyword">if</span>((<span class="keyword">this</span><span class="variable">.fifo_bound</span>-<span class="keyword">this</span><span class="variable">.fifo</span><span class="variable">.num</span>()) &gt;= intf<span class="variable">.fmt_length</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        intf<span class="variable">.drv_ck</span><span class="variable">.fmt_grant</span> &lt;= <span class="number">1</span>;</span><br><span class="line">        @(<span class="keyword">posedge</span> intf<span class="variable">.fmt_start</span>);</span><br><span class="line">        <span class="keyword">fork</span></span><br><span class="line">          <span class="keyword">begin</span></span><br><span class="line">            @(<span class="keyword">posedge</span> intf<span class="variable">.clk</span>);</span><br><span class="line">            intf<span class="variable">.drv_ck</span><span class="variable">.fmt_grant</span> &lt;= <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">join_none</span></span><br><span class="line">        <span class="keyword">repeat</span>(intf<span class="variable">.fmt_length</span>) <span class="keyword">begin</span></span><br><span class="line">          @(<span class="keyword">negedge</span> intf<span class="variable">.clk</span>);</span><br><span class="line">          <span class="keyword">this</span><span class="variable">.fifo</span><span class="variable">.put</span>(intf<span class="variable">.fmt_data</span>);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_consume();</span><br><span class="line">      <span class="keyword">bit</span>[<span class="number">31</span>:<span class="number">0</span>] data;</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">void</span>'(<span class="keyword">this</span><span class="variable">.fifo</span><span class="variable">.try_get</span>(data));</span><br><span class="line">        <span class="keyword">repeat</span>($urandom_range(<span class="number">1</span>, <span class="keyword">this</span><span class="variable">.data_consum_peroid</span>)) @(<span class="keyword">posedge</span> intf<span class="variable">.clk</span>);</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h4 id="generator-2"><a href="#generator-2" class="headerlink" title="generator"></a>generator</h4><p>这里的激励就不是数据了，就是对buffer的配置</p>
<ul>
<li><p>核心方法：send_trans()</p>
<p>把fifo的配置信息（fifo，bandwidth）发送给driver，driver用do_config接收，对自建fifo进行揉捏</p>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> fmt_generator;</span><br><span class="line">    <span class="keyword">rand</span> fmt_fifo_t fifo = MED_FIFO;</span><br><span class="line">    <span class="keyword">rand</span> fmt_bandwidth_t bandwidth = MED_WIDTH;</span><br><span class="line"></span><br><span class="line">    mailbox <span class="variable">#(fmt_trans)</span> req_mb;</span><br><span class="line">    mailbox <span class="variable">#(fmt_trans)</span> rsp_mb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constraint</span> cstr&#123;</span><br><span class="line">      <span class="keyword">soft</span> fifo == MED_FIFO;</span><br><span class="line">      <span class="keyword">soft</span> bandwidth == MED_WIDTH;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.req_mb</span> = <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.rsp_mb</span> = <span class="keyword">new</span>();</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> start();</span><br><span class="line">      send_trans();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// generate transaction and put into local mailbox</span></span><br><span class="line">    <span class="keyword">task</span> send_trans();</span><br><span class="line">      fmt_trans req, rsp;</span><br><span class="line">      req = <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">assert</span>(req<span class="variable">.randomize</span> <span class="keyword">with</span> &#123;<span class="keyword">local</span>::fifo != MED_FIFO -&gt; fifo == <span class="keyword">local</span>::fifo; </span><br><span class="line">                                 <span class="keyword">local</span>::bandwidth != MED_WIDTH -&gt; bandwidth == <span class="keyword">local</span>::bandwidth;</span><br><span class="line">                               &#125;)</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">$fatal</span>(<span class="string">"[RNDFAIL] formatter packet randomization failure!"</span>);</span><br><span class="line">      <span class="built_in">$display</span>(req<span class="variable">.sprint</span>());</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.req_mb</span><span class="variable">.put</span>(req);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.rsp_mb</span><span class="variable">.get</span>(rsp);</span><br><span class="line">      <span class="built_in">$display</span>(rsp<span class="variable">.sprint</span>());</span><br><span class="line">      <span class="keyword">assert</span>(rsp<span class="variable">.rsp</span>)</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">$error</span>(<span class="string">"[RSPERR] %0t error response received!"</span>, <span class="built_in">$time</span>);</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">string</span> sprint();</span><br><span class="line">      <span class="keyword">string</span> s;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"fmt_generator object content is as below: \n"</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"fifo = %s: \n"</span>, <span class="keyword">this</span><span class="variable">.fifo</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"bandwidth = %s: \n"</span>, <span class="keyword">this</span><span class="variable">.bandwidth</span>)&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>)&#125;;</span><br><span class="line">      <span class="keyword">return</span> s;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> post_randomize();</span><br><span class="line">      <span class="keyword">string</span> s;</span><br><span class="line">      s = &#123;<span class="string">"AFTER RANDOMIZATION \n"</span>, <span class="keyword">this</span><span class="variable">.sprint</span>()&#125;;</span><br><span class="line">      <span class="built_in">$display</span>(s);</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h4 id="monitor-2"><a href="#monitor-2" class="headerlink" title="monitor"></a>monitor</h4><p>核心方法：mon_trans()</p>
<p>采样时机：@(posedge intf.mon_ck.fmt_start); 要把接口上的（ch_id，length，data）都放进fmt_trans，data是length个时钟上升沿，将接口上的data放入m的data数组</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> fmt_monitor;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">string</span> name;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">virtual</span> fmt_intf intf;</span><br><span class="line">    mailbox <span class="variable">#(fmt_trans)</span> mon_mb;</span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name=<span class="string">"fmt_monitor"</span>);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.name</span> = name;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> set_interface(<span class="keyword">virtual</span> fmt_intf intf);</span><br><span class="line">      <span class="keyword">if</span>(intf == <span class="literal">null</span>)</span><br><span class="line">        <span class="built_in">$error</span>(<span class="string">"interface handle is NULL, please check if target interface has been intantiated"</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.intf</span> = intf;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> run();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.mon_trans</span>();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> mon_trans();</span><br><span class="line">      fmt_trans m;</span><br><span class="line">      <span class="keyword">string</span> s;</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        @(<span class="keyword">posedge</span> intf<span class="variable">.mon_ck</span><span class="variable">.fmt_start</span>);</span><br><span class="line">        m = <span class="keyword">new</span>();</span><br><span class="line">        m<span class="variable">.length</span> = intf<span class="variable">.mon_ck</span><span class="variable">.fmt_length</span>;</span><br><span class="line">        m<span class="variable">.ch_id</span> = intf<span class="variable">.mon_ck</span><span class="variable">.fmt_chid</span>;</span><br><span class="line">        m<span class="variable">.data</span> = <span class="keyword">new</span>[m<span class="variable">.length</span>];</span><br><span class="line">        <span class="keyword">foreach</span>(m<span class="variable">.data</span>[i]) <span class="keyword">begin</span></span><br><span class="line">          @(<span class="keyword">posedge</span> intf<span class="variable">.clk</span>);</span><br><span class="line">          m<span class="variable">.data</span>[i] = intf<span class="variable">.mon_ck</span><span class="variable">.fmt_data</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        mon_mb<span class="variable">.put</span>(m);</span><br><span class="line">        s = <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>);</span><br><span class="line">        s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"%0t %s monitored a packet: \n"</span>, <span class="built_in">$time</span>, <span class="keyword">this</span><span class="variable">.name</span>)&#125;;</span><br><span class="line">        s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"length = %0d: \n"</span>, m<span class="variable">.length</span>)&#125;;</span><br><span class="line">        s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"chid = %0d: \n"</span>, m<span class="variable">.ch_id</span>)&#125;;</span><br><span class="line">        <span class="keyword">foreach</span>(m<span class="variable">.data</span>[i]) s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"data[%0d] = %8x \n"</span>, i, m<span class="variable">.data</span>[i])&#125;;</span><br><span class="line">        s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>)&#125;;</span><br><span class="line">        <span class="built_in">$display</span>(s);</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h4 id="agent-2"><a href="#agent-2" class="headerlink" title="agent"></a>agent</h4><p>省略</p>
<h3 id="5-package-mcdf-pkg（顶层包）"><a href="#5-package-mcdf-pkg（顶层包）" class="headerlink" title="5. package mcdf_pkg（顶层包）"></a>5. package mcdf_pkg（顶层包）</h3><p><img src="https://gitee.com/biongd/img/raw/master/img/20210719151120.png" alt="image-20210719151113192"></p>
<p>核心就是checker的实现，和实验3相比，checker多了对寄存器信息的处理</p>
<h4 id="问：-1"><a href="#问：-1" class="headerlink" title="问："></a>问：</h4><ol>
<li><p>如何将寄存器信息用到数据的比对上？</p>
<p>如上图所示，构建mcdf硬件参考模型（模仿硬件功能），参考模型通过reg_mb信箱获取寄存器内容，do_reg_update()实现对寄存器内容的更新，do_packet()实现对数据的打包。</p>
<p>通过寄存器数据中的length，可以将chnl_mb中的数据放到length长度数组中，封装成fmt_trans格式，调用fmt_trans的compare与fmt_mb中的数据报进行对比</p>
</li>
<li><p>如何保证寄存器模型中的数据指令和数据输入刚好对应？寄存器数据由外部写入，真正数据传输的时候对应寄存器的数据如何得到？</p>
</li>
<li><p>三个寄存器模型如何代表dut中的6个寄存器？</p>
<p>RW和R的低位都是0,4,8。通过reg[3:2]就可以把各个寄存器区分</p>
</li>
</ol>
<h4 id="interface-3"><a href="#interface-3" class="headerlink" title="interface"></a>interface</h4><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> mcdf_intf(<span class="keyword">input</span> clk, <span class="keyword">input</span> rstn);</span><br><span class="line">  <span class="comment">// USER TODO</span></span><br><span class="line">  <span class="comment">// To define those signals which do not exsit in</span></span><br><span class="line">  <span class="comment">// reg_if, chnl_if, arb_if or fmt_if</span></span><br><span class="line">  <span class="keyword">logic</span> chnl_en[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">clocking</span> mon_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">input</span> chnl_en;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line"><span class="keyword">endinterface</span></span><br></pre></td></tr></table></figure>
<h4 id="enum-reg-packet"><a href="#enum-reg-packet" class="headerlink" title="enum+reg_packet"></a>enum+reg_packet</h4><p>mcdf_reg_t</p>
<p>除了读写寄存器的6位，还有代表读寄存器的8位信号，相当于一个RW寄存器和一个R寄存器集成了一个寄存器模型</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="keyword">packed</span> &#123;</span><br><span class="line">    <span class="keyword">bit</span>[<span class="number">2</span>:<span class="number">0</span>] len;</span><br><span class="line">    <span class="keyword">bit</span>[<span class="number">1</span>:<span class="number">0</span>] prio;</span><br><span class="line">    <span class="keyword">bit</span> en;</span><br><span class="line">    <span class="keyword">bit</span>[<span class="number">7</span>:<span class="number">0</span>] avail;</span><br><span class="line">  &#125; mcdf_reg_t;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;RW_LEN, RW_PRIO, RW_EN, RD_AVAIL&#125; mcdf_field_t;</span><br></pre></td></tr></table></figure>
<h4 id="mcdf-refmod"><a href="#mcdf-refmod" class="headerlink" title="mcdf_refmod"></a>mcdf_refmod</h4><p>问：优先级怎么没用到？？</p>
<p>在checker中搞一个类似fmt的模型，结合寄存器中的配置信息，对三个通道采集到的数据进行打包，之后再和formattor的输出进行比较</p>
<p>此时传入的接口只用到了复位信号</p>
<p>核心方法：run（）：同样被阻塞，需要等待monitor在mailbox中放值</p>
<ul>
<li><p>do_reg_update（）：forever监控寄存器配置，有就把它get到，把配置信息放入refmod的对应reg数组中</p>
<p>开始的get方法：意味着reg_monitor没检测到数据，该方法被阻塞</p>
<p>从reg_mb中获取寄存器数据，并将其保存下来；地址位对应寄存器模型数组的index</p>
<p>对于读写寄存器：数据的每一位的功能都赋值到寄存器中；</p>
<p>对于读寄存器：将后8位slave_fifo的余量获取到</p>
</li>
<li><p>do_packet()：通过reg数组中获取的配置信息，模仿formattor的打包行为，对3个chnl获取的数据进行打包（3个reg分别对应3个chnl），通过reg的id获取到length</p>
<p>数据包中的data数组的长度就为length！！</p>
<p>开始的peek()方法：意味着chnl_monitor没检测到数据，该方法被阻塞</p>
<p>this.get_field_value(id, RW_LEN)==0，对应ot.length = 4；</p>
<p>this.get_field_value(id, RW_LEN)==1，对应ot.length = 8；以此类推至32</p>
</li>
<li><p>get_field_value(int id, mcdf_field_t f)：</p>
<p>把寄存器模型中的数据放到枚举类型里面，方便调用</p>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> mcdf_refmod;</span><br><span class="line">  <span class="keyword">local</span> <span class="keyword">virtual</span> mcdf_intf intf;</span><br><span class="line">  <span class="keyword">local</span> <span class="keyword">string</span> name;</span><br><span class="line">  mcdf_reg_t regs[<span class="number">3</span>];</span><br><span class="line">  mailbox <span class="variable">#(reg_trans)</span> reg_mb;</span><br><span class="line">  mailbox <span class="variable">#(mon_data_t)</span> in_mbs[<span class="number">3</span>];</span><br><span class="line">  mailbox <span class="variable">#(fmt_trans)</span> out_mbs[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name=<span class="string">"mcdf_refmod"</span>);</span><br><span class="line">    <span class="keyword">this</span><span class="variable">.name</span> = name;</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="keyword">this</span><span class="variable">.out_mbs</span>[i]) <span class="keyword">this</span><span class="variable">.out_mbs</span>[i] = <span class="keyword">new</span>();</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">task</span> run();</span><br><span class="line">    <span class="keyword">fork</span></span><br><span class="line">      do_reset();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.do_reg_update</span>();</span><br><span class="line">      do_packet(<span class="number">0</span>);</span><br><span class="line">      do_packet(<span class="number">1</span>);</span><br><span class="line">      do_packet(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">join</span></span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">task</span> do_reg_update();</span><br><span class="line">    reg_trans t;</span><br><span class="line">    <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.reg_mb</span><span class="variable">.get</span>(t);</span><br><span class="line">      <span class="keyword">if</span>(t<span class="variable">.addr</span>[<span class="number">7</span>:<span class="number">4</span>] == <span class="number">0</span> &amp;&amp; t<span class="variable">.cmd</span> == <span class="meta">`WRITE) begin</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.regs</span>[t<span class="variable">.addr</span>[<span class="number">3</span>:<span class="number">2</span>]]<span class="variable">.en</span> = t<span class="variable">.data</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.regs</span>[t<span class="variable">.addr</span>[<span class="number">3</span>:<span class="number">2</span>]]<span class="variable">.prio</span> = t<span class="variable">.data</span>[<span class="number">2</span>:<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.regs</span>[t<span class="variable">.addr</span>[<span class="number">3</span>:<span class="number">2</span>]]<span class="variable">.len</span> = t<span class="variable">.data</span>[<span class="number">5</span>:<span class="number">3</span>];</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(t<span class="variable">.addr</span>[<span class="number">7</span>:<span class="number">4</span>] == <span class="number">1</span> &amp;&amp; t<span class="variable">.cmd</span> == <span class="meta">`READ) begin</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.regs</span>[t<span class="variable">.addr</span>[<span class="number">3</span>:<span class="number">2</span>]]<span class="variable">.avail</span> = t<span class="variable">.data</span>[<span class="number">7</span>:<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">task</span> do_packet(<span class="keyword">int</span> id);</span><br><span class="line">    fmt_trans ot;</span><br><span class="line">    mon_data_t it;</span><br><span class="line">    <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.in_mbs</span>[id]<span class="variable">.peek</span>(it);</span><br><span class="line">      ot = <span class="keyword">new</span>();</span><br><span class="line">      ot<span class="variable">.length</span> = <span class="number">4</span> &lt;&lt; (<span class="keyword">this</span><span class="variable">.get_field_value</span>(id, RW_LEN) &amp; <span class="number">'b11</span>);</span><br><span class="line">      ot<span class="variable">.data</span> = <span class="keyword">new</span>[ot<span class="variable">.length</span>];</span><br><span class="line">      ot<span class="variable">.ch_id</span> = id;</span><br><span class="line">      <span class="keyword">foreach</span>(ot<span class="variable">.data</span>[m]) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.in_mbs</span>[id]<span class="variable">.get</span>(it);</span><br><span class="line">        ot<span class="variable">.data</span>[m] = it<span class="variable">.data</span>;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.out_mbs</span>[id]<span class="variable">.put</span>(ot);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">int</span> get_field_value(<span class="keyword">int</span> id, mcdf_field_t f);</span><br><span class="line">    <span class="keyword">case</span>(f)</span><br><span class="line">      RW_LEN: <span class="keyword">return</span> regs[id]<span class="variable">.len</span>;</span><br><span class="line">      RW_PRIO: <span class="keyword">return</span> regs[id]<span class="variable">.prio</span>;</span><br><span class="line">      RW_EN: <span class="keyword">return</span> regs[id]<span class="variable">.en</span>;</span><br><span class="line">      RD_AVAIL: <span class="keyword">return</span> regs[id]<span class="variable">.avail</span>;</span><br><span class="line">    <span class="keyword">endcase</span></span><br><span class="line">  <span class="keyword">endfunction</span> </span><br><span class="line"></span><br><span class="line">  <span class="keyword">task</span> do_reset();</span><br><span class="line">    <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">      @(<span class="keyword">negedge</span> intf<span class="variable">.rstn</span>); </span><br><span class="line">      <span class="keyword">foreach</span>(regs[i]) <span class="keyword">begin</span></span><br><span class="line">        regs[i]<span class="variable">.len</span> = <span class="number">'h0</span>;</span><br><span class="line">        regs[i]<span class="variable">.prio</span> = <span class="number">'h3</span>;</span><br><span class="line">        regs[i]<span class="variable">.en</span> = <span class="number">'h1</span>;</span><br><span class="line">        regs[i]<span class="variable">.avail</span> = <span class="number">'h20</span>;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> set_interface(<span class="keyword">virtual</span> mcdf_intf intf);</span><br><span class="line">    <span class="keyword">if</span>(intf == <span class="literal">null</span>)</span><br><span class="line">      <span class="built_in">$error</span>(<span class="string">"interface handle is NULL, please check if target interface has been intantiated"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.intf</span> = intf;</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h4 id="mcdf-checker"><a href="#mcdf-checker" class="headerlink" title="mcdf_checker"></a>mcdf_checker</h4><p>接口传入的目的：见下面各check方法</p>
<p>mailbox的创建：</p>
<ul>
<li>沟通monitor：3个chnl（左连3个monitor的mon_mb，右连3个refmod的in_mbs[3]），1个reg（左连monitor，右连refmod），1个fmt（连接monitor，refmod没有）</li>
<li>沟通refmod：exp_mbs[3]，无需创建，连接out_mbs[3]；</li>
</ul>
<p>核心方法：</p>
<ul>
<li><p>new（）</p>
<ul>
<li>实例mailbox和refmod，建立邮箱连接</li>
</ul>
</li>
<li><p>run（）</p>
<ul>
<li><p>do_channel_disable_check（int id）：</p>
<p>用了mcdf的接口，通道的chnl_en信号为0时，如果valid和ready信号仍能为高，打印错误信息</p>
</li>
<li><p>do_arbiter_priority_check()；get_slave_id_with_prio()</p>
<p>用了arb的接口，通过优先级获取id，并通过id判断通道是否有效</p>
</li>
</ul>
</li>
<li><p>比较fmt输出和slave输入：do_compare()</p>
<p>声明俩fmt_trans句柄，一个从fmt_mb里拿，一个从exp_mbs里拿，如上图所示；</p>
<p>然后调用fmt_trans本身的比较方法，注意打印信息</p>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> mcdf_checker;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">string</span> name;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">int</span> err_count;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">int</span> total_count;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">int</span> chnl_count[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">virtual</span> chnl_intf chnl_vifs[<span class="number">3</span>]; </span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">virtual</span> arb_intf arb_vif; </span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">virtual</span> mcdf_intf mcdf_vif;</span><br><span class="line">    <span class="keyword">local</span> mcdf_refmod refmod;</span><br><span class="line">    mailbox <span class="variable">#(mon_data_t)</span> chnl_mbs[<span class="number">3</span>];</span><br><span class="line">    mailbox <span class="variable">#(fmt_trans)</span> fmt_mb;</span><br><span class="line">    mailbox <span class="variable">#(reg_trans)</span> reg_mb;</span><br><span class="line">    mailbox <span class="variable">#(fmt_trans)</span> exp_mbs[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name=<span class="string">"mcdf_checker"</span>);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.name</span> = name;</span><br><span class="line">      <span class="keyword">foreach</span>(<span class="keyword">this</span><span class="variable">.chnl_mbs</span>[i]) <span class="keyword">this</span><span class="variable">.chnl_mbs</span>[i] = <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.fmt_mb</span> = <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.reg_mb</span> = <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.refmod</span> = <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">foreach</span>(<span class="keyword">this</span><span class="variable">.refmod</span><span class="variable">.in_mbs</span>[i]) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.refmod</span><span class="variable">.in_mbs</span>[i] = <span class="keyword">this</span><span class="variable">.chnl_mbs</span>[i];</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.exp_mbs</span>[i] = <span class="keyword">this</span><span class="variable">.refmod</span><span class="variable">.out_mbs</span>[i];</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.refmod</span><span class="variable">.reg_mb</span> = <span class="keyword">this</span><span class="variable">.reg_mb</span>;</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.err_count</span> = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.total_count</span> = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">foreach</span>(<span class="keyword">this</span><span class="variable">.chnl_count</span>[i]) <span class="keyword">this</span><span class="variable">.chnl_count</span>[i] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> set_interface(<span class="keyword">virtual</span> mcdf_intf mcdf_vif, <span class="keyword">virtual</span> chnl_intf chnl_vifs[<span class="number">3</span>], <span class="keyword">virtual</span> arb_intf arb_vif);</span><br><span class="line">      <span class="keyword">if</span>(mcdf_vif == <span class="literal">null</span>)</span><br><span class="line">        <span class="built_in">$error</span>(<span class="string">"mcdf interface handle is NULL, please check if target interface has been intantiated"</span>);</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.mcdf_vif</span> = mcdf_vif;</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.refmod</span><span class="variable">.set_interface</span>(mcdf_vif);</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">if</span>(chnl_vifs[<span class="number">0</span>] == <span class="literal">null</span> || chnl_vifs[<span class="number">1</span>] == <span class="literal">null</span> || chnl_vifs[<span class="number">2</span>] == <span class="literal">null</span>)</span><br><span class="line">        <span class="built_in">$error</span>(<span class="string">"chnl interface handle is NULL, please check if target interface has been intantiated"</span>);</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.chnl_vifs</span> = chnl_vifs;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">if</span>(arb_vif == <span class="literal">null</span>)</span><br><span class="line">        <span class="built_in">$error</span>(<span class="string">"arb interface handle is NULL, please check if target interface has been intantiated"</span>);</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.arb_vif</span> = arb_vif;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> run();</span><br><span class="line">      <span class="keyword">fork</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.do_channel_disable_check</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.do_channel_disable_check</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.do_channel_disable_check</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.do_arbiter_priority_check</span>();</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.do_compare</span>();</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.refmod</span><span class="variable">.run</span>();</span><br><span class="line">      <span class="keyword">join</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_compare();</span><br><span class="line">      fmt_trans expt, mont;</span><br><span class="line">      <span class="keyword">bit</span> cmp;</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.fmt_mb</span><span class="variable">.get</span>(mont);</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.exp_mbs</span>[mont<span class="variable">.ch_id</span>]<span class="variable">.get</span>(expt);</span><br><span class="line">        cmp = mont<span class="variable">.compare</span>(expt);   </span><br><span class="line">        <span class="keyword">this</span><span class="variable">.total_count</span>++;</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.chnl_count</span>[mont<span class="variable">.ch_id</span>]++;</span><br><span class="line">        <span class="keyword">if</span>(cmp == <span class="number">0</span>) <span class="keyword">begin</span></span><br><span class="line">          <span class="keyword">this</span><span class="variable">.err_count</span>++;</span><br><span class="line">          rpt_pkg::rpt_msg(<span class="string">"[CMPFAIL]"</span>, </span><br><span class="line">            <span class="built_in">$sformatf</span>(<span class="string">"%0t %0dth times comparing but failed! MCDF monitored output packet is different with reference model output"</span>, <span class="built_in">$time</span>, <span class="keyword">this</span><span class="variable">.total_count</span>),</span><br><span class="line">            rpt_pkg::ERROR,</span><br><span class="line">            rpt_pkg::TOP,</span><br><span class="line">            rpt_pkg::LOG);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">          rpt_pkg::rpt_msg(<span class="string">"[CMPSUCD]"</span>,</span><br><span class="line">            <span class="built_in">$sformatf</span>(<span class="string">"%0t %0dth times comparing and succeeded! MCDF monitored output packet is the same with reference model output"</span>, <span class="built_in">$time</span>, <span class="keyword">this</span><span class="variable">.total_count</span>),</span><br><span class="line">            rpt_pkg::INFO,</span><br><span class="line">            rpt_pkg::HIGH);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_channel_disable_check(<span class="keyword">int</span> id);</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        @(<span class="keyword">posedge</span> <span class="keyword">this</span><span class="variable">.mcdf_vif</span><span class="variable">.clk</span> <span class="keyword">iff</span> (<span class="keyword">this</span><span class="variable">.mcdf_vif</span><span class="variable">.rstn</span> &amp;&amp; <span class="keyword">this</span><span class="variable">.mcdf_vif</span><span class="variable">.mon_ck</span><span class="variable">.chnl_en</span>[id]===<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span><span class="variable">.chnl_vifs</span>[id]<span class="variable">.mon_ck</span><span class="variable">.ch_valid</span>===<span class="number">1</span> &amp;&amp; <span class="keyword">this</span><span class="variable">.chnl_vifs</span>[id]<span class="variable">.mon_ck</span><span class="variable">.ch_ready</span>===<span class="number">1</span>)</span><br><span class="line">          rpt_pkg::rpt_msg(<span class="string">"[CHKERR]"</span>, </span><br><span class="line">            <span class="built_in">$sformatf</span>(<span class="string">"ERROR! %0t when channel disabled, ready signal raised when valid high"</span>,<span class="built_in">$time</span>), </span><br><span class="line">            rpt_pkg::ERROR, </span><br><span class="line">            rpt_pkg::TOP);</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_arbiter_priority_check();</span><br><span class="line">      <span class="keyword">int</span> id;</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        @(<span class="keyword">posedge</span> <span class="keyword">this</span><span class="variable">.arb_vif</span><span class="variable">.clk</span> <span class="keyword">iff</span> (<span class="keyword">this</span><span class="variable">.arb_vif</span><span class="variable">.rstn</span> &amp;&amp; <span class="keyword">this</span><span class="variable">.arb_vif</span><span class="variable">.mon_ck</span><span class="variable">.f2a_id_req</span>===<span class="number">1</span>));</span><br><span class="line">        id = <span class="keyword">this</span><span class="variable">.get_slave_id_with_prio</span>();</span><br><span class="line">        <span class="keyword">if</span>(id &gt;= <span class="number">0</span>) <span class="keyword">begin</span></span><br><span class="line">          @(<span class="keyword">posedge</span> <span class="keyword">this</span><span class="variable">.arb_vif</span><span class="variable">.clk</span>);</span><br><span class="line">          <span class="keyword">if</span>(<span class="keyword">this</span><span class="variable">.arb_vif</span><span class="variable">.mon_ck</span><span class="variable">.a2s_acks</span>[id] !== <span class="number">1</span>)</span><br><span class="line">            rpt_pkg::rpt_msg(<span class="string">"[CHKERR]"</span>,</span><br><span class="line">              <span class="built_in">$sformatf</span>(<span class="string">"ERROR! %0t arbiter received f2a_id_req===1 and channel[%0d] raising request with high priority, but is not granted by arbiter"</span>, <span class="built_in">$time</span>, id),</span><br><span class="line">              rpt_pkg::ERROR,</span><br><span class="line">              rpt_pkg::TOP);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">int</span> get_slave_id_with_prio();</span><br><span class="line">      <span class="keyword">int</span> id=-<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">int</span> prio=<span class="number">999</span>;</span><br><span class="line">      <span class="keyword">foreach</span>(<span class="keyword">this</span><span class="variable">.arb_vif</span><span class="variable">.mon_ck</span><span class="variable">.slv_prios</span>[i]) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span><span class="variable">.arb_vif</span><span class="variable">.mon_ck</span><span class="variable">.slv_prios</span>[i] &lt; prio &amp;&amp; <span class="keyword">this</span><span class="variable">.arb_vif</span><span class="variable">.mon_ck</span><span class="variable">.slv_reqs</span>[i]===<span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">          id = i;</span><br><span class="line">          prio = <span class="keyword">this</span><span class="variable">.arb_vif</span><span class="variable">.mon_ck</span><span class="variable">.slv_prios</span>[i];</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">return</span> id;</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> do_report();</span><br><span class="line">      <span class="keyword">string</span> s;</span><br><span class="line">      s = <span class="string">"\n---------------------------------------------------------------\n"</span>;</span><br><span class="line">      s = &#123;s, <span class="string">"CHECKER SUMMARY \n"</span>&#125;; </span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"total comparison count: %0d \n"</span>, <span class="keyword">this</span><span class="variable">.total_count</span>)&#125;; </span><br><span class="line">      <span class="keyword">foreach</span>(<span class="keyword">this</span><span class="variable">.chnl_count</span>[i]) s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">" channel[%0d] comparison count: %0d \n"</span>, i, <span class="keyword">this</span><span class="variable">.chnl_count</span>[i])&#125;;</span><br><span class="line">      s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"total error count: %0d \n"</span>, <span class="keyword">this</span><span class="variable">.err_count</span>)&#125;; </span><br><span class="line">      <span class="keyword">foreach</span>(<span class="keyword">this</span><span class="variable">.chnl_mbs</span>[i]) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span><span class="variable">.chnl_mbs</span>[i]<span class="variable">.num</span>() != <span class="number">0</span>)</span><br><span class="line">          s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"WARNING:: chnl_mbs[%0d] is not empty! size = %0d \n"</span>, i, <span class="keyword">this</span><span class="variable">.chnl_mbs</span>[i]<span class="variable">.num</span>())&#125;; </span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">this</span><span class="variable">.fmt_mb</span><span class="variable">.num</span>() != <span class="number">0</span>)</span><br><span class="line">          s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"WARNING:: fmt_mb is not empty! size = %0d \n"</span>, <span class="keyword">this</span><span class="variable">.fmt_mb</span><span class="variable">.num</span>())&#125;; </span><br><span class="line">      s = &#123;s, <span class="string">"---------------------------------------------------------------\n"</span>&#125;;</span><br><span class="line">      rpt_pkg::rpt_msg(<span class="built_in">$sformatf</span>(<span class="string">"[%s]"</span>,<span class="keyword">this</span><span class="variable">.name</span>), s, rpt_pkg::INFO, rpt_pkg::TOP);</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h4 id="mcdf-env"><a href="#mcdf-env" class="headerlink" title="mcdf_env"></a>mcdf_env</h4><p>把agent，checker融会贯通（chnl_agt，reg_agt，fmt_agt）,功能覆盖率收集</p>
<p>核心方法：</p>
<ul>
<li><p>new()</p>
<p>实例化组价，建立mailbox连接</p>
</li>
<li><p>run（）</p>
<p>所有组件并行run（）</p>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> mcdf_env;</span><br><span class="line">    chnl_agent chnl_agts[<span class="number">3</span>];</span><br><span class="line">    reg_agent reg_agt;</span><br><span class="line">    fmt_agent fmt_agt;</span><br><span class="line">    mcdf_checker chker;</span><br><span class="line">    mcdf_coverage cvrg;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">string</span> name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"mcdf_env"</span>);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.name</span> = name;</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.chker</span> = <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">foreach</span>(chnl_agts[i]) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.chnl_agts</span>[i] = <span class="keyword">new</span>(<span class="built_in">$sformatf</span>(<span class="string">"chnl_agts[%0d]"</span>,i));</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.chnl_agts</span>[i]<span class="variable">.monitor</span><span class="variable">.mon_mb</span> = <span class="keyword">this</span><span class="variable">.chker</span><span class="variable">.chnl_mbs</span>[i];</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.reg_agt</span> = <span class="keyword">new</span>(<span class="string">"reg_agt"</span>);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.reg_agt</span><span class="variable">.monitor</span><span class="variable">.mon_mb</span> = <span class="keyword">this</span><span class="variable">.chker</span><span class="variable">.reg_mb</span>;</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.fmt_agt</span> = <span class="keyword">new</span>(<span class="string">"fmt_agt"</span>);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.fmt_agt</span><span class="variable">.monitor</span><span class="variable">.mon_mb</span> = <span class="keyword">this</span><span class="variable">.chker</span><span class="variable">.fmt_mb</span>;</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.cvrg</span> = <span class="keyword">new</span>();</span><br><span class="line">      <span class="built_in">$display</span>(<span class="string">"%s instantiated and connected objects"</span>, <span class="keyword">this</span><span class="variable">.name</span>);</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">task</span> run();</span><br><span class="line">      <span class="built_in">$display</span>(<span class="built_in">$sformatf</span>(<span class="string">"*****************%s started********************"</span>, <span class="keyword">this</span><span class="variable">.name</span>));</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.do_config</span>();</span><br><span class="line">      <span class="keyword">fork</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.chnl_agts</span>[<span class="number">0</span>]<span class="variable">.run</span>();</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.chnl_agts</span>[<span class="number">1</span>]<span class="variable">.run</span>();</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.chnl_agts</span>[<span class="number">2</span>]<span class="variable">.run</span>();</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.reg_agt</span><span class="variable">.run</span>();</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.fmt_agt</span><span class="variable">.run</span>();</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.chker</span><span class="variable">.run</span>();</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.cvrg</span><span class="variable">.run</span>();</span><br><span class="line">      <span class="keyword">join</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">function</span> <span class="keyword">void</span> do_report();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.chker</span><span class="variable">.do_report</span>();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.cvrg</span><span class="variable">.do_report</span>();</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h4 id="base-test"><a href="#base-test" class="headerlink" title="base_test"></a>base_test</h4><p>组件都封好了，env实例化，执行就好</p>
<p>核心方法：</p>
<ul>
<li><p>new()：</p>
<p>gen的创建，和与env中各个agent的driver的连接</p>
<p>对日志输出文件进行初始化</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpt_pkg::logname = &#123;<span class="keyword">this</span><span class="variable">.name</span>, <span class="string">"_check.log"</span>&#125;;</span><br><span class="line">rpt_pkg::clean_log();</span><br></pre></td></tr></table></figure>
</li>
<li><p>run（）：</p>
<p>fork-join_none：env.run()</p>
<p>每个agent都等待gen的激励才能执行，激励的配置方法在base_test的继承类中实现</p>
</li>
<li><p>两个值是否相同的比较：diff_value（），用于比较寄存器中写入的数据是否正确</p>
</li>
<li><p>reg的三种命令激励发送：void’（）表示此时不返回值</p>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> mcdf_base_test;</span><br><span class="line">    chnl_generator chnl_gens[<span class="number">3</span>];</span><br><span class="line">    reg_generator reg_gen;</span><br><span class="line">    fmt_generator fmt_gen;</span><br><span class="line">    mcdf_env env;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">string</span> name;</span><br><span class="line">    <span class="keyword">local</span> <span class="keyword">int</span> timeout = <span class="number">10</span>; <span class="comment">// 10 * ms</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"mcdf_base_test"</span>);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.name</span> = name;</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.env</span> = <span class="keyword">new</span>(<span class="string">"env"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">foreach</span>(<span class="keyword">this</span><span class="variable">.chnl_gens</span>[i]) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.chnl_gens</span>[i] = <span class="keyword">new</span>();</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.chnl_agts</span>[i]<span class="variable">.driver</span><span class="variable">.req_mb</span> = <span class="keyword">this</span><span class="variable">.chnl_gens</span>[i]<span class="variable">.req_mb</span>;</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.chnl_agts</span>[i]<span class="variable">.driver</span><span class="variable">.rsp_mb</span> = <span class="keyword">this</span><span class="variable">.chnl_gens</span>[i]<span class="variable">.rsp_mb</span>;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.reg_gen</span> = <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.reg_agt</span><span class="variable">.driver</span><span class="variable">.req_mb</span> = <span class="keyword">this</span><span class="variable">.reg_gen</span><span class="variable">.req_mb</span>;</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.reg_agt</span><span class="variable">.driver</span><span class="variable">.rsp_mb</span> = <span class="keyword">this</span><span class="variable">.reg_gen</span><span class="variable">.rsp_mb</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.fmt_gen</span> = <span class="keyword">new</span>();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.fmt_agt</span><span class="variable">.driver</span><span class="variable">.req_mb</span> = <span class="keyword">this</span><span class="variable">.fmt_gen</span><span class="variable">.req_mb</span>;</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.fmt_agt</span><span class="variable">.driver</span><span class="variable">.rsp_mb</span> = <span class="keyword">this</span><span class="variable">.fmt_gen</span><span class="variable">.rsp_mb</span>;</span><br><span class="line"></span><br><span class="line">      rpt_pkg::logname = &#123;<span class="keyword">this</span><span class="variable">.name</span>, <span class="string">"_check.log"</span>&#125;;</span><br><span class="line">      rpt_pkg::clean_log();</span><br><span class="line">      <span class="built_in">$display</span>(<span class="string">"%s instantiated and connected objects"</span>, <span class="keyword">this</span><span class="variable">.name</span>);</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">task</span> run();</span><br><span class="line">      <span class="keyword">fork</span></span><br><span class="line">        env<span class="variable">.run</span>();</span><br><span class="line">      <span class="keyword">join_none</span></span><br><span class="line">      rpt_pkg::rpt_msg(<span class="string">"[TEST]"</span>,</span><br><span class="line">        <span class="built_in">$sformatf</span>(<span class="string">"=====================%s AT TIME %0t STARTED====================="</span>, <span class="keyword">this</span><span class="variable">.name</span>, <span class="built_in">$time</span>),</span><br><span class="line">        rpt_pkg::INFO,</span><br><span class="line">        rpt_pkg::HIGH);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.do_reg</span>();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.do_formatter</span>();</span><br><span class="line">      <span class="keyword">fork</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.do_data</span>();</span><br><span class="line">        <span class="keyword">this</span><span class="variable">.do_watchdog</span>();</span><br><span class="line">      <span class="keyword">join_any</span></span><br><span class="line">      rpt_pkg::rpt_msg(<span class="string">"[TEST]"</span>,</span><br><span class="line">        <span class="built_in">$sformatf</span>(<span class="string">"=====================%s AT TIME %0t FINISHED====================="</span>, <span class="keyword">this</span><span class="variable">.name</span>, <span class="built_in">$time</span>),</span><br><span class="line">        rpt_pkg::INFO,</span><br><span class="line">        rpt_pkg::HIGH);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.do_report</span>();</span><br><span class="line">      <span class="built_in">$finish</span>();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// do register configuration</span></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">task</span> do_reg();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// do external formatter down stream slave configuration</span></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">task</span> do_formatter();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// do data transition from 3 channel slaves</span></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">task</span> do_data();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// timeout watchdog to avoid simulation pending</span></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">task</span> do_watchdog();</span><br><span class="line">      rpt_pkg::rpt_msg(<span class="string">"[TEST]"</span>,</span><br><span class="line">        <span class="built_in">$sformatf</span>(<span class="string">"=====================%s AT TIME %0t WATCHDOG GUARDING====================="</span>, <span class="keyword">this</span><span class="variable">.name</span>, <span class="built_in">$time</span>),</span><br><span class="line">        rpt_pkg::INFO,</span><br><span class="line">        rpt_pkg::HIGH);</span><br><span class="line">      <span class="variable">#(this.timeout * 1ms)</span>;</span><br><span class="line">      rpt_pkg::rpt_msg(<span class="string">"[TEST]"</span>,</span><br><span class="line">        <span class="built_in">$sformatf</span>(<span class="string">"=====================%s AT TIME %0t WATCHDOG BARKING====================="</span>, <span class="keyword">this</span><span class="variable">.name</span>, <span class="built_in">$time</span>),</span><br><span class="line">        rpt_pkg::INFO,</span><br><span class="line">        rpt_pkg::HIGH);</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// do simulation summary</span></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">function</span> <span class="keyword">void</span> do_report();</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.do_report</span>();</span><br><span class="line">      rpt_pkg::do_report();</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">function</span> <span class="keyword">void</span> set_interface(<span class="keyword">virtual</span> chnl_intf ch0_vif </span><br><span class="line">                                        ,<span class="keyword">virtual</span> chnl_intf ch1_vif </span><br><span class="line">                                        ,<span class="keyword">virtual</span> chnl_intf ch2_vif </span><br><span class="line">                                        ,<span class="keyword">virtual</span> reg_intf reg_vif</span><br><span class="line">                                        ,<span class="keyword">virtual</span> arb_intf arb_vif</span><br><span class="line">                                        ,<span class="keyword">virtual</span> fmt_intf fmt_vif</span><br><span class="line">                                        ,<span class="keyword">virtual</span> mcdf_intf mcdf_vif</span><br><span class="line">                                      );</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.chnl_agts</span>[<span class="number">0</span>]<span class="variable">.set_interface</span>(ch0_vif);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.chnl_agts</span>[<span class="number">1</span>]<span class="variable">.set_interface</span>(ch1_vif);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.chnl_agts</span>[<span class="number">2</span>]<span class="variable">.set_interface</span>(ch2_vif);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.reg_agt</span><span class="variable">.set_interface</span>(reg_vif);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.fmt_agt</span><span class="variable">.set_interface</span>(fmt_vif);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.chker</span><span class="variable">.set_interface</span>(mcdf_vif, '&#123;ch0_vif, ch1_vif, ch2_vif&#125;, arb_vif);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.cvrg</span><span class="variable">.set_interface</span>('&#123;ch0_vif, ch1_vif, ch2_vif&#125;, reg_vif, arb_vif, fmt_vif, mcdf_vif);</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">function</span> <span class="keyword">bit</span> diff_value(<span class="keyword">int</span> val1, <span class="keyword">int</span> val2, <span class="keyword">string</span> id = <span class="string">"value_compare"</span>);</span><br><span class="line">      <span class="keyword">if</span>(val1 != val2) <span class="keyword">begin</span></span><br><span class="line">        rpt_pkg::rpt_msg(<span class="string">"[CMPERR]"</span>, </span><br><span class="line">          <span class="built_in">$sformatf</span>(<span class="string">"ERROR! %s val1 %8x != val2 %8x"</span>, id, val1, val2), </span><br><span class="line">          rpt_pkg::ERROR, </span><br><span class="line">          rpt_pkg::TOP);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        rpt_pkg::rpt_msg(<span class="string">"[CMPSUC]"</span>, </span><br><span class="line">          <span class="built_in">$sformatf</span>(<span class="string">"SUCCESS! %s val1 %8x == val2 %8x"</span>, id, val1, val2),</span><br><span class="line">          rpt_pkg::INFO,</span><br><span class="line">          rpt_pkg::HIGH);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">task</span> idle_reg();</span><br><span class="line">      <span class="keyword">void</span>'(reg_gen<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;cmd == <span class="meta">`IDLE; addr == 0; data == 0;&#125;);</span></span><br><span class="line">      reg_gen<span class="variable">.start</span>();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">task</span> write_reg(<span class="keyword">bit</span>[<span class="number">7</span>:<span class="number">0</span>] addr, <span class="keyword">bit</span>[<span class="number">31</span>:<span class="number">0</span>] data);</span><br><span class="line">      <span class="keyword">void</span>'(reg_gen<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;cmd == <span class="meta">`WRITE; addr == local::addr; data == local::data;&#125;);</span></span><br><span class="line">      reg_gen<span class="variable">.start</span>();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">task</span> read_reg(<span class="keyword">bit</span>[<span class="number">7</span>:<span class="number">0</span>] addr, <span class="keyword">output</span> <span class="keyword">bit</span>[<span class="number">31</span>:<span class="number">0</span>] data);</span><br><span class="line">      <span class="keyword">void</span>'(reg_gen<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;cmd == <span class="meta">`READ; addr == local::addr;&#125;);</span></span><br><span class="line">      reg_gen<span class="variable">.start</span>();</span><br><span class="line">      data = reg_gen<span class="variable">.data</span>;</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h4 id="mcdf-data-consistence-basic-test"><a href="#mcdf-data-consistence-basic-test" class="headerlink" title="mcdf_data_consistence_basic_test"></a>mcdf_data_consistence_basic_test</h4><p>无需重复定义run方法，只需要把gen的start执行</p>
<p>3个读写reg的gen配置：固定写入命令；并将写入的命令读出，检查是否正确输入</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> mcdf_data_consistence_basic_test <span class="keyword">extends</span> mcdf_base_test;</span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"mcdf_data_consistence_basic_test"</span>);</span><br><span class="line">      <span class="keyword">super</span><span class="variable">.new</span>(name);</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_reg();</span><br><span class="line">      <span class="keyword">bit</span>[<span class="number">31</span>:<span class="number">0</span>] wr_val, rd_val;</span><br><span class="line">      <span class="comment">// slv0 with len=8,  prio=0, en=1</span></span><br><span class="line">      wr_val = (<span class="number">1</span>&lt;&lt;<span class="number">3</span>)+(<span class="number">0</span>&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.write_reg</span>(<span class="meta">`SLV0_RW_ADDR, wr_val);</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.read_reg</span>(<span class="meta">`SLV0_RW_ADDR, rd_val);</span></span><br><span class="line">      <span class="keyword">void</span>'(<span class="keyword">this</span><span class="variable">.diff_value</span>(wr_val, rd_val, <span class="string">"SLV0_WR_REG"</span>));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// slv1 with len=16, prio=1, en=1</span></span><br><span class="line">      wr_val = (<span class="number">2</span>&lt;&lt;<span class="number">3</span>)+(<span class="number">1</span>&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.write_reg</span>(<span class="meta">`SLV1_RW_ADDR, wr_val);</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.read_reg</span>(<span class="meta">`SLV1_RW_ADDR, rd_val);</span></span><br><span class="line">      <span class="keyword">void</span>'(<span class="keyword">this</span><span class="variable">.diff_value</span>(wr_val, rd_val, <span class="string">"SLV1_WR_REG"</span>));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// slv2 with len=32, prio=2, en=1</span></span><br><span class="line">      wr_val = (<span class="number">3</span>&lt;&lt;<span class="number">3</span>)+(<span class="number">2</span>&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.write_reg</span>(<span class="meta">`SLV2_RW_ADDR, wr_val);</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.read_reg</span>(<span class="meta">`SLV2_RW_ADDR, rd_val);</span></span><br><span class="line">      <span class="keyword">void</span>'(<span class="keyword">this</span><span class="variable">.diff_value</span>(wr_val, rd_val, <span class="string">"SLV2_WR_REG"</span>));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// send IDLE command</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.idle_reg</span>();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_formatter();</span><br><span class="line">      <span class="keyword">void</span>'(fmt_gen<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;fifo == LONG_FIFO; bandwidth == HIGH_WIDTH;&#125;);</span><br><span class="line">      fmt_gen<span class="variable">.start</span>();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_data();</span><br><span class="line">      <span class="keyword">void</span>'(chnl_gens[<span class="number">0</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans==<span class="number">100</span>; ch_id==<span class="number">0</span>; data_nidles==<span class="number">0</span>; pkt_nidles==<span class="number">1</span>; data_size==<span class="number">8</span>; &#125;);</span><br><span class="line">      <span class="keyword">void</span>'(chnl_gens[<span class="number">1</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans==<span class="number">100</span>; ch_id==<span class="number">1</span>; data_nidles==<span class="number">1</span>; pkt_nidles==<span class="number">4</span>; data_size==<span class="number">16</span>;&#125;);</span><br><span class="line">      <span class="keyword">void</span>'(chnl_gens[<span class="number">2</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans==<span class="number">100</span>; ch_id==<span class="number">2</span>; data_nidles==<span class="number">2</span>; pkt_nidles==<span class="number">8</span>; data_size==<span class="number">32</span>;&#125;);</span><br><span class="line">      <span class="keyword">fork</span></span><br><span class="line">        chnl_gens[<span class="number">0</span>]<span class="variable">.start</span>();</span><br><span class="line">        chnl_gens[<span class="number">1</span>]<span class="variable">.start</span>();</span><br><span class="line">        chnl_gens[<span class="number">2</span>]<span class="variable">.start</span>();</span><br><span class="line">      <span class="keyword">join</span></span><br><span class="line">      #<span class="number">10</span>us; <span class="comment">// wait until all data haven been transfered through MCDF</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h4 id="mcdf-full-random-test"><a href="#mcdf-full-random-test" class="headerlink" title="mcdf_full_random_test"></a>mcdf_full_random_test</h4><p>3个读写reg的gen配置：随机写入命令；并将写入的命令读出，检查是否正确输入</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> mcdf_full_random_test <span class="keyword">extends</span> mcdf_base_test;</span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"mcdf_full_random_test"</span>);</span><br><span class="line">      <span class="keyword">super</span><span class="variable">.new</span>(name);</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_reg();</span><br><span class="line">      <span class="keyword">bit</span>[<span class="number">31</span>:<span class="number">0</span>] wr_val, rd_val;</span><br><span class="line">      <span class="comment">// slv0 with len=&#123;4,8,16,32&#125;,  prio=&#123;[0:3]&#125;, en=&#123;[0:1]&#125;</span></span><br><span class="line">      wr_val = ($urandom_range(<span class="number">0</span>,<span class="number">3</span>)&lt;&lt;<span class="number">3</span>)+($urandom_range(<span class="number">0</span>,<span class="number">3</span>)&lt;&lt;<span class="number">1</span>)+$urandom_range(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.write_reg</span>(<span class="meta">`SLV0_RW_ADDR, wr_val);</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.read_reg</span>(<span class="meta">`SLV0_RW_ADDR, rd_val);</span></span><br><span class="line">      <span class="keyword">void</span>'(<span class="keyword">this</span><span class="variable">.diff_value</span>(wr_val, rd_val, <span class="string">"SLV0_WR_REG"</span>));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// slv0 with len=&#123;4,8,16,32&#125;,  prio=&#123;[0:3]&#125;, en=&#123;[0:1]&#125;</span></span><br><span class="line">      wr_val = ($urandom_range(<span class="number">0</span>,<span class="number">3</span>)&lt;&lt;<span class="number">3</span>)+($urandom_range(<span class="number">0</span>,<span class="number">3</span>)&lt;&lt;<span class="number">1</span>)+$urandom_range(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.write_reg</span>(<span class="meta">`SLV1_RW_ADDR, wr_val);</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.read_reg</span>(<span class="meta">`SLV1_RW_ADDR, rd_val);</span></span><br><span class="line">      <span class="keyword">void</span>'(<span class="keyword">this</span><span class="variable">.diff_value</span>(wr_val, rd_val, <span class="string">"SLV1_WR_REG"</span>));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// slv0 with len=&#123;4,8,16,32&#125;,  prio=&#123;[0:3]&#125;, en=&#123;[0:1]&#125;</span></span><br><span class="line">      wr_val = ($urandom_range(<span class="number">0</span>,<span class="number">3</span>)&lt;&lt;<span class="number">3</span>)+($urandom_range(<span class="number">0</span>,<span class="number">3</span>)&lt;&lt;<span class="number">1</span>)+$urandom_range(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.write_reg</span>(<span class="meta">`SLV2_RW_ADDR, wr_val);</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.read_reg</span>(<span class="meta">`SLV2_RW_ADDR, rd_val);</span></span><br><span class="line">      <span class="keyword">void</span>'(<span class="keyword">this</span><span class="variable">.diff_value</span>(wr_val, rd_val, <span class="string">"SLV2_WR_REG"</span>));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// send IDLE command</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.idle_reg</span>();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_formatter();</span><br><span class="line">      <span class="keyword">void</span>'(fmt_gen<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;fifo <span class="keyword">inside</span> &#123;SHORT_FIFO, ULTRA_FIFO&#125;; bandwidth <span class="keyword">inside</span> &#123;LOW_WIDTH, ULTRA_WIDTH&#125;;&#125;);</span><br><span class="line">      fmt_gen<span class="variable">.start</span>();</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_data();</span><br><span class="line">      <span class="keyword">void</span>'(chnl_gens[<span class="number">0</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans <span class="keyword">inside</span> &#123;[<span class="number">400</span>:<span class="number">600</span>]&#125;; ch_id==<span class="number">0</span>; data_nidles <span class="keyword">inside</span> &#123;[<span class="number">0</span>:<span class="number">3</span>]&#125;; pkt_nidles <span class="keyword">inside</span> &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">8</span>&#125;; data_size <span class="keyword">inside</span> &#123;<span class="number">8</span>,<span class="number">16</span>,<span class="number">32</span>&#125;;&#125;);</span><br><span class="line">      <span class="keyword">void</span>'(chnl_gens[<span class="number">1</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans <span class="keyword">inside</span> &#123;[<span class="number">400</span>:<span class="number">600</span>]&#125;; ch_id==<span class="number">1</span>; data_nidles <span class="keyword">inside</span> &#123;[<span class="number">0</span>:<span class="number">3</span>]&#125;; pkt_nidles <span class="keyword">inside</span> &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">8</span>&#125;; data_size <span class="keyword">inside</span> &#123;<span class="number">8</span>,<span class="number">16</span>,<span class="number">32</span>&#125;;&#125;);</span><br><span class="line">      <span class="keyword">void</span>'(chnl_gens[<span class="number">2</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans <span class="keyword">inside</span> &#123;[<span class="number">400</span>:<span class="number">600</span>]&#125;; ch_id==<span class="number">2</span>; data_nidles <span class="keyword">inside</span> &#123;[<span class="number">0</span>:<span class="number">3</span>]&#125;; pkt_nidles <span class="keyword">inside</span> &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">8</span>&#125;; data_size <span class="keyword">inside</span> &#123;<span class="number">8</span>,<span class="number">16</span>,<span class="number">32</span>&#125;;&#125;);</span><br><span class="line">      <span class="keyword">fork</span></span><br><span class="line">        chnl_gens[<span class="number">0</span>]<span class="variable">.start</span>();</span><br><span class="line">        chnl_gens[<span class="number">1</span>]<span class="variable">.start</span>();</span><br><span class="line">        chnl_gens[<span class="number">2</span>]<span class="variable">.start</span>();</span><br><span class="line">      <span class="keyword">join</span></span><br><span class="line">      #<span class="number">10</span>us; <span class="comment">// wait until all data haven been transfered through MCDF</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h3 id="验证文件"><a href="#验证文件" class="headerlink" title="验证文件"></a>验证文件</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="meta-keyword">timescale</span> 1ns/1ps</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="meta-keyword">include</span> "param_def.v"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> chnl_intf(<span class="keyword">input</span> clk, <span class="keyword">input</span> rstn);</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] ch_data;</span><br><span class="line">  <span class="keyword">logic</span>        ch_valid;</span><br><span class="line">  <span class="keyword">logic</span>        ch_ready;</span><br><span class="line">  <span class="keyword">clocking</span> drv_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">output</span> ch_data, ch_valid;</span><br><span class="line">    <span class="keyword">input</span> ch_ready;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line">  <span class="keyword">clocking</span> mon_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">input</span> ch_data, ch_valid, ch_ready;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line"><span class="keyword">endinterface</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> reg_intf(<span class="keyword">input</span> clk, <span class="keyword">input</span> rstn);</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">1</span>:<span class="number">0</span>]                 cmd;</span><br><span class="line">  <span class="keyword">logic</span> [<span class="meta">`ADDR_WIDTH-1:0]     cmd_addr;</span></span><br><span class="line">  <span class="keyword">logic</span> [<span class="meta">`CMD_DATA_WIDTH-1:0] cmd_data_s2m;</span></span><br><span class="line">  <span class="keyword">logic</span> [<span class="meta">`CMD_DATA_WIDTH-1:0] cmd_data_m2s;</span></span><br><span class="line">  <span class="keyword">clocking</span> drv_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">output</span> cmd, cmd_addr, cmd_data_m2s;</span><br><span class="line">    <span class="keyword">input</span> cmd_data_s2m;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line">  <span class="keyword">clocking</span> mon_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">input</span> cmd, cmd_addr, cmd_data_m2s, cmd_data_s2m;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line"><span class="keyword">endinterface</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> arb_intf(<span class="keyword">input</span> clk, <span class="keyword">input</span> rstn);</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">1</span>:<span class="number">0</span>] slv_prios[<span class="number">3</span>];</span><br><span class="line">  <span class="keyword">logic</span> slv_reqs[<span class="number">3</span>];</span><br><span class="line">  <span class="keyword">logic</span> a2s_acks[<span class="number">3</span>];</span><br><span class="line">  <span class="keyword">logic</span> f2a_id_req;</span><br><span class="line">  <span class="keyword">clocking</span> mon_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">input</span> slv_prios, slv_reqs, a2s_acks, f2a_id_req;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line"><span class="keyword">endinterface</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> fmt_intf(<span class="keyword">input</span> clk, <span class="keyword">input</span> rstn);</span><br><span class="line">  <span class="keyword">logic</span>        fmt_grant;</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">1</span>:<span class="number">0</span>]  fmt_chid;</span><br><span class="line">  <span class="keyword">logic</span>        fmt_req;</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">5</span>:<span class="number">0</span>]  fmt_length;</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] fmt_data;</span><br><span class="line">  <span class="keyword">logic</span>        fmt_start;</span><br><span class="line">  <span class="keyword">logic</span>        fmt_end;</span><br><span class="line">  <span class="keyword">clocking</span> drv_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">input</span> fmt_chid, fmt_req, fmt_length, fmt_data, fmt_start;</span><br><span class="line">    <span class="keyword">output</span> fmt_grant;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line">  <span class="keyword">clocking</span> mon_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">input</span> fmt_grant, fmt_chid, fmt_req, fmt_length, fmt_data, fmt_start;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line"><span class="keyword">endinterface</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> mcdf_intf(<span class="keyword">input</span> clk, <span class="keyword">input</span> rstn);</span><br><span class="line">  <span class="comment">// USER TODO</span></span><br><span class="line">  <span class="comment">// To define those signals which do not exsit in</span></span><br><span class="line">  <span class="comment">// reg_if, chnl_if, arb_if or fmt_if</span></span><br><span class="line">  <span class="keyword">logic</span> chnl_en[<span class="number">3</span>];</span><br><span class="line">  <span class="keyword">clocking</span> mon_ck @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">input</span> #<span class="number">1</span>ns <span class="keyword">output</span> #<span class="number">1</span>ns;</span><br><span class="line">    <span class="keyword">input</span> chnl_en;</span><br><span class="line">  <span class="keyword">endclocking</span></span><br><span class="line"><span class="keyword">endinterface</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> tb;</span><br><span class="line">  <span class="keyword">logic</span>         clk;</span><br><span class="line">  <span class="keyword">logic</span>         rstn;</span><br><span class="line"></span><br><span class="line">  mcdf dut(</span><br><span class="line">     <span class="variable">.clk_i</span>       (clk                )</span><br><span class="line">    ,<span class="variable">.rstn_i</span>      (rstn               )</span><br><span class="line">    ,<span class="variable">.cmd_i</span>       (reg_if<span class="variable">.cmd</span>         ) </span><br><span class="line">    ,<span class="variable">.cmd_addr_i</span>  (reg_if<span class="variable">.cmd_addr</span>    ) </span><br><span class="line">    ,<span class="variable">.cmd_data_i</span>  (reg_if<span class="variable">.cmd_data_m2s</span>)  </span><br><span class="line">    ,<span class="variable">.cmd_data_o</span>  (reg_if<span class="variable">.cmd_data_s2m</span>)  </span><br><span class="line">    ,<span class="variable">.ch0_data_i</span>  (chnl0_if<span class="variable">.ch_data</span>   )</span><br><span class="line">    ,<span class="variable">.ch0_vld_i</span>   (chnl0_if<span class="variable">.ch_valid</span>  )</span><br><span class="line">    ,<span class="variable">.ch0_ready_o</span> (chnl0_if<span class="variable">.ch_ready</span>  )</span><br><span class="line">    ,<span class="variable">.ch1_data_i</span>  (chnl1_if<span class="variable">.ch_data</span>   )</span><br><span class="line">    ,<span class="variable">.ch1_vld_i</span>   (chnl1_if<span class="variable">.ch_valid</span>  )</span><br><span class="line">    ,<span class="variable">.ch1_ready_o</span> (chnl1_if<span class="variable">.ch_ready</span>  )</span><br><span class="line">    ,<span class="variable">.ch2_data_i</span>  (chnl2_if<span class="variable">.ch_data</span>   )</span><br><span class="line">    ,<span class="variable">.ch2_vld_i</span>   (chnl2_if<span class="variable">.ch_valid</span>  )</span><br><span class="line">    ,<span class="variable">.ch2_ready_o</span> (chnl2_if<span class="variable">.ch_ready</span>  )</span><br><span class="line">    ,<span class="variable">.fmt_grant_i</span> (fmt_if<span class="variable">.fmt_grant</span>   ) </span><br><span class="line">    ,<span class="variable">.fmt_chid_o</span>  (fmt_if<span class="variable">.fmt_chid</span>    ) </span><br><span class="line">    ,<span class="variable">.fmt_req_o</span>   (fmt_if<span class="variable">.fmt_req</span>     ) </span><br><span class="line">    ,<span class="variable">.fmt_length_o</span>(fmt_if<span class="variable">.fmt_length</span>  )    </span><br><span class="line">    ,<span class="variable">.fmt_data_o</span>  (fmt_if<span class="variable">.fmt_data</span>    )  </span><br><span class="line">    ,<span class="variable">.fmt_start_o</span> (fmt_if<span class="variable">.fmt_start</span>   )  </span><br><span class="line">    ,<span class="variable">.fmt_end_o</span>   (fmt_if<span class="variable">.fmt_end</span>     )  </span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// clock generation</span></span><br><span class="line">  <span class="keyword">initial</span> <span class="keyword">begin</span> </span><br><span class="line">    clk &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">      #<span class="number">5</span> clk &lt;= !clk;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// reset trigger</span></span><br><span class="line">  <span class="keyword">initial</span> <span class="keyword">begin</span> </span><br><span class="line">    #<span class="number">10</span> rstn &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">repeat</span>(<span class="number">10</span>) @(<span class="keyword">posedge</span> clk);</span><br><span class="line">    rstn &lt;= <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">import</span> chnl_pkg::*;</span><br><span class="line">  <span class="keyword">import</span> reg_pkg::*;</span><br><span class="line">  <span class="keyword">import</span> arb_pkg::*;</span><br><span class="line">  <span class="keyword">import</span> fmt_pkg::*;</span><br><span class="line">  <span class="keyword">import</span> mcdf_pkg::*;</span><br><span class="line"></span><br><span class="line">  reg_intf  reg_if(.*);</span><br><span class="line">  chnl_intf chnl0_if(.*);</span><br><span class="line">  chnl_intf chnl1_if(.*);</span><br><span class="line">  chnl_intf chnl2_if(.*);</span><br><span class="line">  arb_intf  arb_if(.*);</span><br><span class="line">  fmt_intf  fmt_if(.*);</span><br><span class="line">  mcdf_intf mcdf_if(.*);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mcdf interface monitoring MCDF ports and signals</span></span><br><span class="line">  <span class="keyword">assign</span> mcdf_if<span class="variable">.chnl_en</span>[<span class="number">0</span>] = tb<span class="variable">.dut</span><span class="variable">.ctrl_regs_inst</span><span class="variable">.slv0_en_o</span>;</span><br><span class="line">  <span class="keyword">assign</span> mcdf_if<span class="variable">.chnl_en</span>[<span class="number">1</span>] = tb<span class="variable">.dut</span><span class="variable">.ctrl_regs_inst</span><span class="variable">.slv1_en_o</span>;</span><br><span class="line">  <span class="keyword">assign</span> mcdf_if<span class="variable">.chnl_en</span>[<span class="number">2</span>] = tb<span class="variable">.dut</span><span class="variable">.ctrl_regs_inst</span><span class="variable">.slv2_en_o</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// arbiter interface monitoring arbiter ports</span></span><br><span class="line">  <span class="keyword">assign</span> arb_if<span class="variable">.slv_prios</span>[<span class="number">0</span>] = tb<span class="variable">.dut</span><span class="variable">.arbiter_inst</span><span class="variable">.slv0_prio_i</span>;</span><br><span class="line">  <span class="keyword">assign</span> arb_if<span class="variable">.slv_prios</span>[<span class="number">1</span>] = tb<span class="variable">.dut</span><span class="variable">.arbiter_inst</span><span class="variable">.slv1_prio_i</span>;</span><br><span class="line">  <span class="keyword">assign</span> arb_if<span class="variable">.slv_prios</span>[<span class="number">2</span>] = tb<span class="variable">.dut</span><span class="variable">.arbiter_inst</span><span class="variable">.slv2_prio_i</span>;</span><br><span class="line">  <span class="keyword">assign</span> arb_if<span class="variable">.slv_reqs</span>[<span class="number">0</span>] = tb<span class="variable">.dut</span><span class="variable">.arbiter_inst</span><span class="variable">.slv0_req_i</span>;</span><br><span class="line">  <span class="keyword">assign</span> arb_if<span class="variable">.slv_reqs</span>[<span class="number">1</span>] = tb<span class="variable">.dut</span><span class="variable">.arbiter_inst</span><span class="variable">.slv1_req_i</span>;</span><br><span class="line">  <span class="keyword">assign</span> arb_if<span class="variable">.slv_reqs</span>[<span class="number">2</span>] = tb<span class="variable">.dut</span><span class="variable">.arbiter_inst</span><span class="variable">.slv2_req_i</span>;</span><br><span class="line">  <span class="keyword">assign</span> arb_if<span class="variable">.a2s_acks</span>[<span class="number">0</span>] = tb<span class="variable">.dut</span><span class="variable">.arbiter_inst</span><span class="variable">.a2s0_ack_o</span>;</span><br><span class="line">  <span class="keyword">assign</span> arb_if<span class="variable">.a2s_acks</span>[<span class="number">1</span>] = tb<span class="variable">.dut</span><span class="variable">.arbiter_inst</span><span class="variable">.a2s1_ack_o</span>;</span><br><span class="line">  <span class="keyword">assign</span> arb_if<span class="variable">.a2s_acks</span>[<span class="number">2</span>] = tb<span class="variable">.dut</span><span class="variable">.arbiter_inst</span><span class="variable">.a2s2_ack_o</span>;</span><br><span class="line">  <span class="keyword">assign</span> arb_if<span class="variable">.f2a_id_req</span> = tb<span class="variable">.dut</span><span class="variable">.arbiter_inst</span><span class="variable">.f2a_id_req_i</span>;</span><br><span class="line"></span><br><span class="line">  mcdf_data_consistence_basic_test t1;</span><br><span class="line">  mcdf_full_random_test t2;</span><br><span class="line">  mcdf_base_test tests[<span class="keyword">string</span>];</span><br><span class="line">  <span class="keyword">string</span> name;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">initial</span> <span class="keyword">begin</span> </span><br><span class="line">    t1 = <span class="keyword">new</span>();</span><br><span class="line">    t2 = <span class="keyword">new</span>();</span><br><span class="line">    tests[<span class="string">"mcdf_data_consistence_basic_test"</span>] = t1;</span><br><span class="line">    tests[<span class="string">"mcdf_full_random_test"</span>] = t2;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">$value$plusargs</span>(<span class="string">"TESTNAME=%s"</span>, name)) <span class="keyword">begin</span></span><br><span class="line">      <span class="keyword">if</span>(tests<span class="variable">.exists</span>(name)) <span class="keyword">begin</span></span><br><span class="line">        tests[name]<span class="variable">.set_interface</span>(chnl0_if, chnl1_if, chnl2_if, reg_if, arb_if, fmt_if, mcdf_if);</span><br><span class="line">        tests[name]<span class="variable">.run</span>();</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="built_in">$fatal</span>(<span class="built_in">$sformatf</span>(<span class="string">"[ERRTEST], test name %s is invalid, please specify a valid name!"</span>, name));</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">      <span class="built_in">$display</span>(<span class="string">"NO runtime optiont +TESTNAME=xxx is configured, and run default test mcdf_data_consistence_basic_test"</span>);</span><br><span class="line">      tests[<span class="string">"mcdf_data_consistence_basic_test"</span>]<span class="variable">.set_interface</span>(chnl0_if, chnl1_if, chnl2_if, reg_if, arb_if, fmt_if, mcdf_if);</span><br><span class="line">      tests[<span class="string">"mcdf_data_consistence_basic_test"</span>]<span class="variable">.run</span>();</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>
<h1 id="实验5：功能覆盖率"><a href="#实验5：功能覆盖率" class="headerlink" title="实验5：功能覆盖率"></a>实验5：功能覆盖率</h1><h2 id="coverage工具类"><a href="#coverage工具类" class="headerlink" title="coverage工具类"></a>coverage工具类</h2><p>定义在最顶层的test类中</p>
<p>问1：为什么bins的定义要对bin的范围进行拆分，如cmd_addr的采样点的bins定义？</p>
<p>答：如果将所有bin集中在一个bins，则每次有一个数命中即全部命中。拆分之后的覆盖率则需要每个都命中才行</p>
<p>问2：“type_option.weight = 0”声明在coverpoint里的意义何在？</p>
<p>答：即该coverpoint在covergroup中的权重为0，不参与covergroup的最终覆盖率计算，不会生成bin；这也是为了方便cross覆盖率的定义</p>
<h3 id="1-寄存器读写覆盖"><a href="#1-寄存器读写覆盖" class="headerlink" title="1. 寄存器读写覆盖"></a>1. 寄存器读写覆盖</h3><p>要求读写命令和地址交叉覆盖，此时才能准确的验证读写是否正确</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">covergroup</span> cg_mcdf_reg_write_read;</span><br><span class="line">      addr: <span class="keyword">coverpoint</span> reg_vif<span class="variable">.mon_ck</span><span class="variable">.cmd_addr</span> &#123;</span><br><span class="line">        type_option<span class="variable">.weight</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">bins</span> slv0_rw_addr = &#123;<span class="meta">`SLV0_RW_ADDR&#125;;</span></span><br><span class="line">        <span class="keyword">bins</span> slv1_rw_addr = &#123;<span class="meta">`SLV1_RW_ADDR&#125;;</span></span><br><span class="line">        <span class="keyword">bins</span> slv2_rw_addr = &#123;<span class="meta">`SLV2_RW_ADDR&#125;;</span></span><br><span class="line">        <span class="keyword">bins</span> slv0_r_addr  = &#123;<span class="meta">`SLV0_R_ADDR &#125;;</span></span><br><span class="line">        <span class="keyword">bins</span> slv1_r_addr  = &#123;<span class="meta">`SLV1_R_ADDR &#125;;</span></span><br><span class="line">        <span class="keyword">bins</span> slv2_r_addr  = &#123;<span class="meta">`SLV2_R_ADDR &#125;;</span></span><br><span class="line">      &#125;</span><br><span class="line">      cmd: <span class="keyword">coverpoint</span> reg_vif<span class="variable">.mon_ck</span><span class="variable">.cmd</span> &#123;</span><br><span class="line">        type_option<span class="variable">.weight</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">bins</span> write = &#123;<span class="meta">`WRITE&#125;;</span></span><br><span class="line">        <span class="keyword">bins</span> read  = &#123;<span class="meta">`READ&#125;;</span></span><br><span class="line">        <span class="keyword">bins</span> idle  = &#123;<span class="meta">`IDLE&#125;;</span></span><br><span class="line">      &#125;</span><br><span class="line">      cmdXaddr: <span class="keyword">cross</span> cmd, addr &#123;</span><br><span class="line">        <span class="keyword">bins</span> slv0_rw_addr = <span class="keyword">binsof</span>(addr<span class="variable">.slv0_rw_addr</span>);</span><br><span class="line">        <span class="keyword">bins</span> slv1_rw_addr = <span class="keyword">binsof</span>(addr<span class="variable">.slv1_rw_addr</span>);</span><br><span class="line">        <span class="keyword">bins</span> slv2_rw_addr = <span class="keyword">binsof</span>(addr<span class="variable">.slv2_rw_addr</span>);</span><br><span class="line">        <span class="keyword">bins</span> slv0_r_addr  = <span class="keyword">binsof</span>(addr<span class="variable">.slv0_r_addr</span> );</span><br><span class="line">        <span class="keyword">bins</span> slv1_r_addr  = <span class="keyword">binsof</span>(addr<span class="variable">.slv1_r_addr</span> );</span><br><span class="line">        <span class="keyword">bins</span> slv2_r_addr  = <span class="keyword">binsof</span>(addr<span class="variable">.slv2_r_addr</span> );</span><br><span class="line">        <span class="keyword">bins</span> write        = <span class="keyword">binsof</span>(cmd<span class="variable">.write</span>);</span><br><span class="line">        <span class="keyword">bins</span> read         = <span class="keyword">binsof</span>(cmd<span class="variable">.read</span> );</span><br><span class="line">        <span class="keyword">bins</span> idle         = <span class="keyword">binsof</span>(cmd<span class="variable">.idle</span> );</span><br><span class="line">        <span class="keyword">bins</span> write_slv0_rw_addr  = <span class="keyword">binsof</span>(cmd<span class="variable">.write</span>) &amp;&amp; <span class="keyword">binsof</span>(addr<span class="variable">.slv0_rw_addr</span>);</span><br><span class="line">        <span class="keyword">bins</span> write_slv1_rw_addr  = <span class="keyword">binsof</span>(cmd<span class="variable">.write</span>) &amp;&amp; <span class="keyword">binsof</span>(addr<span class="variable">.slv1_rw_addr</span>);</span><br><span class="line">        <span class="keyword">bins</span> write_slv2_rw_addr  = <span class="keyword">binsof</span>(cmd<span class="variable">.write</span>) &amp;&amp; <span class="keyword">binsof</span>(addr<span class="variable">.slv2_rw_addr</span>);</span><br><span class="line">        <span class="keyword">bins</span> read_slv0_rw_addr   = <span class="keyword">binsof</span>(cmd<span class="variable">.read</span>) &amp;&amp; <span class="keyword">binsof</span>(addr<span class="variable">.slv0_rw_addr</span>);</span><br><span class="line">        <span class="keyword">bins</span> read_slv1_rw_addr   = <span class="keyword">binsof</span>(cmd<span class="variable">.read</span>) &amp;&amp; <span class="keyword">binsof</span>(addr<span class="variable">.slv1_rw_addr</span>);</span><br><span class="line">        <span class="keyword">bins</span> read_slv2_rw_addr   = <span class="keyword">binsof</span>(cmd<span class="variable">.read</span>) &amp;&amp; <span class="keyword">binsof</span>(addr<span class="variable">.slv2_rw_addr</span>);</span><br><span class="line">        <span class="keyword">bins</span> read_slv0_r_addr    = <span class="keyword">binsof</span>(cmd<span class="variable">.read</span>) &amp;&amp; <span class="keyword">binsof</span>(addr<span class="variable">.slv0_r_addr</span>); </span><br><span class="line">        <span class="keyword">bins</span> read_slv1_r_addr    = <span class="keyword">binsof</span>(cmd<span class="variable">.read</span>) &amp;&amp; <span class="keyword">binsof</span>(addr<span class="variable">.slv1_r_addr</span>); </span><br><span class="line">        <span class="keyword">bins</span> read_slv2_r_addr    = <span class="keyword">binsof</span>(cmd<span class="variable">.read</span>) &amp;&amp; <span class="keyword">binsof</span>(addr<span class="variable">.slv2_r_addr</span>); </span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">endgroup</span></span><br></pre></td></tr></table></figure>
<h3 id="2-寄存器非法指令测试"><a href="#2-寄存器非法指令测试" class="headerlink" title="2. 寄存器非法指令测试"></a>2. 寄存器非法指令测试</h3><p>包括给非法寄存器地址的写和读；给合法读写寄存器地址写入非法数据；对合法读寄存器写入数据（无所谓非法不非法）</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">covergroup</span> cg_mcdf_reg_illegal_access;</span><br><span class="line">  addr: <span class="keyword">coverpoint</span> reg_vif<span class="variable">.mon_ck</span><span class="variable">.cmd_addr</span> &#123;</span><br><span class="line">    type_option<span class="variable">.weight</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bins</span> legal_rw = &#123;<span class="meta">`SLV0_RW_ADDR, `SLV1_RW_ADDR, `SLV2_RW_ADDR&#125;;</span></span><br><span class="line">    <span class="keyword">bins</span> legal_r = &#123;<span class="meta">`SLV0_R_ADDR, `SLV1_R_ADDR, `SLV2_R_ADDR&#125;;</span></span><br><span class="line">    <span class="keyword">bins</span> illegal = &#123;[<span class="number">8'h20</span>:$], <span class="number">8'hC</span>, <span class="number">8'h1C</span>&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  cmd: <span class="keyword">coverpoint</span> reg_vif<span class="variable">.mon_ck</span><span class="variable">.cmd</span> &#123;</span><br><span class="line">    type_option<span class="variable">.weight</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bins</span> write = &#123;<span class="meta">`WRITE&#125;;</span></span><br><span class="line">    <span class="keyword">bins</span> read  = &#123;<span class="meta">`READ&#125;;</span></span><br><span class="line">  &#125;</span><br><span class="line">  wdata: <span class="keyword">coverpoint</span> reg_vif<span class="variable">.mon_ck</span><span class="variable">.cmd_data_m2s</span> &#123;</span><br><span class="line">    type_option<span class="variable">.weight</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bins</span> legal = &#123;[<span class="number">0</span>:<span class="number">'h3F</span>]&#125;;</span><br><span class="line">    <span class="keyword">bins</span> illegal = &#123;[<span class="number">'h40</span>:$]&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  rdata: <span class="keyword">coverpoint</span> reg_vif<span class="variable">.mon_ck</span><span class="variable">.cmd_data_s2m</span> &#123;</span><br><span class="line">    type_option<span class="variable">.weight</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bins</span> legal = &#123;[<span class="number">0</span>:<span class="number">'hFF</span>]&#125;;</span><br><span class="line">    <span class="keyword">illegal_bins</span> illegal = <span class="keyword">default</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  cmdXaddrXdata: <span class="keyword">cross</span> cmd, addr, wdata, rdata &#123;</span><br><span class="line">    <span class="keyword">bins</span> addr_legal_rw = <span class="keyword">binsof</span>(addr<span class="variable">.legal_rw</span>);</span><br><span class="line">    <span class="keyword">bins</span> addr_legal_r = <span class="keyword">binsof</span>(addr<span class="variable">.legal_r</span>);</span><br><span class="line">    <span class="keyword">bins</span> addr_illegal = <span class="keyword">binsof</span>(addr<span class="variable">.illegal</span>);</span><br><span class="line">    <span class="keyword">bins</span> cmd_write = <span class="keyword">binsof</span>(cmd<span class="variable">.write</span>);</span><br><span class="line">    <span class="keyword">bins</span> cmd_read = <span class="keyword">binsof</span>(cmd<span class="variable">.read</span>);</span><br><span class="line">    <span class="keyword">bins</span> wdata_legal = <span class="keyword">binsof</span>(wdata<span class="variable">.legal</span>);</span><br><span class="line">    <span class="keyword">bins</span> wdata_illegal = <span class="keyword">binsof</span>(wdata<span class="variable">.illegal</span>);</span><br><span class="line">    <span class="keyword">bins</span> rdata_legal = <span class="keyword">binsof</span>(rdata<span class="variable">.legal</span>);</span><br><span class="line">    <span class="keyword">bins</span> write_illegal_addr = <span class="keyword">binsof</span>(cmd<span class="variable">.write</span>) &amp;&amp; <span class="keyword">binsof</span>(addr<span class="variable">.illegal</span>);</span><br><span class="line">    <span class="keyword">bins</span> read_illegal_addr  = <span class="keyword">binsof</span>(cmd<span class="variable">.read</span>) &amp;&amp; <span class="keyword">binsof</span>(addr<span class="variable">.illegal</span>);</span><br><span class="line">    <span class="keyword">bins</span> write_illegal_rw_data = <span class="keyword">binsof</span>(cmd<span class="variable">.write</span>) &amp;&amp; <span class="keyword">binsof</span>(addr<span class="variable">.legal_rw</span>) &amp;&amp; <span class="keyword">binsof</span>(wdata<span class="variable">.illegal</span>);</span><br><span class="line">    <span class="keyword">bins</span> write_illegal_r_data = <span class="keyword">binsof</span>(cmd<span class="variable">.write</span>) &amp;&amp; <span class="keyword">binsof</span>(addr<span class="variable">.legal_r</span>) &amp;&amp; <span class="keyword">binsof</span>(wdata<span class="variable">.illegal</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">endgroup</span></span><br></pre></td></tr></table></figure>
<h3 id="3-通道关闭测试"><a href="#3-通道关闭测试" class="headerlink" title="3. 通道关闭测试"></a>3. 通道关闭测试</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">covergroup</span> cg_channel_disable;</span><br><span class="line">      ch0_en: <span class="keyword">coverpoint</span> mcdf_vif<span class="variable">.mon_ck</span><span class="variable">.chnl_en</span>[<span class="number">0</span>] &#123;</span><br><span class="line">        type_option<span class="variable">.weight</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">wildcard</span> <span class="keyword">bins</span> en  = &#123;<span class="number">1'b1</span>&#125;;</span><br><span class="line">        <span class="keyword">wildcard</span> <span class="keyword">bins</span> dis = &#123;<span class="number">1'b0</span>&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      ch1_en: <span class="keyword">coverpoint</span> mcdf_vif<span class="variable">.mon_ck</span><span class="variable">.chnl_en</span>[<span class="number">1</span>] &#123;</span><br><span class="line">        type_option<span class="variable">.weight</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">wildcard</span> <span class="keyword">bins</span> en  = &#123;<span class="number">1'b1</span>&#125;;</span><br><span class="line">        <span class="keyword">wildcard</span> <span class="keyword">bins</span> dis = &#123;<span class="number">1'b0</span>&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      ch2_en: <span class="keyword">coverpoint</span> mcdf_vif<span class="variable">.mon_ck</span><span class="variable">.chnl_en</span>[<span class="number">2</span>] &#123;</span><br><span class="line">        type_option<span class="variable">.weight</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">wildcard</span> <span class="keyword">bins</span> en  = &#123;<span class="number">1'b1</span>&#125;;</span><br><span class="line">        <span class="keyword">wildcard</span> <span class="keyword">bins</span> dis = &#123;<span class="number">1'b0</span>&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      ch0_vld: <span class="keyword">coverpoint</span> chnl_vifs[<span class="number">0</span>]<span class="variable">.mon_ck</span><span class="variable">.ch_valid</span> &#123;</span><br><span class="line">        type_option<span class="variable">.weight</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">bins</span> hi = &#123;<span class="number">1'b1</span>&#125;;</span><br><span class="line">        <span class="keyword">bins</span> lo = &#123;<span class="number">1'b0</span>&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      ch1_vld: <span class="keyword">coverpoint</span> chnl_vifs[<span class="number">1</span>]<span class="variable">.mon_ck</span><span class="variable">.ch_valid</span> &#123;</span><br><span class="line">        type_option<span class="variable">.weight</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">bins</span> hi = &#123;<span class="number">1'b1</span>&#125;;</span><br><span class="line">        <span class="keyword">bins</span> lo = &#123;<span class="number">1'b0</span>&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      ch2_vld: <span class="keyword">coverpoint</span> chnl_vifs[<span class="number">2</span>]<span class="variable">.mon_ck</span><span class="variable">.ch_valid</span> &#123;</span><br><span class="line">        type_option<span class="variable">.weight</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">bins</span> hi = &#123;<span class="number">1'b1</span>&#125;;</span><br><span class="line">        <span class="keyword">bins</span> lo = &#123;<span class="number">1'b0</span>&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      chenXchvld: <span class="keyword">cross</span> ch0_en, ch1_en, ch2_en, ch0_vld, ch1_vld, ch2_vld &#123;</span><br><span class="line">        <span class="keyword">bins</span> ch0_en  = <span class="keyword">binsof</span>(ch0_en<span class="variable">.en</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch0_dis = <span class="keyword">binsof</span>(ch0_en<span class="variable">.dis</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch1_en  = <span class="keyword">binsof</span>(ch1_en<span class="variable">.en</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch1_dis = <span class="keyword">binsof</span>(ch1_en<span class="variable">.dis</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch2_en  = <span class="keyword">binsof</span>(ch2_en<span class="variable">.en</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch2_dis = <span class="keyword">binsof</span>(ch2_en<span class="variable">.dis</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch0_hi  = <span class="keyword">binsof</span>(ch0_vld<span class="variable">.hi</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch0_lo  = <span class="keyword">binsof</span>(ch0_vld<span class="variable">.lo</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch1_hi  = <span class="keyword">binsof</span>(ch1_vld<span class="variable">.hi</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch1_lo  = <span class="keyword">binsof</span>(ch1_vld<span class="variable">.lo</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch2_hi  = <span class="keyword">binsof</span>(ch2_vld<span class="variable">.hi</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch2_lo  = <span class="keyword">binsof</span>(ch2_vld<span class="variable">.lo</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch0_en_vld = <span class="keyword">binsof</span>(ch0_en<span class="variable">.en</span>) &amp;&amp; <span class="keyword">binsof</span>(ch0_vld<span class="variable">.hi</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch0_dis_vld = <span class="keyword">binsof</span>(ch0_en<span class="variable">.dis</span>) &amp;&amp; <span class="keyword">binsof</span>(ch0_vld<span class="variable">.hi</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch1_en_vld = <span class="keyword">binsof</span>(ch1_en<span class="variable">.en</span>) &amp;&amp; <span class="keyword">binsof</span>(ch1_vld<span class="variable">.hi</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch1_dis_vld = <span class="keyword">binsof</span>(ch1_en<span class="variable">.dis</span>) &amp;&amp; <span class="keyword">binsof</span>(ch1_vld<span class="variable">.hi</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch2_en_vld = <span class="keyword">binsof</span>(ch2_en<span class="variable">.en</span>) &amp;&amp; <span class="keyword">binsof</span>(ch2_vld<span class="variable">.hi</span>);</span><br><span class="line">        <span class="keyword">bins</span> ch2_dis_vld = <span class="keyword">binsof</span>(ch2_en<span class="variable">.dis</span>) &amp;&amp; <span class="keyword">binsof</span>(ch2_vld<span class="variable">.hi</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">endgroup</span></span><br></pre></td></tr></table></figure>
<h1 id="UVM-实验1"><a href="#UVM-实验1" class="headerlink" title="UVM-实验1"></a>UVM-实验1</h1><h2 id="1-1-工厂的注册、创建和覆盖机制"><a href="#1-1-工厂的注册、创建和覆盖机制" class="headerlink" title="1.1 工厂的注册、创建和覆盖机制"></a>1.1 工厂的注册、创建和覆盖机制</h2><p>总结：</p>
<p>1.实例创建：和new相比，通过仓库进行实例创建时，name无法传进去；</p>
<h3 id="object类型实例创建"><a href="#object类型实例创建" class="headerlink" title="object类型实例创建"></a>object类型实例创建</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> object_create <span class="keyword">extends</span> top;</span><br><span class="line">  trans t1, t2, t3, t4;</span><br><span class="line">  <span class="meta">`uvm_component_utils(object_create)</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"object_create"</span>, uvm_component parent = <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">  <span class="keyword">endfunction</span>    </span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> build_phase(uvm_phase phase);</span><br><span class="line">    uvm_factory f = uvm_factory::get(); <span class="comment">// get singleton factory</span></span><br><span class="line">    <span class="keyword">super</span><span class="variable">.build_phase</span>(phase);</span><br><span class="line">    t1 = <span class="keyword">new</span>(<span class="string">"t1"</span>); <span class="comment">// direct construction</span></span><br><span class="line">    t2 = trans::type_id::create(<span class="string">"t2"</span>, <span class="keyword">this</span>); <span class="comment">// common method</span></span><br><span class="line">    <span class="keyword">void</span>'(<span class="built_in">$cast</span>(t3,f<span class="variable">.create_object_by_type</span>(trans::get_type(), get_full_name(), <span class="string">"t3"</span>))); <span class="comment">// factory method</span></span><br><span class="line">    <span class="keyword">void</span>'(<span class="built_in">$cast</span>(t4,create_object(<span class="string">"trans"</span>, <span class="string">"t4"</span>))); <span class="comment">// pre-defined method inside component</span></span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"><span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<p>执行仿真命令</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vsim -novopt -classdebug +UVM_TESTNAME=object_create work<span class="variable">.factory_mechanism</span></span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<p><img src="https://gitee.com/biongd/img/raw/master/img/20210725083843.png" alt="在这里插入图片描述"></p>
<h3 id="component实例创建"><a href="#component实例创建" class="headerlink" title="component实例创建"></a>component实例创建</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> component_create <span class="keyword">extends</span> top;</span><br><span class="line">  unit u1, u2, u3, u4;</span><br><span class="line">  <span class="meta">`uvm_component_utils(component_create)</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"component_create"</span>, uvm_component parent = <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> build_phase(uvm_phase phase);</span><br><span class="line">    uvm_factory f = uvm_factory::get(); <span class="comment">// get singleton factory</span></span><br><span class="line">    <span class="keyword">super</span><span class="variable">.build_phase</span>(phase);</span><br><span class="line">    u1 = <span class="keyword">new</span>(<span class="string">"u1"</span>); <span class="comment">// direct construction</span></span><br><span class="line">    u2 = unit::type_id::create(<span class="string">"u2"</span>, <span class="keyword">this</span>); <span class="comment">// common method</span></span><br><span class="line">    <span class="keyword">void</span>'(<span class="built_in">$cast</span>(u3,f<span class="variable">.create_component_by_type</span>(unit::get_type(), get_full_name(), <span class="string">"u3"</span>, <span class="keyword">this</span>))); <span class="comment">// factory method</span></span><br><span class="line">    <span class="keyword">void</span>'(<span class="built_in">$cast</span>(u4,create_component(<span class="string">"unit"</span>, <span class="string">"u4"</span>))); <span class="comment">// pre-defined method inside component</span></span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"><span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<p>仿真命令：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vsim -novopt -classdebug +UVM_TESTNAME=component_create work<span class="variable">.factory_mechanism</span></span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<p><img src="https://gitee.com/biongd/img/raw/master/img/20210725093928.png" alt="在这里插入图片描述"></p>
<h3 id="object覆盖类型"><a href="#object覆盖类型" class="headerlink" title="object覆盖类型"></a>object覆盖类型</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> object_override <span class="keyword">extends</span> object_create;</span><br><span class="line">  <span class="meta">`uvm_component_utils(object_override)</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"object_override"</span>, uvm_component parent = <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> build_phase(uvm_phase phase);</span><br><span class="line">    set_type_override_by_type(trans::get_type(), bad_trans::get_type());		<span class="comment">//bad_trans替换trans</span></span><br><span class="line">    <span class="keyword">super</span><span class="variable">.build_phase</span>(phase);</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"><span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<p>仿真语句：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vsim -novopt -classdebug +UVM_TESTNAME=object_override work<span class="variable">.factory_mechanism</span></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<p><img src="https://gitee.com/biongd/img/raw/master/img/20210725095206.png" alt="在这里插入图片描述"></p>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>问：trans类型不是被覆盖了吗，执行结果为什么还会创建trans？</p>
<p>答：badtrans的new方法中，首先执行了父类的new方法：执行步骤为：</p>
<ul>
<li>object_override的build_phase先执行类型覆盖，此时trans的工厂实例创建方法全部变成bantrans来创建！！！</li>
<li>执行父类object_create的的build_phase，进行trans（实际上是bad_trans）的工厂实例化</li>
<li>badtrans的工厂实例化实际上还是执行badtrans的new方法，此时首先调用父类的new方法，完成trans的实例创建</li>
</ul>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h3 id="component覆盖类型"><a href="#component覆盖类型" class="headerlink" title="component覆盖类型"></a>component覆盖类型</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> component_override <span class="keyword">extends</span> component_create;</span><br><span class="line">  <span class="meta">`uvm_component_utils(component_override)</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"component_override"</span>, uvm_component parent = <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> build_phase(uvm_phase phase);</span><br><span class="line">    set_type_override(<span class="string">"unit"</span>, <span class="string">"big_unit"</span>);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.build_phase</span>(phase);</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"><span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<p>仿真结果：</p>
<p><img src="https://gitee.com/biongd/img/raw/master/img/20210725100011.png" alt="在这里插入图片描述"></p>
<p>和object的覆盖方式类似</p>
<h2 id="1-2-域自动化及UVM常用方法"><a href="#1-2-域自动化及UVM常用方法" class="headerlink" title="1.2 域自动化及UVM常用方法"></a>1.2 域自动化及UVM常用方法</h2><p><strong>使用域自动化的宏方法</strong></p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`uvm_object_utils_begin(trans)</span></span><br><span class="line">  <span class="meta">`uvm_field_int(addr, UVM_ALL_ON)		//域自动化的声明</span></span><br><span class="line">  <span class="meta">`uvm_field_int(data, UVM_ALL_ON)</span></span><br><span class="line">  <span class="meta">`uvm_field_enum(op_t, op, UVM_ALL_ON)</span></span><br><span class="line">  <span class="meta">`uvm_field_string(name, UVM_ALL_ON)</span></span><br><span class="line"><span class="meta">`uvm_object_utils_end</span></span><br></pre></td></tr></table></figure>
<p><strong><code>uvm_object::compare()</code>方法</strong></p>
<p>比较<code>t1</code>和<code>t2</code>是否相等</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">trans t1, t2;</span><br><span class="line"><span class="keyword">bit</span> is_equal;</span><br><span class="line">phase<span class="variable">.raise_objection</span>(<span class="keyword">this</span>);</span><br><span class="line">t1 = trans::type_id::create(<span class="string">"t1"</span>);</span><br><span class="line">t1<span class="variable">.data</span> = <span class="number">'h1FF</span>;</span><br><span class="line">t1<span class="variable">.addr</span> = <span class="number">'hF100</span>;</span><br><span class="line">t1<span class="variable">.op</span> = WRITE;</span><br><span class="line">t1<span class="variable">.name</span> = <span class="string">"t1"</span>;</span><br><span class="line">t2 = trans::type_id::create(<span class="string">"t2"</span>);</span><br><span class="line">t2<span class="variable">.data</span> = <span class="number">'h2FF</span>;</span><br><span class="line">t2<span class="variable">.addr</span> = <span class="number">'hF200</span>;</span><br><span class="line">t2<span class="variable">.op</span> = WRITE;</span><br><span class="line">t2<span class="variable">.name</span> = <span class="string">"t2"</span>;</span><br><span class="line">is_equal = t1<span class="variable">.compare</span>(t2);</span><br><span class="line">uvm_default_comparer<span class="variable">.show_max</span> = <span class="number">10</span>;</span><br><span class="line">is_equal = t1<span class="variable">.compare</span>(t2);</span><br></pre></td></tr></table></figure>
<p><strong>全局控制对象</strong></p>
<p><code>uvm_default_comparer</code>(<code>uvm_comparer</code>类型)是默认的UVM全局比较器，show_max可以设置最大比较结果。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uvm_default_comparer<span class="variable">.show_max</span> = <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>此时可以将自动化域中的所有变量比较完，并通过回调函数do_compare打印错误信息</p>
<p><strong>回调函数</strong></p>
<p>执行<code>compare()</code>函数会自动调用<code>do_compare()</code>这个回调函数</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="keyword">bit</span> do_compare(uvm_object rhs, uvm_comparer comparer);</span><br><span class="line">  trans t;</span><br><span class="line">  do_compare = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">void</span>'(<span class="built_in">$cast</span>(t, rhs));</span><br><span class="line">  <span class="keyword">if</span>(addr != t<span class="variable">.addr</span>) <span class="keyword">begin</span></span><br><span class="line">    do_compare = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">`uvm_warning("CMPERR", $sformatf("addr %8x != %8x", addr, t.addr))</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">if</span>(data != t<span class="variable">.data</span>) <span class="keyword">begin</span></span><br><span class="line">    do_compare = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">`uvm_warning("CMPERR", $sformatf("data %8x != %8x", data, t.data))</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">if</span>(op != t<span class="variable">.op</span>) <span class="keyword">begin</span></span><br><span class="line">    do_compare = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">`uvm_warning("CMPERR", $sformatf("op %s != %8x", op, t.op))</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">if</span>(addr != t<span class="variable">.addr</span>) <span class="keyword">begin</span></span><br><span class="line">    do_compare = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">`uvm_warning("CMPERR", $sformatf("name %8x != %8x", name, t.name))</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endfunction</span></span><br></pre></td></tr></table></figure>
<p> <strong><code>uvm_object::print()</code>方法及<code>uvm_object_copy()</code>方法</strong></p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!is_equal)</span><br><span class="line">        <span class="meta">`uvm_warning("CMPERR", "t1 is not equal to t2")</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="meta">`uvm_info("CMPERR", "t1 is equal to t2", UVM_LOW)</span></span><br><span class="line">        </span><br><span class="line">      <span class="meta">`uvm_info("COPY", "Before uvm_object copy() taken", UVM_LOW)</span></span><br><span class="line">      t1<span class="variable">.print</span>();</span><br><span class="line">      t2<span class="variable">.print</span>();</span><br><span class="line">      <span class="meta">`uvm_info("COPY", "After uvm_object t2 is copied to t1", UVM_LOW)</span></span><br><span class="line">      t1<span class="variable">.copy</span>(t2);</span><br><span class="line">      t1<span class="variable">.print</span>();</span><br><span class="line">      t2<span class="variable">.print</span>();</span><br><span class="line">      <span class="meta">`uvm_info("CMP", "Compare t1 and t2", UVM_LOW)</span></span><br><span class="line">      is_equal = t1<span class="variable">.compare</span>(t2);</span><br><span class="line">      <span class="keyword">if</span>(!is_equal)</span><br><span class="line">        <span class="meta">`uvm_warning("CMPERR", "t1 is not equal to t2")</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="meta">`uvm_info("CMPERR", "t1 is equal to t2", UVM_LOW)</span></span><br></pre></td></tr></table></figure>
<p>执行命令：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vsim -novopt -classdebug +UVM_TESTNAME=object_methods_test work<span class="variable">.object_methods</span></span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20210222232335976.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5Nzk0MDYy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:67%;" /></p>
<p><img src="https://img-blog.csdnimg.cn/2021022223272566.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5Nzk0MDYy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:67%;" /></p>
<h2 id="1-3-phase机制"><a href="#1-3-phase机制" class="headerlink" title="1.3 phase机制"></a>1.3 phase机制</h2><p>phase机制使得验证环境从组建、连接、执行，得以分阶段执行，按照层次结构和phase顺序严格执行，继而避免一些依赖关系，也使得可以正确地将不同的代码放置到不同的phase块中。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> comp2 <span class="keyword">extends</span> uvm_component;</span><br><span class="line">  <span class="meta">`uvm_component_utils(comp2)</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"comp2"</span>, uvm_component parent = <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">    <span class="meta">`uvm_info("CREATE", $sformatf("unit type [%s] created", name), UVM_LOW)</span></span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> build_phase(uvm_phase phase);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.build_phase</span>(phase);</span><br><span class="line">    <span class="meta">`uvm_info("BUILD", "comp2 build phase entered", UVM_LOW)</span></span><br><span class="line">    <span class="meta">`uvm_info("BUILD", "comp2 build phase exited", UVM_LOW)</span></span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> connect_phase(uvm_phase phase);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.connect_phase</span>(phase);</span><br><span class="line">    <span class="meta">`uvm_info("CONNECT", "comp2 connect phase entered", UVM_LOW)</span></span><br><span class="line">    <span class="meta">`uvm_info("CONNECT", "comp2 connect phase exited", UVM_LOW)</span></span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">task</span> run_phase(uvm_phase phase);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.run_phase</span>(phase);</span><br><span class="line">    <span class="meta">`uvm_info("RUN", "comp2 run phase entered", UVM_LOW)</span></span><br><span class="line">    <span class="meta">`uvm_info("RUN", "comp2 run phase entered", UVM_LOW)</span></span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> report_phase(uvm_phase phase);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.report_phase</span>(phase);</span><br><span class="line">    <span class="meta">`uvm_info("REPORT", "comp2 report phase entered", UVM_LOW)</span></span><br><span class="line">    <span class="meta">`uvm_info("REPORT", "comp2 report phase exited", UVM_LOW)   </span></span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"><span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<p>comp3类</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> comp3 <span class="keyword">extends</span> uvm_component;</span><br><span class="line">    <span class="meta">`uvm_component_utils(comp3)</span></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"comp3"</span>, uvm_component parent = <span class="literal">null</span>);</span><br><span class="line">      <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">      <span class="meta">`uvm_info("CREATE", $sformatf("unit type [%s] created", name), UVM_LOW)</span></span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> build_phase(uvm_phase phase);</span><br><span class="line">      <span class="keyword">super</span><span class="variable">.build_phase</span>(phase);</span><br><span class="line">      <span class="meta">`uvm_info("BUILD", "comp3 build phase entered", UVM_LOW)</span></span><br><span class="line">      <span class="meta">`uvm_info("BUILD", "comp3 build phase exited", UVM_LOW)</span></span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> connect_phase(uvm_phase phase);</span><br><span class="line">      <span class="keyword">super</span><span class="variable">.connect_phase</span>(phase);</span><br><span class="line">      <span class="meta">`uvm_info("CONNECT", "comp3 connect phase entered", UVM_LOW)</span></span><br><span class="line">      <span class="meta">`uvm_info("CONNECT", "comp3 connect phase exited", UVM_LOW)</span></span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">    <span class="keyword">task</span> run_phase(uvm_phase phase);</span><br><span class="line">      <span class="keyword">super</span><span class="variable">.run_phase</span>(phase);</span><br><span class="line">      <span class="meta">`uvm_info("RUN", "comp3 run phase entered", UVM_LOW)</span></span><br><span class="line">      <span class="meta">`uvm_info("RUN", "comp3 run phase entered", UVM_LOW)</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> report_phase(uvm_phase phase);</span><br><span class="line">      <span class="keyword">super</span><span class="variable">.report_phase</span>(phase);</span><br><span class="line">      <span class="meta">`uvm_info("REPORT", "comp3 report phase entered", UVM_LOW)</span></span><br><span class="line">      <span class="meta">`uvm_info("REPORT", "comp3 report phase exited", UVM_LOW)   </span></span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<p><code>comp1</code>类</p>
<p><code>comp1</code>中声明了<code>comp2</code>、<code>comp3</code>作为成员变量，并且在<code>build_phase</code>中做了例化</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> comp1 <span class="keyword">extends</span> uvm_component;</span><br><span class="line">   comp2 c2;</span><br><span class="line">   comp3 c3;</span><br><span class="line">   <span class="meta">`uvm_component_utils(comp1)</span></span><br><span class="line">   <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"comp1"</span>, uvm_component parent = <span class="literal">null</span>);</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">     <span class="meta">`uvm_info("CREATE", $sformatf("unit type [%s] created", name), UVM_LOW)</span></span><br><span class="line">   <span class="keyword">endfunction</span></span><br><span class="line">   <span class="keyword">function</span> <span class="keyword">void</span> build_phase(uvm_phase phase);</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.build_phase</span>(phase);</span><br><span class="line">     <span class="meta">`uvm_info("BUILD", "comp1 build phase entered", UVM_LOW)</span></span><br><span class="line">     c2 = comp2::type_id::create(<span class="string">"c2"</span>, <span class="keyword">this</span>);</span><br><span class="line">     c3 = comp3::type_id::create(<span class="string">"c3"</span>, <span class="keyword">this</span>);</span><br><span class="line">     <span class="meta">`uvm_info("BUILD", "comp1 build phase exited", UVM_LOW)</span></span><br><span class="line">   <span class="keyword">endfunction</span></span><br><span class="line">   <span class="keyword">function</span> <span class="keyword">void</span> connect_phase(uvm_phase phase);</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.connect_phase</span>(phase);</span><br><span class="line">     <span class="meta">`uvm_info("CONNECT", "comp1 connect phase entered", UVM_LOW)</span></span><br><span class="line">     <span class="meta">`uvm_info("CONNECT", "comp1 connect phase exited", UVM_LOW)</span></span><br><span class="line">   <span class="keyword">endfunction</span></span><br><span class="line">   <span class="keyword">task</span> run_phase(uvm_phase phase);</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.run_phase</span>(phase);</span><br><span class="line">     <span class="meta">`uvm_info("RUN", "comp1 run phase entered", UVM_LOW)</span></span><br><span class="line">     <span class="meta">`uvm_info("RUN", "comp1 run phase entered", UVM_LOW)</span></span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line">   <span class="keyword">function</span> <span class="keyword">void</span> report_phase(uvm_phase phase);</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.report_phase</span>(phase);</span><br><span class="line">     <span class="meta">`uvm_info("REPORT", "comp1 report phase entered", UVM_LOW)</span></span><br><span class="line">     <span class="meta">`uvm_info("REPORT", "comp1 report phase exited", UVM_LOW)   </span></span><br><span class="line">   <span class="keyword">endfunction</span></span><br><span class="line"> <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<p><code>phase_order_test</code>类</p>
<p>创建验证结构，<code>uvm_test</code>一定是顶层结构，而<code>uvm_test</code>的引擎是<code>uvm_root</code>。<code>phase_order_test</code>中包含了<code>comp1 c1</code>，并且在<code>build_phase</code>中也创建了<code>c1</code></p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> phase_order_test <span class="keyword">extends</span> uvm_test;</span><br><span class="line">    comp1 c1;</span><br><span class="line">    <span class="meta">`uvm_component_utils(phase_order_test)</span></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"phase_order_test"</span>, uvm_component parent = <span class="literal">null</span>);</span><br><span class="line">      <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> build_phase(uvm_phase phase);</span><br><span class="line">      <span class="keyword">super</span><span class="variable">.build_phase</span>(phase);</span><br><span class="line">      <span class="meta">`uvm_info("BUILD", "phase_order_test build phase entered", UVM_LOW)</span></span><br><span class="line">      c1 = comp1::type_id::create(<span class="string">"c1"</span>, <span class="keyword">this</span>);</span><br><span class="line">      <span class="meta">`uvm_info("BUILD", "phase_order_test build phase exited", UVM_LOW)</span></span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> connect_phase(uvm_phase phase);</span><br><span class="line">      <span class="keyword">super</span><span class="variable">.connect_phase</span>(phase);</span><br><span class="line">      <span class="meta">`uvm_info("CONNECT", "phase_order_test connect phase entered", UVM_LOW)</span></span><br><span class="line">      <span class="meta">`uvm_info("CONNECT", "phase_order_test connect phase exited", UVM_LOW)</span></span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">    <span class="keyword">task</span> run_phase(uvm_phase phase);</span><br><span class="line">      <span class="keyword">super</span><span class="variable">.run_phase</span>(phase);</span><br><span class="line">      <span class="meta">`uvm_info("RUN", "phase_order_test run phase entered", UVM_LOW)</span></span><br><span class="line">      phase<span class="variable">.raise_objection</span>(<span class="keyword">this</span>);</span><br><span class="line">      #<span class="number">1</span>us;</span><br><span class="line">      phase<span class="variable">.drop_objection</span>(<span class="keyword">this</span>);</span><br><span class="line">      <span class="meta">`uvm_info("RUN", "phase_order_test run phase exited", UVM_LOW)</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">void</span> report_phase(uvm_phase phase);</span><br><span class="line">      <span class="keyword">super</span><span class="variable">.report_phase</span>(phase);</span><br><span class="line">      <span class="meta">`uvm_info("REPORT", "phase_order_test report phase entered", UVM_LOW)</span></span><br><span class="line">      <span class="meta">`uvm_info("REPORT", "phase_order_test report phase exited", UVM_LOW)    </span></span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">task</span> reset_phase(uvm_phase phase);</span><br><span class="line">      <span class="meta">`uvm_info("RESET", "phase_order_test reset phase entered", UVM_LOW)</span></span><br><span class="line">      phase<span class="variable">.raise_objection</span>(<span class="keyword">this</span>);</span><br><span class="line">      #<span class="number">1</span>us;</span><br><span class="line">      phase<span class="variable">.drop_objection</span>(<span class="keyword">this</span>);</span><br><span class="line">      <span class="meta">`uvm_info("RESET", "phase_order_test reset phase exited", UVM_LOW)</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">task</span> main_phase(uvm_phase phase);</span><br><span class="line">      <span class="meta">`uvm_info("MAIN", "phase_order_test main phase entered", UVM_LOW)</span></span><br><span class="line">      phase<span class="variable">.raise_objection</span>(<span class="keyword">this</span>);</span><br><span class="line">      #<span class="number">1</span>us;</span><br><span class="line">      phase<span class="variable">.drop_objection</span>(<span class="keyword">this</span>);</span><br><span class="line">      <span class="meta">`uvm_info("MAIN", "phase_order_test main phase exited", UVM_LOW)</span></span><br><span class="line">    <span class="keyword">endtask</span> </span><br><span class="line">  <span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<p>执行命令</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vsim -novopt -classdebug +UVM_TESTNAME=phase_order_test work<span class="variable">.phase_order</span></span><br></pre></td></tr></table></figure>
<p>仿真结果</p>
<p><img src="https://img-blog.csdnimg.cn/20210223002453273.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5Nzk0MDYy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/20210223002724759.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5Nzk0MDYy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><strong>总结：</strong></p>
<ul>
<li>comp2和comp3和同级，comp1中实例化了comp2和comp3，最顶层的test类实例化了comp1</li>
<li>build_phase：test-c1-c2-c3</li>
<li>connect_phase：c2-c3-c1-test</li>
<li>run_phase：c2-c3-c1-test(test挂起，进入c1-c2-c3，但是comp组件的run-phase组件都没挂起，直接退出)</li>
<li>main_phase：test</li>
<li>report_phase: c2-c3-c1-test</li>
</ul>
<p><code>build_phase</code>、<code>connect_phase</code>、<code>run_phase</code>、<code>report_phase</code>都是按照自顶向下或者自底向上的顺序依次执行的。</p>
<p><code>run_phase</code>是9种phase唯一的task，与<code>run_phase</code>平行执行的是12个分支phase，所以在0时刻，<code>run_phase</code>和<code>reset_phase</code>是并行的，但是<strong>要等到<code>reset_phase</code>在执行完成之后，<code>run_phase</code>才能执行完</strong>。继而进入下一个<code>extract_phase</code>阶段。<code>reset_phase</code>和<code>main_phase</code>之间却是有先后顺序的，先执行<code>reset_phase</code>在1000时刻结束，然后<code>main_phase</code>才开始执行，在2000时刻结束。所以整个仿真最后耗时Time=2us。</p>
<h2 id="1-4-config机制"><a href="#1-4-config机制" class="headerlink" title="1.4 config机制"></a>1.4 config机制</h2><p>实现接口从<code>uvm_config</code>模块到验证环境中的传递，使得<code>c1</code>和<code>c2</code>可以得到接口，并且检查接口是否最终得到。</p>
<h3 id="接口uvm-config-if和对象uvm-config"><a href="#接口uvm-config-if和对象uvm-config" class="headerlink" title="接口uvm_config_if和对象uvm_config"></a>接口<code>uvm_config_if</code>和对象uvm_config</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> uvm_config_if;</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] addr;</span><br><span class="line">  <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] data;</span><br><span class="line">  <span class="keyword">logic</span> [ <span class="number">1</span>:<span class="number">0</span>] op;</span><br><span class="line"><span class="keyword">endinterface</span></span><br></pre></td></tr></table></figure>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> config_obj <span class="keyword">extends</span> uvm_object;</span><br><span class="line">  <span class="keyword">int</span> comp1_var;</span><br><span class="line">  <span class="keyword">int</span> comp2_var;</span><br><span class="line">  <span class="meta">`uvm_object_utils(config_obj)</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"config_obj"</span>);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.new</span>(name);</span><br><span class="line">    <span class="meta">`uvm_info("CREATE", $sformatf("config_obj type [%s] created", name), UVM_LOW)</span></span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"><span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<p>实现配置对象<code>config_obj</code>从<code>uvm_config_test</code>到<code>c1</code>和<code>c2</code>的传递。</p>
<h3 id="底层comp2和次底层comp1类"><a href="#底层comp2和次底层comp1类" class="headerlink" title="底层comp2和次底层comp1类"></a>底层comp2和次底层comp1类</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> comp2 <span class="keyword">extends</span> uvm_component;</span><br><span class="line">  <span class="keyword">int</span> var2;</span><br><span class="line">  <span class="keyword">virtual</span> uvm_config_if vif;  </span><br><span class="line">  config_obj cfg; </span><br><span class="line">  <span class="meta">`uvm_component_utils(comp2)</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"comp2"</span>, uvm_component parent = <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">    var2 = <span class="number">200</span>;</span><br><span class="line">    <span class="meta">`uvm_info("CREATE", $sformatf("unit type [%s] created", name), UVM_LOW)</span></span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> build_phase(uvm_phase phase);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.build_phase</span>(phase);</span><br><span class="line">    <span class="meta">`uvm_info("BUILD", "comp2 build phase entered", UVM_LOW)</span></span><br><span class="line">    <span class="keyword">if</span>(!uvm_config_db<span class="variable">#(virtual uvm_config_if)::get(this, "", "vif", vif))</span></span><br><span class="line">      <span class="meta">`uvm_error("GETVIF", "no virtual interface is assigned")</span></span><br><span class="line">      </span><br><span class="line">    <span class="meta">`uvm_info("GETINT", $sformatf("before config get, var2 = %0d", var2), UVM_LOW)</span></span><br><span class="line">    uvm_config_db<span class="variable">#(int)::get(this, "", "var2", var2)</span>;</span><br><span class="line">    <span class="meta">`uvm_info("GETINT", $sformatf("after config get, var2 = %0d", var2), UVM_LOW)</span></span><br><span class="line">    </span><br><span class="line">    uvm_config_db<span class="variable">#(config_obj)::get(this, "", "cfg", cfg)</span>;</span><br><span class="line">    <span class="meta">`uvm_info("GETOBJ", $sformatf("after config get, cfg.comp2_var = %0d", cfg.comp2_var), UVM_LOW)     </span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">`uvm_info("BUILD", "comp2 build phase exited", UVM_LOW)</span></span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"><span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<p><code>comp1</code>类，在<code>comp1</code>中包含一个<code>comp2</code>对象</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> comp1 <span class="keyword">extends</span> uvm_component;</span><br><span class="line">  <span class="keyword">int</span> var1;</span><br><span class="line">  comp2 c2;</span><br><span class="line">  config_obj cfg; </span><br><span class="line">  <span class="keyword">virtual</span> uvm_config_if vif;</span><br><span class="line">  <span class="meta">`uvm_component_utils(comp1)</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"comp1"</span>, uvm_component parent = <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">    var1 = <span class="number">100</span>;</span><br><span class="line">    <span class="meta">`uvm_info("CREATE", $sformatf("unit type [%s] created", name), UVM_LOW)</span></span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> build_phase(uvm_phase phase);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.build_phase</span>(phase);</span><br><span class="line">    <span class="meta">`uvm_info("BUILD", "comp1 build phase entered", UVM_LOW)</span></span><br><span class="line">    <span class="keyword">if</span>(!uvm_config_db<span class="variable">#(virtual uvm_config_if)::get(this, "", "vif", vif))</span></span><br><span class="line">      <span class="meta">`uvm_error("GETVIF", "no virtual interface is assigned")</span></span><br><span class="line">      </span><br><span class="line">    <span class="meta">`uvm_info("GETINT", $sformatf("before config get, var1 = %0d", var1), UVM_LOW)</span></span><br><span class="line">    uvm_config_db<span class="variable">#(int)::get(this, "", "var1", var1)</span>;</span><br><span class="line">    <span class="meta">`uvm_info("GETINT", $sformatf("after config get, var1 = %0d", var1), UVM_LOW)</span></span><br><span class="line">    </span><br><span class="line">    uvm_config_db<span class="variable">#(config_obj)::get(this, "", "cfg", cfg)</span>;</span><br><span class="line">    <span class="meta">`uvm_info("GETOBJ", $sformatf("after config get, cfg.comp1_var = %0d", cfg.comp1_var), UVM_LOW)</span></span><br><span class="line">    </span><br><span class="line">    c2 = comp2::type_id::create(<span class="string">"c2"</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="meta">`uvm_info("BUILD", "comp1 build phase exited", UVM_LOW)</span></span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"><span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h3 id="顶层test类"><a href="#顶层test类" class="headerlink" title="顶层test类"></a>顶层test类</h3><p><code>uvm_config</code>模块，顶层test模块，实现所有object及单一变量的传递</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> uvm_config_test <span class="keyword">extends</span> uvm_test;</span><br><span class="line">  comp1 c1;</span><br><span class="line">  config_obj cfg;</span><br><span class="line">  <span class="meta">`uvm_component_utils(uvm_config_test)</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"uvm_config_test"</span>, uvm_component parent = <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> build_phase(uvm_phase phase);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.build_phase</span>(phase);</span><br><span class="line">    <span class="meta">`uvm_info("BUILD", "uvm_config_test build phase entered", UVM_LOW)</span></span><br><span class="line">    </span><br><span class="line">    cfg = config_obj::type_id::create(<span class="string">"cfg"</span>);</span><br><span class="line">    cfg<span class="variable">.comp1_var</span> = <span class="number">100</span>;</span><br><span class="line">    cfg<span class="variable">.comp2_var</span> = <span class="number">200</span>;</span><br><span class="line">    uvm_config_db<span class="variable">#(config_obj)::set(this, "*", "cfg", cfg)</span>;		<span class="comment">//将config_obj通过config_db传递给c1和c2</span></span><br><span class="line">    </span><br><span class="line">    uvm_config_db<span class="variable">#(int)::set(this, "c1", "var1", 10)</span>;				<span class="comment">//c1.var1和c2.var2的变量设置。</span></span><br><span class="line">    uvm_config_db<span class="variable">#(int)::set(this, "c1.c2", "var2", 20)</span>;</span><br><span class="line">    </span><br><span class="line">    c1 = comp1::type_id::create(<span class="string">"c1"</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="meta">`uvm_info("BUILD", "uvm_config_test build phase exited", UVM_LOW)</span></span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line">  <span class="keyword">task</span> run_phase(uvm_phase phase);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.run_phase</span>(phase);</span><br><span class="line">    <span class="meta">`uvm_info("RUN", "uvm_config_test run phase entered", UVM_LOW)</span></span><br><span class="line">    phase<span class="variable">.raise_objection</span>(<span class="keyword">this</span>);</span><br><span class="line">    #<span class="number">1</span>us;</span><br><span class="line">    phase<span class="variable">.drop_objection</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="meta">`uvm_info("RUN", "uvm_config_test run phase exited", UVM_LOW)</span></span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"><span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<h3 id="uvm-config模块"><a href="#uvm-config模块" class="headerlink" title="uvm_config模块"></a>uvm_config模块</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> uvm_config;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">import</span> uvm_pkg::*;</span><br><span class="line">  <span class="meta">`<span class="meta-keyword">include</span> "uvm_macros.svh"</span></span><br><span class="line">  <span class="keyword">import</span> uvm_config_pkg::*;</span><br><span class="line">  </span><br><span class="line">  uvm_config_if if0();		<span class="comment">//在module模块才可以看得到interface，实现例化</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">  	<span class="comment">//在验证环境中设置interface到c1、c2</span></span><br><span class="line">    uvm_config_db<span class="variable">#(virtual uvm_config_if)::set(uvm_root::get(), "uvm_test_top.*", "vif", if0)</span>;</span><br><span class="line">    run_test(<span class="string">""</span>); <span class="comment">// empty test name</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><img src="https://img-blog.csdnimg.cn/20210223115209417.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5Nzk0MDYy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:67%;" /></p>
<ul>
<li><p>接口都是在initial块中就set到config_db中，object和单一变脸都是在test中进行set（注意test类15行中*的用法）</p>
</li>
<li><p>对于调用get方法获取接口或对象的类，其实例化必须发生在config_db的set之后</p>
</li>
<li><p>注意传递interface时参数的固定写法！！！ 通过<code>.*</code>可以同时代表comp1和comp2两个类</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">uvm_config_db<span class="variable">#(virtual uvm_config_if)::set(uvm_root::get(), "uvm_test_top.*", "vif", if0)</span>;</span><br><span class="line">run_test(<span class="string">""</span>); <span class="comment">// empty test name</span></span><br><span class="line">  </span><br><span class="line">  uvm_config_db<span class="variable">#(config_obj)::set(this, "*", "cfg", cfg)</span>;		<span class="comment">//将config_obj通过config_db传递给c1和c2</span></span><br><span class="line">  </span><br><span class="line">  uvm_config_db<span class="variable">#(int)::set(this, "c1", "var1", 10)</span>;				<span class="comment">//c1.var1和c2.var2的变量设置。</span></span><br><span class="line">  uvm_config_db<span class="variable">#(int)::set(this, "c1.c2", "var2", 20)</span>;</span><br><span class="line">  </span><br><span class="line">  c1 = comp1::type_id::create(<span class="string">"c1"</span>, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>执行仿真命令</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vsim -novopt -classdebug +UVM_TESTNAME=uvm_config_test work<span class="variable">.uvm_config</span></span><br></pre></td></tr></table></figure>
<p>仿真结果</p>
<p><img src="https://img-blog.csdnimg.cn/20210223162412676.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5Nzk0MDYy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="1-5-message管理"><a href="#1-5-message管理" class="headerlink" title="1.5 message管理"></a>1.5 message管理</h2><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="keyword">void</span> build_phase(uvm_phase phase);</span><br><span class="line">      <span class="keyword">super</span><span class="variable">.build_phase</span>(phase);</span><br><span class="line">      <span class="meta">`uvm_info("BUILD", "uvm_message_test build phase entered", UVM_LOW)</span></span><br><span class="line">      cfg = config_obj::type_id::create(<span class="string">"cfg"</span>);</span><br><span class="line">      c1 = comp1::type_id::create(<span class="string">"c1"</span>, <span class="keyword">this</span>);</span><br><span class="line">      c2 = comp2::type_id::create(<span class="string">"c2"</span>, <span class="keyword">this</span>);</span><br><span class="line">      <span class="comment">// set_report_verbosity_level_hier(UVM_NONE);</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">//TODO-5.2</span></span><br><span class="line">      <span class="comment">//Use set_report_id_verbosity_level_hier() to disable all of </span></span><br><span class="line">      <span class="comment">//"CREATE", "BUILD", "RUN" ID message under the uvm_message_test</span></span><br><span class="line">      <span class="comment">// Think why message "CREATE" could not be disabled ?</span></span><br><span class="line">      <span class="comment">//set_report_id_verbosity_hier("BUILD", UVM_NONE);</span></span><br><span class="line">      <span class="comment">//set_report_id_verbosity_hier("CREATE", UVM_NONE);</span></span><br><span class="line">      <span class="comment">//set_report_id_verbosity_hier("RUN", UVM_NONE);</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">//TODO-5.3</span></span><br><span class="line">      <span class="comment">//Why the UVM message from config_obj type and uvm_message module</span></span><br><span class="line">      <span class="comment">//could not be disabled? Please use the message filter methods</span></span><br><span class="line">      <span class="comment">//to disable them</span></span><br><span class="line">      <span class="comment">// uvm_root::get().set_report_id_verbosity_hier("CREATE", UVM_NONE);</span></span><br><span class="line">      <span class="comment">// uvm_root::get().set_report_id_verbosity_hier("BUILD", UVM_NONE);</span></span><br><span class="line">      <span class="comment">// uvm_root::get().set_report_id_verbosity_hier("RUN", UVM_NONE);</span></span><br><span class="line">      <span class="meta">`uvm_info("BUILD", "uvm_message_test build phase exited", UVM_LOW)</span></span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">//TODO-5.3</span></span><br><span class="line">        <span class="comment">//Why the UVM message from config_obj type and uvm_message module</span></span><br><span class="line">        <span class="comment">//could not be disabled? Please use the message filter methods</span></span><br><span class="line">        <span class="comment">//to disable them</span></span><br><span class="line">        <span class="comment">// uvm_root::get().set_report_id_verbosity_hier("TOPTB", UVM_NONE);</span></span><br><span class="line">        <span class="meta">`uvm_info("TOPTB", "RUN TEST entered", UVM_LOW)</span></span><br><span class="line">        run_test(<span class="string">""</span>); <span class="comment">// empty test name</span></span><br><span class="line">        <span class="meta">`uvm_info("TOPTB", "RUN TEST exited", UVM_LOW)</span></span><br><span class="line"> 	 <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>无错时的打印信息：</p>
<p><img src="https://gitee.com/biongd/img/raw/master/img/20210726100216.png" alt="image-20210726100216554" style="zoom: 80%;" /></p>
<p><strong>5.1.使用冗余度进行过滤的方法</strong>：<code>set_report_verbosity_level_hier()</code></p>
<p>在<code>uvm_message_test::build_phase()</code>中屏蔽所有层次的消息，也就是不允许有任何<code>uvm_message_test</code>及其以下组件的消息在仿真时打印出来。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set_report_verbosity_level_hier(UVM_NONE);</span><br></pre></td></tr></table></figure>
<p>执行命令：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vsim -novopt -classdebug +UVM_TESTNAME=uvm_message_test work<span class="variable">.uvm_message</span></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<p>很明显，只有设置冗余度之前的消息代码进行了执行</p>
<p><img src="https://img-blog.csdnimg.cn/20210223164131969.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5Nzk0MDYy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:67%;" /></p>
<p><strong>5.2 使用id+冗余度进行过滤</strong>：set_report_id_verbosity_hier(“CREATE”, UVM_NONE)</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uvm_root::get()<span class="variable">.set_report_id_verbosity_hier</span>(<span class="string">"CREATE"</span>, UVM_NONE);</span><br><span class="line">uvm_root::get()<span class="variable">.set_report_id_verbosity_hier</span>(<span class="string">"BUILD"</span>, UVM_NONE);</span><br><span class="line">uvm_root::get()<span class="variable">.set_report_id_verbosity_hier</span>(<span class="string">"RUN"</span>, UVM_NONE);</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<p><img src="https://gitee.com/biongd/img/raw/master/img/20210725212500.png" alt="在这里插入图片描述" style="zoom:67%;" /></p>
<p>5.3 在指定的phase中添加过滤器</p>
<p>在<code>end_of_elaboration_phase</code>中使用<code>set_report_id_verbosity_level_hier()</code>来过滤ID的消息，可以使得<code>uvm_message_test</code>的[BUILD]顺利执行完，继而执行完<code>c1</code>和<code>c2</code>的[BUILD]。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="keyword">void</span> end_of_elaboration_phase(uvm_phase phase);</span><br><span class="line">  set_report_id_verbosity_hier(<span class="string">"BUILD"</span>, UVM_NONE);</span><br><span class="line">  set_report_id_verbosity_hier(<span class="string">"CREATE"</span>, UVM_NONE);</span><br><span class="line">  set_report_id_verbosity_hier(<span class="string">"RUN"</span>, UVM_NONE);</span><br><span class="line"><span class="keyword">endfunction</span></span><br></pre></td></tr></table></figure>
<p>仿真结果:<br><img src="https://gitee.com/biongd/img/raw/master/img/20210726104104.png" alt="在这里插入图片描述" style="zoom: 80%;" /></p>
<p><strong>5.4 如何屏蔽最顶层initial块中的info：</strong></p>
<p>所有的打印消息，无论屏蔽与否，都会将config_obj的[CREATE]消息以及uvm_message模块里面的[TOPTB]消息打印出来。</p>
<p>可以使用消息过滤方法uvm_root::get()来获取最顶层的(即uvm_message_test的顶层)，来控制过滤[CREATE]、[TOPTB]消息。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">  uvm_root::get()<span class="variable">.set_report_id_verbosity_hier</span>(<span class="string">"TOPTB"</span>, UVM_NONE);</span><br><span class="line">  <span class="meta">`uvm_info("TOPTB", "RUN TEST entered", UVM_LOW)</span></span><br><span class="line">  run_test(<span class="string">""</span>); <span class="comment">// empty test name</span></span><br><span class="line">  <span class="meta">`uvm_info("TOPTB", "RUN TEST exited", UVM_LOW)</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/biongd/img/raw/master/img/20210726104515.png" alt="在这里插入图片描述"></p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>过滤前执行的打印信息照常打印，过滤后执行的打印信息受过滤器管控</p>
<h1 id="UVM-实验2"><a href="#UVM-实验2" class="headerlink" title="UVM-实验2"></a>UVM-实验2</h1><h2 id="1-1-验证组件和层次构建"><a href="#1-1-验证组件和层次构建" class="headerlink" title="1.1 验证组件和层次构建"></a>1.1 验证组件和层次构建</h2><p>首先将各个package中的SV组件替换为UVM组件</p>
<p>实现组件对应原则：</p>
<ul>
<li>SV的transaction类对应uvm_sequence_item</li>
<li>SV的driver类对应uvm_driver</li>
<li>SV的generator类对应uvm_sequence + uvm_sequencer</li>
<li>SV的monitor对应uvm_monitor</li>
<li>SV的agent对应uvm_agent</li>
<li>SV的env对应uvm_env</li>
<li>SV的checker对应uvm_scoreboard</li>
<li>SV的reference model和coverage model均对应uvm_component</li>
<li>SV的test对应uvm_test</li>
</ul>
<p>在遵循上面的对应原则的过程中，在进行类的转换时，需要注意：</p>
<ul>
<li><p>SV的上述类均需要继承于其对应的UVM类</p>
</li>
<li><p>在类定义过程中，一定需要使用<code>&#39;uvm_component_utils()</code>或者<code>&#39;uvm_object_utils()</code>完成类的注册。</p>
</li>
<li><p>在使用上述工厂注册宏的时候，会伴随着“域声明自动化”，一般而言，将sequence item类定义时，应当伴随着域声明，即利用<code>&#39;uvm_object_utils_begin</code></p>
<p>和<code>&#39;uvm_object_utils_end</code>完成。这是由于对于sequence item对象的拷贝、比较和打印等操作比较多，因此在定义sequence item类时，最好需要完成域的自动化声明。</p>
</li>
<li><p>一定要注意构建函数new()的声明方式，uvm_component的构建函数有两个参数<code>new(string name, uvm_component parent)</code>，而uvm_object的构建函数只有一个参数<code>new(string name)</code>。</p>
</li>
<li><p>在组件之间的层次关系构建中，依然按照之前SV组件的层次关系，只需要在不同的phase阶段完成组件的例化和连接。</p>
</li>
</ul>
<h2 id="1-2-UVM文件结构"><a href="#1-2-UVM文件结构" class="headerlink" title="1.2 UVM文件结构"></a>1.2 UVM文件结构</h2><h3 id="chnl-trans类"><a href="#chnl-trans类" class="headerlink" title="chnl_trans类"></a><code>chnl_trans</code>类</h3><p>相比于SV验证模块代码，成员变量没有发生什么变化，但是省略掉了<code>clone()</code>和<code>sprint()</code>这两个方法，因为UVM做了<strong>类的注册以及域的自动化的声明</strong>，可以使用UVM核心基类的克隆、打印、比较等一些常见方法。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> chnl_trans <span class="keyword">extends</span> uvm_sequence_item;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">bit</span>[<span class="number">31</span>:<span class="number">0</span>] data[];</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> ch_id;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> pkt_id;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> data_nidles;</span><br><span class="line">    <span class="keyword">rand</span> <span class="keyword">int</span> pkt_nidles;</span><br><span class="line">    <span class="keyword">bit</span> rsp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constraint</span> cstr&#123;</span><br><span class="line">      <span class="keyword">soft</span> data<span class="variable">.size</span> <span class="keyword">inside</span> &#123;[<span class="number">4</span>:<span class="number">32</span>]&#125;;</span><br><span class="line">      <span class="keyword">foreach</span>(data[i]) data[i] == <span class="number">'hC000_0000</span> + (<span class="keyword">this</span><span class="variable">.ch_id</span>&lt;&lt;<span class="number">24</span>) + (<span class="keyword">this</span><span class="variable">.pkt_id</span>&lt;&lt;<span class="number">8</span>) + i;</span><br><span class="line">      <span class="keyword">soft</span> ch_id == <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">soft</span> pkt_id == <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">soft</span> data_nidles <span class="keyword">inside</span> &#123;[<span class="number">0</span>:<span class="number">2</span>]&#125;;</span><br><span class="line">      <span class="keyword">soft</span> pkt_nidles <span class="keyword">inside</span> &#123;[<span class="number">1</span>:<span class="number">10</span>]&#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">`uvm_object_utils_begin(chnl_trans)          //注册的同时，进行域自动化声明</span></span><br><span class="line">      <span class="meta">`uvm_field_array_int(data, UVM_ALL_ON)</span></span><br><span class="line">      <span class="meta">`uvm_field_int(ch_id, UVM_ALL_ON)</span></span><br><span class="line">      <span class="meta">`uvm_field_int(pkt_id, UVM_ALL_ON)</span></span><br><span class="line">      <span class="meta">`uvm_field_int(data_nidles, UVM_ALL_ON)</span></span><br><span class="line">      <span class="meta">`uvm_field_int(pkt_nidles, UVM_ALL_ON)</span></span><br><span class="line">      <span class="meta">`uvm_field_int(rsp, UVM_ALL_ON)</span></span><br><span class="line">    <span class="meta">`uvm_object_utils_end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="keyword">new</span> (<span class="keyword">string</span> name = <span class="string">"chnl_trans"</span>);</span><br><span class="line">      <span class="keyword">super</span><span class="variable">.new</span>(name);</span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"> <span class="keyword">endclass</span>: chnl_trans</span><br></pre></td></tr></table></figure>
<h3 id="chnl-driver类"><a href="#chnl-driver类" class="headerlink" title="chnl_driver类"></a><code>chnl_driver</code>类</h3><ul>
<li>继承于uvm_driver是一个参数类，所以得<code>uvm_driver #(chnl_trans)</code>。而SV中的run()转换成了UVM中<code>run_phase(uvm_phase phase)</code>。</li>
<li><code>do_driver()</code>方法里面<code>void&#39;($cast(rsp, req.clone()))</code>，是因为UVM核心基类的克隆方法返回的是uvm_object类型，所以需要把父类的句柄转换为子类的句柄，而<code>req.clone()</code>这个父类句柄指向的是一个子类的对象，所以能转换成功。</li>
<li><code>chnl_write()</code>方法中把SV中的$display替换成了UVM中的<code>&#39;uvm_info()</code>。</li>
<li>全部的打印方法都由UVM的宏来完成！！</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">class</span> chnl_driver <span class="keyword">extends</span> uvm_driver <span class="variable">#(chnl_trans)</span>;</span><br><span class="line">  <span class="keyword">local</span> <span class="keyword">virtual</span> chnl_intf intf;</span><br><span class="line">  mailbox <span class="variable">#(chnl_trans)</span> req_mb;</span><br><span class="line">  mailbox <span class="variable">#(chnl_trans)</span> rsp_mb;</span><br><span class="line"></span><br><span class="line">  <span class="meta">`uvm_component_utils(chnl_driver)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span> (<span class="keyword">string</span> name = <span class="string">"chnl_driver"</span>, uvm_component parent);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> set_interface(<span class="keyword">virtual</span> chnl_intf intf);</span><br><span class="line">    <span class="keyword">if</span>(intf == <span class="literal">null</span>)</span><br><span class="line">      <span class="built_in">$error</span>(<span class="string">"interface handle is NULL, please check if target interface has been intantiated"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.intf</span> = intf;</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">task</span> run_phase(uvm_phase phase);</span><br><span class="line">    <span class="keyword">fork</span></span><br><span class="line">     <span class="keyword">this</span><span class="variable">.do_drive</span>();</span><br><span class="line">     <span class="keyword">this</span><span class="variable">.do_reset</span>();</span><br><span class="line">    <span class="keyword">join</span></span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">task</span> do_reset();</span><br><span class="line">    <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">      @(<span class="keyword">negedge</span> intf<span class="variable">.rstn</span>);</span><br><span class="line">      intf<span class="variable">.ch_valid</span> &lt;= <span class="number">0</span>;</span><br><span class="line">      intf<span class="variable">.ch_data</span> &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">task</span> do_drive();</span><br><span class="line">    chnl_trans req, rsp;</span><br><span class="line">    @(<span class="keyword">posedge</span> intf<span class="variable">.rstn</span>);</span><br><span class="line">    <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.req_mb</span><span class="variable">.get</span>(req);</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.chnl_write</span>(req);</span><br><span class="line">      <span class="keyword">void</span>'(<span class="built_in">$cast</span>(rsp, req<span class="variable">.clone</span>()));</span><br><span class="line">      rsp<span class="variable">.rsp</span> = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">this</span><span class="variable">.rsp_mb</span><span class="variable">.put</span>(rsp);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">task</span> chnl_write(<span class="keyword">input</span> chnl_trans t);</span><br><span class="line">    <span class="keyword">foreach</span>(t<span class="variable">.data</span>[i]) <span class="keyword">begin</span></span><br><span class="line">      @(<span class="keyword">posedge</span> intf<span class="variable">.clk</span>);</span><br><span class="line">      intf<span class="variable">.drv_ck</span><span class="variable">.ch_valid</span> &lt;= <span class="number">1</span>;</span><br><span class="line">      intf<span class="variable">.drv_ck</span><span class="variable">.ch_data</span> &lt;= t<span class="variable">.data</span>[i];</span><br><span class="line">      @(<span class="keyword">negedge</span> intf<span class="variable">.clk</span>);</span><br><span class="line">      <span class="keyword">wait</span>(intf<span class="variable">.ch_ready</span> === <span class="number">'b1</span>);</span><br><span class="line">      <span class="meta">`uvm_info(get_type_name(), $sformatf("sent data 'h%8x", t.data[i]), UVM_HIGH)</span></span><br><span class="line">      <span class="keyword">repeat</span>(t<span class="variable">.data_nidles</span>) chnl_idle();</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">repeat</span>(t<span class="variable">.pkt_nidles</span>) chnl_idle();</span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">task</span> chnl_idle();</span><br><span class="line">    @(<span class="keyword">posedge</span> intf<span class="variable">.clk</span>);</span><br><span class="line">    intf<span class="variable">.drv_ck</span><span class="variable">.ch_valid</span> &lt;= <span class="number">0</span>;</span><br><span class="line">    intf<span class="variable">.drv_ck</span><span class="variable">.ch_data</span> &lt;= <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"><span class="keyword">endclass</span>: chnl_driver</span><br></pre></td></tr></table></figure>
<h3 id="chnl-generator类"><a href="#chnl-generator类" class="headerlink" title="chnl_generator类"></a><code>chnl_generator</code>类</h3><ul>
<li>相比于SV使用构建函数<code>new()</code>来创建对象， <code>send_trans()</code>方法中使用<code>req = chnl_trans::type_id::create(&quot;req&quot;)</code>来创建对象。</li>
<li>打印消息使用了UVM中的<code>&#39;uvm_info()</code>。</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// channel generator and to be replaced by sequence + sequencer later</span></span><br><span class="line"><span class="keyword">class</span> chnl_generator <span class="keyword">extends</span> uvm_component;</span><br><span class="line">  <span class="keyword">rand</span> <span class="keyword">int</span> pkt_id = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">rand</span> <span class="keyword">int</span> ch_id = -<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">rand</span> <span class="keyword">int</span> data_nidles = -<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">rand</span> <span class="keyword">int</span> pkt_nidles = -<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">rand</span> <span class="keyword">int</span> data_size = -<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">rand</span> <span class="keyword">int</span> ntrans = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">  mailbox <span class="variable">#(chnl_trans)</span> req_mb;</span><br><span class="line">  mailbox <span class="variable">#(chnl_trans)</span> rsp_mb;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constraint</span> cstr&#123;</span><br><span class="line">    <span class="keyword">soft</span> ch_id == -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">soft</span> pkt_id == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">soft</span> data_size == -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">soft</span> data_nidles == -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">soft</span> pkt_nidles == -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">soft</span> ntrans == <span class="number">10</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">`uvm_component_utils_begin(chnl_generator)</span></span><br><span class="line">    <span class="meta">`uvm_field_int(pkt_id, UVM_ALL_ON)</span></span><br><span class="line">    <span class="meta">`uvm_field_int(ch_id, UVM_ALL_ON)</span></span><br><span class="line">    <span class="meta">`uvm_field_int(data_nidles, UVM_ALL_ON)</span></span><br><span class="line">    <span class="meta">`uvm_field_int(pkt_nidles, UVM_ALL_ON)</span></span><br><span class="line">    <span class="meta">`uvm_field_int(data_size, UVM_ALL_ON)</span></span><br><span class="line">    <span class="meta">`uvm_field_int(ntrans, UVM_ALL_ON)</span></span><br><span class="line">  <span class="meta">`uvm_component_utils_end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span> (<span class="keyword">string</span> name = <span class="string">"chnl_generator"</span>, uvm_component parent);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">    <span class="keyword">this</span><span class="variable">.req_mb</span> = <span class="keyword">new</span>();</span><br><span class="line">    <span class="keyword">this</span><span class="variable">.rsp_mb</span> = <span class="keyword">new</span>();</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">task</span> start();</span><br><span class="line">    <span class="keyword">repeat</span>(ntrans) send_trans();</span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">task</span> send_trans();</span><br><span class="line">    chnl_trans req, rsp;</span><br><span class="line">    req = chnl_trans::type_id::create(<span class="string">"req"</span>);;</span><br><span class="line">    <span class="keyword">assert</span>(req<span class="variable">.randomize</span> <span class="keyword">with</span> &#123;<span class="keyword">local</span>::ch_id &gt;= <span class="number">0</span> -&gt; ch_id == <span class="keyword">local</span>::ch_id; </span><br><span class="line">                               <span class="keyword">local</span>::pkt_id &gt;= <span class="number">0</span> -&gt; pkt_id == <span class="keyword">local</span>::pkt_id;</span><br><span class="line">                               <span class="keyword">local</span>::data_nidles &gt;= <span class="number">0</span> -&gt; data_nidles == <span class="keyword">local</span>::data_nidles;</span><br><span class="line">                               <span class="keyword">local</span>::pkt_nidles &gt;= <span class="number">0</span> -&gt; pkt_nidles == <span class="keyword">local</span>::pkt_nidles;</span><br><span class="line">                               <span class="keyword">local</span>::data_size &gt;<span class="number">0</span> -&gt; data<span class="variable">.size</span>() == <span class="keyword">local</span>::data_size; </span><br><span class="line">                             &#125;)</span><br><span class="line">      <span class="keyword">else</span> <span class="built_in">$fatal</span>(<span class="string">"[RNDFAIL] channel packet randomization failure!"</span>);</span><br><span class="line">    <span class="keyword">this</span><span class="variable">.pkt_id</span>++;</span><br><span class="line">    <span class="meta">`uvm_info(get_type_name(), req.sprint(), UVM_HIGH)</span></span><br><span class="line">    <span class="keyword">this</span><span class="variable">.req_mb</span><span class="variable">.put</span>(req);</span><br><span class="line">    <span class="keyword">this</span><span class="variable">.rsp_mb</span><span class="variable">.get</span>(rsp);</span><br><span class="line">    <span class="meta">`uvm_info(get_type_name(), rsp.sprint(), UVM_HIGH)</span></span><br><span class="line">    <span class="keyword">assert</span>(rsp<span class="variable">.rsp</span>)</span><br><span class="line">      <span class="keyword">else</span> <span class="built_in">$error</span>(<span class="string">"[RSPERR] %0t error response received!"</span>, <span class="built_in">$time</span>);</span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">string</span> sprint();</span><br><span class="line">    <span class="keyword">string</span> s;</span><br><span class="line">    s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>)&#125;;</span><br><span class="line">    s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"chnl_generator object content is as below: \n"</span>)&#125;;</span><br><span class="line">    s = &#123;s, <span class="keyword">super</span><span class="variable">.sprint</span>()&#125;;</span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span>: field automation already implemented clone() method</span></span><br><span class="line">    <span class="comment">// s = &#123;s, $sformatf("ntrans = %0d: \n", this.ntrans)&#125;;</span></span><br><span class="line">    <span class="comment">// s = &#123;s, $sformatf("ch_id = %0d: \n", this.ch_id)&#125;;</span></span><br><span class="line">    <span class="comment">// s = &#123;s, $sformatf("pkt_id = %0d: \n", this.pkt_id)&#125;;</span></span><br><span class="line">    <span class="comment">// s = &#123;s, $sformatf("data_nidles = %0d: \n", this.data_nidles)&#125;;</span></span><br><span class="line">    <span class="comment">// s = &#123;s, $sformatf("pkt_nidles = %0d: \n", this.pkt_nidles)&#125;;</span></span><br><span class="line">    <span class="comment">// s = &#123;s, $sformatf("data_size = %0d: \n", this.data_size)&#125;;</span></span><br><span class="line">    s = &#123;s, <span class="built_in">$sformatf</span>(<span class="string">"=======================================\n"</span>)&#125;;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> post_randomize();</span><br><span class="line">    <span class="keyword">string</span> s;</span><br><span class="line">    s = &#123;<span class="string">"AFTER RANDOMIZATION \n"</span>, <span class="keyword">this</span><span class="variable">.sprint</span>()&#125;;</span><br><span class="line">    <span class="meta">`uvm_info(get_type_name(), s, UVM_HIGH)</span></span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"><span class="keyword">endclass</span>: chnl_generator</span><br></pre></td></tr></table></figure>
<h3 id="chnl-monitor类"><a href="#chnl-monitor类" class="headerlink" title="chnl_monitor类"></a><code>chnl_monitor</code>类</h3><p>将SV中的<code>run()</code>替换成了UVM中的<br> <code>run_phase(uvm_phase phase)</code>以及使用UVM中的<code>&#39;uvm_info()</code>打印消息。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// channel monitor</span></span><br><span class="line"><span class="keyword">class</span> chnl_monitor <span class="keyword">extends</span> uvm_monitor;</span><br><span class="line">  <span class="keyword">local</span> <span class="keyword">virtual</span> chnl_intf intf;</span><br><span class="line">  mailbox <span class="variable">#(mon_data_t)</span> mon_mb;</span><br><span class="line"></span><br><span class="line">  <span class="meta">`uvm_component_utils(chnl_monitor)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name=<span class="string">"chnl_monitor"</span>, uvm_component parent);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> set_interface(<span class="keyword">virtual</span> chnl_intf intf);</span><br><span class="line">    <span class="keyword">if</span>(intf == <span class="literal">null</span>)</span><br><span class="line">      <span class="built_in">$error</span>(<span class="string">"interface handle is NULL, please check if target interface has been intantiated"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">this</span><span class="variable">.intf</span> = intf;</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">task</span> run_phase(uvm_phase phase);</span><br><span class="line">    <span class="keyword">this</span><span class="variable">.mon_trans</span>();</span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">task</span> mon_trans();</span><br><span class="line">    mon_data_t m;</span><br><span class="line">    <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">      @(<span class="keyword">posedge</span> intf<span class="variable">.clk</span> <span class="keyword">iff</span> (intf<span class="variable">.mon_ck</span><span class="variable">.ch_valid</span>===<span class="number">'b1</span> &amp;&amp; intf<span class="variable">.mon_ck</span><span class="variable">.ch_ready</span>===<span class="number">'b1</span>));</span><br><span class="line">      m<span class="variable">.data</span> = intf<span class="variable">.mon_ck</span><span class="variable">.ch_data</span>;</span><br><span class="line">      mon_mb<span class="variable">.put</span>(m);</span><br><span class="line">      <span class="meta">`uvm_info(get_type_name(), $sformatf("monitored channel data 'h%8x", m.data), UVM_HIGH)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"><span class="keyword">endclass</span>: chnl_monitor</span><br></pre></td></tr></table></figure>
<h3 id="chnl-agent类"><a href="#chnl-agent类" class="headerlink" title="chnl_agent类"></a>chnl_agent类</h3><ul>
<li>SV验证结构中例化和连接都发生在构建函数new()里面，而UVM中例化是在build_phase()方法中，并且通过create()来例化创建对象。</li>
<li>SV验证结构中run()需要调用子一级的run()方法，而在UVM中不需要手动去调用子一级的run_phase()，因为run_phase是按照层次来执行的，是由uvm_root来安排的，会自动调用。</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// channel agent</span></span><br><span class="line"><span class="keyword">class</span> chnl_agent <span class="keyword">extends</span> uvm_agent;</span><br><span class="line">  chnl_driver driver;</span><br><span class="line">  chnl_monitor monitor;</span><br><span class="line">  <span class="keyword">local</span> <span class="keyword">virtual</span> chnl_intf vif;</span><br><span class="line"></span><br><span class="line">  <span class="meta">`uvm_component_utils(chnl_agent)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"chnl_agent"</span>, uvm_component parent);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> build_phase(uvm_phase phase);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.build_phase</span>(phase);</span><br><span class="line">    driver = chnl_driver::type_id::create(<span class="string">"driver"</span>, <span class="keyword">this</span>);</span><br><span class="line">    monitor = chnl_monitor::type_id::create(<span class="string">"monitor"</span>, <span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">void</span> set_interface(<span class="keyword">virtual</span> chnl_intf vif);</span><br><span class="line">    <span class="keyword">this</span><span class="variable">.vif</span> = vif;</span><br><span class="line">    driver<span class="variable">.set_interface</span>(vif);</span><br><span class="line">    monitor<span class="variable">.set_interface</span>(vif);</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">task</span> run_phase(uvm_phase phase);</span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span>: No more needed to call run manually</span></span><br><span class="line">    <span class="comment">// fork</span></span><br><span class="line">    <span class="comment">//   driver.run();</span></span><br><span class="line">    <span class="comment">//   monitor.run();</span></span><br><span class="line">    <span class="comment">// join</span></span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"><span class="keyword">endclass</span>: chnl_agent</span><br></pre></td></tr></table></figure>
<p><strong>reg_pkg.sv</strong>文件、<strong>fmt_pkg.sv</strong>文件、<strong>mcdf_pkg.sv</strong>文件修改的地方相似。</p>
<h2 id="1-3-mcdf"><a href="#1-3-mcdf" class="headerlink" title="1.3 mcdf"></a>1.3 mcdf</h2><h2 id="测试的开始和结束"><a href="#测试的开始和结束" class="headerlink" title="测试的开始和结束"></a>测试的开始和结束</h2><p>UVM验证环境测试的开始、环境构建的过程、连接以及结束的控制。</p>
<p><strong>tb.sv</strong></p>
<p>通过uvm_config_db完成了各个接口从TB(硬件一侧)到验证环境mcdf_env(软件一侧)的传递。实现了以往SV函数的剥离，即UVM不需要深入到目标组件一侧，调用其set_interface()即可完成传递。这种传递方式有赖于config_db的数据存储和层次传递特性。而在mcdf_env中，暂时保留了mcdf_env的set_interface()以及各个子组件的set_interface()函数。仅修改了TB与mcdf_env之间的接口传递，其实可以移除所有的set_interface()函数，完全使用uvm_config_db的set和get方法，从而使得mcdf_env与其各个子组件之间也实现“层次剥离”，这样也就进一步促进了组件之间的独立性。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span> </span><br><span class="line">    <span class="comment">// do interface configuration from top tb (HW) to verification env (SW)</span></span><br><span class="line">    uvm_config_db<span class="variable">#(virtual chnl_intf)::set(uvm_root::get(), "uvm_test_top", "ch0_vif", chnl0_if)</span>;</span><br><span class="line">    uvm_config_db<span class="variable">#(virtual chnl_intf)::set(uvm_root::get(), "uvm_test_top", "ch1_vif", chnl1_if)</span>;</span><br><span class="line">    uvm_config_db<span class="variable">#(virtual chnl_intf)::set(uvm_root::get(), "uvm_test_top", "ch2_vif", chnl2_if)</span>;</span><br><span class="line">    uvm_config_db<span class="variable">#(virtual reg_intf)::set(uvm_root::get(), "uvm_test_top", "reg_vif", reg_if)</span>;</span><br><span class="line">    uvm_config_db<span class="variable">#(virtual arb_intf)::set(uvm_root::get(), "uvm_test_top", "arb_vif", arb_if)</span>;</span><br><span class="line">    uvm_config_db<span class="variable">#(virtual fmt_intf)::set(uvm_root::get(), "uvm_test_top", "fmt_vif", fmt_if)</span>;</span><br><span class="line">    uvm_config_db<span class="variable">#(virtual mcdf_intf)::set(uvm_root::get(), "uvm_test_top", "mcdf_vif", mcdf_if)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If no external configured via +UVM_TESTNAME=my_test, the default test is</span></span><br><span class="line">    <span class="comment">// mcdf_data_consistence_basic_test</span></span><br><span class="line">    run_test(<span class="string">"mcdf_data_consistence_basic_test"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>
<p>通过调用run_test()函数即完成了test的选择、例化和开始测试。可以在代码中指定UVM test，或者通过 +UVM_TESTNAME=mytest在仿真选项中灵活传递test名。在run_test()执行中，它会初始化objection机制，即查看objection有没有挂起的地方，因此在test或者generator中必须至少有一处地方使用phase.raise_objection()来挂起仿真，避免仿真退出，而在仿真需要结束时，使用phase.drop_objection()来允许仿真可以退出。同时run_test()可以创建uvm_test组件，及其以下的各层组件群，并且可以调用phase控制方法，按照所有phase顺序执行。在UVM中，将对象的例化放置在build_phase中，而将对象的连接放置在connect_phase中。</p>
<h1 id="UVM-实验3"><a href="#UVM-实验3" class="headerlink" title="UVM-实验3"></a>UVM-实验3</h1><p>TLM通信的引入</p>
<p><img src="https://gitee.com/biongd/img/raw/master/img/20210727205241.png" alt="image-20210727205241147" style="zoom:67%;" /></p>
<h2 id="1-TLM单向通信和多向通信"><a href="#1-TLM单向通信和多向通信" class="headerlink" title="1. TLM单向通信和多向通信"></a>1. TLM单向通信和多向通信</h2><p>在之前的monitor到checker的通信，以及checker与reference model之间的通信，都是通过mailbox以及在上层进行其句柄的传递实现的。这次实验则使用TLM端口进行通信，做逐步的通信元素和方法的替换。</p>
<h3 id="agent-3"><a href="#agent-3" class="headerlink" title="agent"></a>agent</h3><p>将<code>agent.monitor</code>中的用来与<code>checker</code>中的<code>mailbox</code>通信的<code>mon_mb</code>句柄替换为对应的<code>uvm_blocking_put_port</code>类型。</p>
<p>以chnl的mailbox为例</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uvm_blocking_put_port <span class="variable">#(mon_data_t)</span> mon_bp_port;</span><br><span class="line"><span class="comment">//实例化</span></span><br><span class="line"> mon_bp_port = <span class="keyword">new</span>(<span class="string">"mon_bp_port"</span>, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<h3 id="mcdf-pkg"><a href="#mcdf-pkg" class="headerlink" title="mcdf_pkg"></a>mcdf_pkg</h3><p>在checker中声明与monitor通信的import端口类型，以及reference model通信的import端口类型，由于checker与多个monitor以及reference model通信，是典型的多方向通信类型，因此需要使用多端口通信的宏声明方法。在使用了宏声明端口类型之后，再在checker中声明其句柄，并且完成例化。</p>
<ul>
<li>3个monitor（port）</li>
<li>1个reg（port）</li>
<li>1个fmt（port）</li>
<li>3个refmod的chnl（port）</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//宏声明端口</span></span><br><span class="line"> <span class="meta">`uvm_blocking_put_imp_decl(_chnl0)</span></span><br><span class="line"> <span class="meta">`uvm_blocking_put_imp_decl(_chnl1)</span></span><br><span class="line"> <span class="meta">`uvm_blocking_put_imp_decl(_chnl2)</span></span><br><span class="line"> <span class="meta">`uvm_blocking_put_imp_decl(_fmt)</span></span><br><span class="line"> <span class="meta">`uvm_blocking_put_imp_decl(_reg)</span></span><br><span class="line"></span><br><span class="line"> <span class="meta">`uvm_blocking_get_peek_imp_decl(_chnl0)</span></span><br><span class="line"> <span class="meta">`uvm_blocking_get_peek_imp_decl(_chnl1)</span></span><br><span class="line"> <span class="meta">`uvm_blocking_get_peek_imp_decl(_chnl2)</span></span><br><span class="line"></span><br><span class="line"> <span class="meta">`uvm_blocking_get_imp_decl(_reg)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//声明句柄</span></span><br><span class="line">   uvm_blocking_put_imp_chnl0 <span class="variable">#(mon_data_t, mcdf_checker)</span>   chnl0_bp_imp;</span><br><span class="line">   uvm_blocking_put_imp_chnl1 <span class="variable">#(mon_data_t, mcdf_checker)</span>   chnl1_bp_imp;</span><br><span class="line">   uvm_blocking_put_imp_chnl2 <span class="variable">#(mon_data_t, mcdf_checker)</span>   chnl2_bp_imp;</span><br><span class="line">   uvm_blocking_put_imp_fmt   <span class="variable">#(fmt_trans , mcdf_checker)</span>   fmt_bp_imp  ;</span><br><span class="line">   uvm_blocking_put_imp_reg   <span class="variable">#(reg_trans , mcdf_checker)</span>   reg_bp_imp  ;</span><br><span class="line"></span><br><span class="line">   uvm_blocking_get_peek_imp_chnl0 <span class="variable">#(mon_data_t, mcdf_checker)</span>  chnl0_bgpk_imp;</span><br><span class="line">   uvm_blocking_get_peek_imp_chnl1 <span class="variable">#(mon_data_t, mcdf_checker)</span>  chnl1_bgpk_imp;</span><br><span class="line">   uvm_blocking_get_peek_imp_chnl2 <span class="variable">#(mon_data_t, mcdf_checker)</span>  chnl2_bgpk_imp;</span><br><span class="line"></span><br><span class="line">   uvm_blocking_get_imp_reg    <span class="variable">#(reg_trans , mcdf_checker)</span>  reg_bg_imp  ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//例化</span></span><br><span class="line">     chnl0_bp_imp = <span class="keyword">new</span>(<span class="string">"chnl0_bp_imp"</span>, <span class="keyword">this</span>);</span><br><span class="line">     chnl1_bp_imp = <span class="keyword">new</span>(<span class="string">"chnl1_bp_imp"</span>, <span class="keyword">this</span>);</span><br><span class="line">     chnl2_bp_imp = <span class="keyword">new</span>(<span class="string">"chnl2_bp_imp"</span>, <span class="keyword">this</span>);</span><br><span class="line">     fmt_bp_imp   = <span class="keyword">new</span>(<span class="string">"fmt_bp_imp"</span>, <span class="keyword">this</span>);  </span><br><span class="line">     reg_bp_imp   = <span class="keyword">new</span>(<span class="string">"reg_bp_imp"</span>, <span class="keyword">this</span>);  </span><br><span class="line"></span><br><span class="line">     chnl0_bgpk_imp = <span class="keyword">new</span>(<span class="string">"chnl0_bgpk_imp"</span>, <span class="keyword">this</span>);</span><br><span class="line">     chnl1_bgpk_imp = <span class="keyword">new</span>(<span class="string">"chnl1_bgpk_imp"</span>, <span class="keyword">this</span>);</span><br><span class="line">     chnl2_bgpk_imp = <span class="keyword">new</span>(<span class="string">"chnl2_bgpk_imp"</span>, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">     reg_bg_imp    = <span class="keyword">new</span>(<span class="string">"reg_bg_imp"</span>, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>根据声明的<code>import</code>端口类型，实现其对应的方法。(同样依赖mailbox作为)</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实现put方法</span></span><br><span class="line">   <span class="keyword">task</span> put_chnl0(mon_data_t t);</span><br><span class="line">     chnl_mbs[<span class="number">0</span>]<span class="variable">.put</span>(t);</span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line">   <span class="keyword">task</span> put_chnl1(mon_data_t t);</span><br><span class="line">     chnl_mbs[<span class="number">1</span>]<span class="variable">.put</span>(t);</span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line">   <span class="keyword">task</span> put_chnl2(mon_data_t t);</span><br><span class="line">     chnl_mbs[<span class="number">2</span>]<span class="variable">.put</span>(t);</span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line">   <span class="keyword">task</span> put_fmt(fmt_trans t);</span><br><span class="line">     fmt_mb<span class="variable">.put</span>(t);</span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line">   <span class="keyword">task</span> put_reg(reg_trans t);</span><br><span class="line">     reg_mb<span class="variable">.put</span>(t);</span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//实现get、peek方法</span></span><br><span class="line"><span class="keyword">task</span> peek_chnl0(<span class="keyword">output</span> mon_data_t t);</span><br><span class="line">     chnl_mbs[<span class="number">0</span>]<span class="variable">.peek</span>(t);</span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line">   <span class="keyword">task</span> peek_chnl1(<span class="keyword">output</span> mon_data_t t);</span><br><span class="line">     chnl_mbs[<span class="number">1</span>]<span class="variable">.peek</span>(t);</span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line">   <span class="keyword">task</span> peek_chnl2(<span class="keyword">output</span> mon_data_t t);</span><br><span class="line">     chnl_mbs[<span class="number">2</span>]<span class="variable">.peek</span>(t);</span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line">   <span class="keyword">task</span> get_chnl0(<span class="keyword">output</span> mon_data_t t);</span><br><span class="line">     chnl_mbs[<span class="number">0</span>]<span class="variable">.get</span>(t);</span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line">   <span class="keyword">task</span> get_chnl1(<span class="keyword">output</span> mon_data_t t);</span><br><span class="line">     chnl_mbs[<span class="number">1</span>]<span class="variable">.get</span>(t);</span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line">   <span class="keyword">task</span> get_chnl2(<span class="keyword">output</span> mon_data_t t);</span><br><span class="line">     chnl_mbs[<span class="number">2</span>]<span class="variable">.get</span>(t);</span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line">   <span class="keyword">task</span> get_reg(<span class="keyword">output</span> reg_trans t);</span><br><span class="line">     reg_mb<span class="variable">.get</span>(t);</span><br><span class="line">   <span class="keyword">endtask</span></span><br></pre></td></tr></table></figure>
<p>在<code>mcdf_refmod</code>中声明用来与<code>mcdf_checker</code>中的<code>import</code>连接的端口，并且完成例化。完成声明和例化后，使用TLM端口呼叫方法。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明端口</span></span><br><span class="line">   uvm_blocking_get_port <span class="variable">#(reg_trans)</span> reg_bg_port;</span><br><span class="line">   uvm_blocking_get_peek_port <span class="variable">#(mon_data_t)</span> in_bgpk_ports[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//端口例化</span></span><br><span class="line">reg_bg_port = <span class="keyword">new</span>(<span class="string">"reg_bg_port"</span>, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>在<code>mcdf_env</code>的<code>connect_phase()</code>阶段，完成<code>monitor</code>的TLM port与<code>mcdf_checker</code>的TLM import的连接。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chnl_agts[<span class="number">0</span>]<span class="variable">.monitor</span><span class="variable">.mon_bp_port</span><span class="variable">.connect</span>(chker<span class="variable">.chnl0_bp_imp</span>);</span><br><span class="line">chnl_agts[<span class="number">1</span>]<span class="variable">.monitor</span><span class="variable">.mon_bp_port</span><span class="variable">.connect</span>(chker<span class="variable">.chnl1_bp_imp</span>);</span><br><span class="line">chnl_agts[<span class="number">2</span>]<span class="variable">.monitor</span><span class="variable">.mon_bp_port</span><span class="variable">.connect</span>(chker<span class="variable">.chnl2_bp_imp</span>);</span><br><span class="line">reg_agt<span class="variable">.monitor</span><span class="variable">.mon_bp_port</span><span class="variable">.connect</span>(chker<span class="variable">.reg_bp_imp</span>);</span><br><span class="line">fmt_agt<span class="variable">.monitor</span><span class="variable">.mon_bp_port</span><span class="variable">.connect</span>(chker<span class="variable">.fmt_bp_imp</span>);</span><br></pre></td></tr></table></figure>
<p>在<code>mcdf_checker的</code>connect_phase()<code>阶段，完成</code>refmod<code>的TLM port与</code>mcdf_checker`的TLM import的连接。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">refmod<span class="variable">.in_bgpk_ports</span>[<span class="number">0</span>]<span class="variable">.connect</span>(chnl0_bgpk_imp);</span><br><span class="line">refmod<span class="variable">.in_bgpk_ports</span>[<span class="number">1</span>]<span class="variable">.connect</span>(chnl1_bgpk_imp);</span><br><span class="line">refmod<span class="variable">.in_bgpk_ports</span>[<span class="number">2</span>]<span class="variable">.connect</span>(chnl2_bgpk_imp);</span><br><span class="line"></span><br><span class="line">refmod<span class="variable">.reg_bg_port</span><span class="variable">.connect</span>(reg_bg_imp);</span><br></pre></td></tr></table></figure>
<p>refmod中端口的使用</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">task</span> do_reg_update();</span><br><span class="line">      reg_trans t;</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">//TODO-1.4 replace the reg_mb with the TLM port</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.reg_bg_port</span><span class="variable">.get</span>(t);</span><br><span class="line">        <span class="keyword">if</span>(t<span class="variable">.addr</span>[<span class="number">7</span>:<span class="number">4</span>] == <span class="number">0</span> &amp;&amp; t<span class="variable">.cmd</span> == <span class="meta">`WRITE) begin</span></span><br><span class="line">          <span class="keyword">this</span><span class="variable">.regs</span>[t<span class="variable">.addr</span>[<span class="number">3</span>:<span class="number">2</span>]]<span class="variable">.en</span> = t<span class="variable">.data</span>[<span class="number">0</span>];</span><br><span class="line">          <span class="keyword">this</span><span class="variable">.regs</span>[t<span class="variable">.addr</span>[<span class="number">3</span>:<span class="number">2</span>]]<span class="variable">.prio</span> = t<span class="variable">.data</span>[<span class="number">2</span>:<span class="number">1</span>];</span><br><span class="line">          <span class="keyword">this</span><span class="variable">.regs</span>[t<span class="variable">.addr</span>[<span class="number">3</span>:<span class="number">2</span>]]<span class="variable">.len</span> = t<span class="variable">.data</span>[<span class="number">5</span>:<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(t<span class="variable">.addr</span>[<span class="number">7</span>:<span class="number">4</span>] == <span class="number">1</span> &amp;&amp; t<span class="variable">.cmd</span> == <span class="meta">`READ) begin</span></span><br><span class="line">          <span class="keyword">this</span><span class="variable">.regs</span>[t<span class="variable">.addr</span>[<span class="number">3</span>:<span class="number">2</span>]]<span class="variable">.avail</span> = t<span class="variable">.data</span>[<span class="number">7</span>:<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">task</span> do_packet(<span class="keyword">int</span> id);</span><br><span class="line">      fmt_trans ot;</span><br><span class="line">      mon_data_t it;</span><br><span class="line">      <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">//TODO-1.4 replace the in_mbs with the TLM ports</span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.in_bgpk_ports</span>[id]<span class="variable">.peek</span>(it);</span><br><span class="line">        ot = <span class="keyword">new</span>();</span><br><span class="line">        ot<span class="variable">.length</span> = <span class="number">4</span> &lt;&lt; (<span class="keyword">this</span><span class="variable">.get_field_value</span>(id, RW_LEN) &amp; <span class="number">'b11</span>);</span><br><span class="line">        ot<span class="variable">.data</span> = <span class="keyword">new</span>[ot<span class="variable">.length</span>];</span><br><span class="line">        ot<span class="variable">.ch_id</span> = id;</span><br><span class="line">        <span class="keyword">foreach</span>(ot<span class="variable">.data</span>[m]) <span class="keyword">begin</span></span><br><span class="line">          <span class="comment">//TODO-1.4 replace the in_mbs with the TLM ports</span></span><br><span class="line">          <span class="keyword">this</span><span class="variable">.in_bgpk_ports</span>[id]<span class="variable">.get</span>(it);</span><br><span class="line">          ot<span class="variable">.data</span>[m] = it<span class="variable">.data</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">//TODO-2.1 replace the out_mbs[3] with uvm_tlm_fifo type </span></span><br><span class="line">        <span class="keyword">this</span><span class="variable">.out_tlm_fifos</span>[id]<span class="variable">.put</span>(ot);</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br></pre></td></tr></table></figure>
<h2 id="2-TLM通信管道"><a href="#2-TLM通信管道" class="headerlink" title="2. TLM通信管道"></a>2. TLM通信管道</h2><p>TLM通信的优点：</p>
<ul>
<li>通信函数可以定制化，例如可以定制put()/get()/peek()的内容和参数，这比mailbox的通信更加灵活。</li>
<li>将组件实现了完全的隔离，通过层次化的TLM端口连接，可以很好地避免直接将不同层次的数据缓存对象的句柄进行“空传递”。</li>
</ul>
<p>如果使用TLM端口，并且不用实现具体的put()/get()/peek()方法，可以使用uvm_tlm_fifo类。</p>
<p>将原本在mcdf_refmod中的out_mb替换成uvm_tlm_fifo类型，并且完成例化以及对应的变量名替换。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">uvm_tlm_fifo <span class="variable">#(fmt_trans)</span> out_tlm_fifos[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//例化</span></span><br><span class="line"><span class="keyword">foreach</span>(out_tlm_fifos[i]) out_tlm_fifos[i] = <span class="keyword">new</span>(<span class="built_in">$sformatf</span>(<span class="string">"out_tlm_fifos[%0d]"</span>, i), <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>将原本在<code>mcdf_checker</code>中的<code>exp_mbs[3]</code>的邮箱句柄数组，替换为<code>uvm_blocking_get_port</code>类型句柄数组，并且做相应的例化以及变量名替换。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uvm_blocking_get_port <span class="variable">#(fmt_trans)</span> exp_bg_ports[<span class="number">3</span>];</span><br><span class="line"><span class="comment">//实例化</span></span><br><span class="line"><span class="keyword">foreach</span>(exp_bg_ports[i]) exp_bg_ports[i] = <span class="keyword">new</span>(<span class="built_in">$sformatf</span>(<span class="string">"exp_bg_ports[%0d]"</span>, i), <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>在<code>mcdf_checker</code>中，完成<code>mcdf_checker</code>中的TLM port端口到<code>mcdf_refmod</code>中的<code>uvm_tlm_fifo</code>自带的<code>blocking_get_export</code>端口的连接。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(exp_bg_ports[i]) <span class="keyword">begin</span></span><br><span class="line">  exp_bg_ports[i]<span class="variable">.connect</span>(refmod<span class="variable">.out_tlm_fifos</span>[i]<span class="variable">.blocking_get_export</span>);</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="3-UVM回调类"><a href="#3-UVM回调类" class="headerlink" title="3. UVM回调类"></a>3. UVM回调类</h2><h4 id="逻辑："><a href="#逻辑：" class="headerlink" title="逻辑："></a>逻辑：</h4><p>原先mcdf_base_test类被子类mcdf_data_consistence_basic_test、mcdf_full_random_test类继承，不同的类激励生成的方式不同，依次来尽可能的完成覆盖率收集</p>
<p>增加回调类：</p>
<ul>
<li>相当于把产生激励的几个方法（do_data()，do_reg（），do_fmt（））抽离出来，放入回调类，然后<strong>绑定</strong>测试类mcdf_base_test和回调类cb_mcdf_base </li>
<li>测试类中的这几个方法，要<strong>插入</strong>回调类的相应方法，也就是执行回调方法！！！此时测试类mcdf_base_test和回调类cb_mcdf_base 都没有实现上述方法，同样需要回调类的子类实现</li>
<li>测试类的子类mcdf_data_consistence_basic_test、mcdf_full_random_test类都可以定义对应的回调类（继承自cb_mcdf_base ），实现（do_data()，do_reg（），do_fmt（））</li>
<li>此时的测试类就只需要把对应的回调类添加一下就好了，别的都不用管</li>
</ul>
<p>mcdf_data_consistence_basic_test的执行路径：</p>
<ul>
<li>执行build_phase，添加自己的回调类</li>
<li>本身没有run_phase，执行父类base_test的run_phase，父类run_phase中的方法（do_data()，do_reg（），do_fmt（））又会找到回调类中的相应方法执行</li>
</ul>
<p>在uvm_callback类中，预先定义需要的虚方法。(定义)</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">class</span> mcdf_base_test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> cb_mcdf_base <span class="keyword">extends</span> uvm_callback;</span><br><span class="line">  <span class="meta">`uvm_object_utils(cb_mcdf_base)</span></span><br><span class="line">  mcdf_base_test test;</span><br><span class="line">  <span class="keyword">function</span> <span class="keyword">new</span> (<span class="keyword">string</span> name = <span class="string">"cb_mcdf_base"</span>);</span><br><span class="line">    <span class="keyword">super</span><span class="variable">.new</span>(name);</span><br><span class="line">  <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">virtual</span> <span class="keyword">task</span> cb_do_reg();</span><br><span class="line">     </span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">virtual</span> <span class="keyword">task</span> cb_do_formatter();</span><br><span class="line">     </span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">virtual</span> <span class="keyword">task</span> cb_do_data();</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">endtask</span></span><br><span class="line"><span class="keyword">endclass</span></span><br></pre></td></tr></table></figure>
<p>使用<code>callback</code>对应的宏，完成目标<code>uvm_test</code>类型与目标<code>uvm_callback</code>类型的关联。（绑定）</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`uvm_register_cb(mcdf_base_test, cb_mcdf_base)</span></span><br></pre></td></tr></table></figure>
<p>在目标<code>uvm_test</code>类型指定的方法中，完成<code>uvm_callback</code>的方法回调指定。（插入）</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// do register configuration</span></span><br><span class="line"><span class="keyword">virtual</span> <span class="keyword">task</span> do_reg();</span><br><span class="line">  <span class="meta">`uvm_do_callbacks(mcdf_base_test, cb_mcdf_base, cb_do_reg())</span></span><br><span class="line"><span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// do external formatter down stream slave configuration</span></span><br><span class="line"><span class="keyword">virtual</span> <span class="keyword">task</span> do_formatter();       </span><br><span class="line">  <span class="meta">`uvm_do_callbacks(mcdf_base_test, cb_mcdf_base, cb_do_formatter())</span></span><br><span class="line"><span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// do data transition from 3 channel slaves</span></span><br><span class="line"><span class="keyword">virtual</span> <span class="keyword">task</span> do_data();</span><br><span class="line">  <span class="meta">`uvm_do_callbacks(mcdf_base_test, cb_mcdf_base, cb_do_data())</span></span><br><span class="line"><span class="keyword">endtask</span></span><br></pre></td></tr></table></figure>
<p>完整的mcdf_base_test类：</p>
<ul>
<li>17行：该类和回调类的绑定</li>
<li>97,103,109：插入回调方法，也就是test类的方法执行时其实是进入回调类中的方法</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MCDF base test</span></span><br><span class="line"> <span class="keyword">class</span> mcdf_base_test <span class="keyword">extends</span> uvm_test;</span><br><span class="line">   chnl_generator chnl_gens[<span class="number">3</span>];</span><br><span class="line">   reg_generator reg_gen;</span><br><span class="line">   fmt_generator fmt_gen;</span><br><span class="line">   mcdf_env env;</span><br><span class="line">   <span class="keyword">local</span> <span class="keyword">int</span> timeout = <span class="number">10</span>; <span class="comment">// 10 * ms</span></span><br><span class="line">   <span class="keyword">virtual</span> chnl_intf ch0_vif ;</span><br><span class="line">   <span class="keyword">virtual</span> chnl_intf ch1_vif ;</span><br><span class="line">   <span class="keyword">virtual</span> chnl_intf ch2_vif ;</span><br><span class="line">   <span class="keyword">virtual</span> reg_intf reg_vif  ;</span><br><span class="line">   <span class="keyword">virtual</span> arb_intf arb_vif  ;</span><br><span class="line">   <span class="keyword">virtual</span> fmt_intf fmt_vif  ;</span><br><span class="line">   <span class="keyword">virtual</span> mcdf_intf mcdf_vif;</span><br><span class="line"></span><br><span class="line">   <span class="meta">`uvm_component_utils(mcdf_base_test)</span></span><br><span class="line">   <span class="meta">`uvm_register_cb(mcdf_base_test, cb_mcdf_base)</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"mcdf_base_test"</span>, uvm_component parent);</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">   <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">function</span> <span class="keyword">void</span> build_phase(uvm_phase phase);</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.build_phase</span>(phase);</span><br><span class="line">     <span class="comment">// get virtual interface from top TB</span></span><br><span class="line">     <span class="keyword">if</span>(!uvm_config_db<span class="variable">#(virtual chnl_intf)::get(this,"","ch0_vif", ch0_vif))</span> <span class="keyword">begin</span></span><br><span class="line">       <span class="meta">`uvm_fatal("GETVIF","cannot get vif handle from config DB")</span></span><br><span class="line">     <span class="keyword">end</span></span><br><span class="line">     <span class="keyword">if</span>(!uvm_config_db<span class="variable">#(virtual chnl_intf)::get(this,"","ch1_vif", ch1_vif))</span> <span class="keyword">begin</span></span><br><span class="line">       <span class="meta">`uvm_fatal("GETVIF","cannot get vif handle from config DB")</span></span><br><span class="line">     <span class="keyword">end</span></span><br><span class="line">     <span class="keyword">if</span>(!uvm_config_db<span class="variable">#(virtual chnl_intf)::get(this,"","ch2_vif", ch2_vif))</span> <span class="keyword">begin</span></span><br><span class="line">       <span class="meta">`uvm_fatal("GETVIF","cannot get vif handle from config DB")</span></span><br><span class="line">     <span class="keyword">end</span></span><br><span class="line">     <span class="keyword">if</span>(!uvm_config_db<span class="variable">#(virtual reg_intf)::get(this,"","reg_vif", reg_vif))</span> <span class="keyword">begin</span></span><br><span class="line">       <span class="meta">`uvm_fatal("GETVIF","cannot get vif handle from config DB")</span></span><br><span class="line">     <span class="keyword">end</span></span><br><span class="line">     <span class="keyword">if</span>(!uvm_config_db<span class="variable">#(virtual arb_intf)::get(this,"","arb_vif", arb_vif))</span> <span class="keyword">begin</span></span><br><span class="line">       <span class="meta">`uvm_fatal("GETVIF","cannot get vif handle from config DB")</span></span><br><span class="line">     <span class="keyword">end</span></span><br><span class="line">     <span class="keyword">if</span>(!uvm_config_db<span class="variable">#(virtual fmt_intf)::get(this,"","fmt_vif", fmt_vif))</span> <span class="keyword">begin</span></span><br><span class="line">       <span class="meta">`uvm_fatal("GETVIF","cannot get vif handle from config DB")</span></span><br><span class="line">     <span class="keyword">end</span></span><br><span class="line">     <span class="keyword">if</span>(!uvm_config_db<span class="variable">#(virtual mcdf_intf)::get(this,"","mcdf_vif", mcdf_vif))</span> <span class="keyword">begin</span></span><br><span class="line">       <span class="meta">`uvm_fatal("GETVIF","cannot get vif handle from config DB")</span></span><br><span class="line">     <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">this</span><span class="variable">.env</span> = mcdf_env::type_id::create(<span class="string">"env"</span>, <span class="keyword">this</span>);</span><br><span class="line">     <span class="keyword">foreach</span>(<span class="keyword">this</span><span class="variable">.chnl_gens</span>[i]) <span class="keyword">begin</span></span><br><span class="line">       <span class="keyword">this</span><span class="variable">.chnl_gens</span>[i] = chnl_generator::type_id::create(<span class="built_in">$sformatf</span>(<span class="string">"chnl_gens[%0d]"</span>,i), <span class="keyword">this</span>);</span><br><span class="line">     <span class="keyword">end</span></span><br><span class="line">     <span class="keyword">this</span><span class="variable">.reg_gen</span> = reg_generator::type_id::create(<span class="string">"reg_gen"</span>, <span class="keyword">this</span>);</span><br><span class="line">     <span class="keyword">this</span><span class="variable">.fmt_gen</span> = fmt_generator::type_id::create(<span class="string">"fmt_gen"</span>, <span class="keyword">this</span>);</span><br><span class="line">   <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">function</span> <span class="keyword">void</span> connect_phase(uvm_phase phase);</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.connect_phase</span>(phase);</span><br><span class="line">     <span class="comment">// After get virtual interface from config_db, and then set them to</span></span><br><span class="line">     <span class="comment">// child components</span></span><br><span class="line">     <span class="keyword">this</span><span class="variable">.set_interface</span>(ch0_vif, ch1_vif, ch2_vif, reg_vif, arb_vif, fmt_vif, mcdf_vif);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">foreach</span>(<span class="keyword">this</span><span class="variable">.chnl_gens</span>[i]) <span class="keyword">begin</span></span><br><span class="line">       <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.chnl_agts</span>[i]<span class="variable">.driver</span><span class="variable">.req_mb</span> = <span class="keyword">this</span><span class="variable">.chnl_gens</span>[i]<span class="variable">.req_mb</span>;</span><br><span class="line">       <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.chnl_agts</span>[i]<span class="variable">.driver</span><span class="variable">.rsp_mb</span> = <span class="keyword">this</span><span class="variable">.chnl_gens</span>[i]<span class="variable">.rsp_mb</span>;</span><br><span class="line">     <span class="keyword">end</span></span><br><span class="line">     <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.reg_agt</span><span class="variable">.driver</span><span class="variable">.req_mb</span> = <span class="keyword">this</span><span class="variable">.reg_gen</span><span class="variable">.req_mb</span>;</span><br><span class="line">     <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.reg_agt</span><span class="variable">.driver</span><span class="variable">.rsp_mb</span> = <span class="keyword">this</span><span class="variable">.reg_gen</span><span class="variable">.rsp_mb</span>;</span><br><span class="line">     <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.fmt_agt</span><span class="variable">.driver</span><span class="variable">.req_mb</span> = <span class="keyword">this</span><span class="variable">.fmt_gen</span><span class="variable">.req_mb</span>;</span><br><span class="line">     <span class="keyword">this</span><span class="variable">.env</span><span class="variable">.fmt_agt</span><span class="variable">.driver</span><span class="variable">.rsp_mb</span> = <span class="keyword">this</span><span class="variable">.fmt_gen</span><span class="variable">.rsp_mb</span>;</span><br><span class="line">   <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">function</span> <span class="keyword">void</span> end_of_elaboration_phase(uvm_phase phase);</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.end_of_elaboration_phase</span>(phase);</span><br><span class="line">     uvm_root::get()<span class="variable">.set_report_verbosity_level_hier</span>(UVM_HIGH);</span><br><span class="line">     uvm_root::get()<span class="variable">.set_report_max_quit_count</span>(<span class="number">1</span>);</span><br><span class="line">     uvm_root::get()<span class="variable">.set_timeout</span>(<span class="number">10</span>ms);</span><br><span class="line">   <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">task</span> run_phase(uvm_phase phase);</span><br><span class="line">     <span class="comment">// <span class="doctag">NOTE:</span>: raise objection to prevent simulation stopping</span></span><br><span class="line">     phase<span class="variable">.raise_objection</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">     <span class="meta">`uvm_info(get_type_name(), "=====================STARTED=====================", UVM_LOW)</span></span><br><span class="line">     <span class="keyword">this</span><span class="variable">.do_reg</span>();</span><br><span class="line">     <span class="keyword">this</span><span class="variable">.do_formatter</span>();</span><br><span class="line">     <span class="keyword">this</span><span class="variable">.do_data</span>();</span><br><span class="line">     <span class="comment">//TODO-4.2 remove watchdog() method</span></span><br><span class="line">     <span class="meta">`uvm_info(get_type_name(), "=====================FINISHED=====================", UVM_LOW)</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// <span class="doctag">NOTE:</span>: drop objection to request simulation stopping</span></span><br><span class="line">     phase<span class="variable">.drop_objection</span>(<span class="keyword">this</span>);</span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// do register configuration</span></span><br><span class="line">   <span class="keyword">virtual</span> <span class="keyword">task</span> do_reg();</span><br><span class="line">     <span class="comment">//TODO-3.3 Use callback macro to link the callback method</span></span><br><span class="line">     <span class="meta">`uvm_do_callbacks(mcdf_base_test, cb_mcdf_base, cb_do_reg())</span></span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// do external formatter down stream slave configuration</span></span><br><span class="line">   <span class="keyword">virtual</span> <span class="keyword">task</span> do_formatter();</span><br><span class="line">     <span class="comment">//TODO-3.3 Use callback macro to link the callback method</span></span><br><span class="line">     <span class="meta">`uvm_do_callbacks(mcdf_base_test, cb_mcdf_base, cb_do_formatter())</span></span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// do data transition from 3 channel slaves</span></span><br><span class="line">   <span class="keyword">virtual</span> <span class="keyword">task</span> do_data();</span><br><span class="line">     <span class="comment">//TODO-3.3 Use callback macro to link the callback method</span></span><br><span class="line">     <span class="meta">`uvm_do_callbacks(mcdf_base_test, cb_mcdf_base, cb_do_data())</span></span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">endclass</span>: mcdf_base_test</span><br></pre></td></tr></table></figure>
<p>实现<code>uvm_callback</code>和对应<code>test</code>类的定义（添加）</p>
<p>build_phase中创建和添加回调类，需要注意这里语法的使用</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cb = cb_mcdf_data_consistence_basic::type_id::create(<span class="string">"cb"</span>);		<span class="comment">//创建回调函数</span></span><br><span class="line">uvm_callbacks<span class="variable">#(mcdf_base_test)::add(this, cb)</span>;		<span class="comment">//添加回调函数</span></span><br></pre></td></tr></table></figure>
<p>因为前面目标<code>uvm_test</code>类型与目标<code>uvm_callback</code>类型建立了绑定关系，这里传入的test类型还是父类的test</p>
<p>当test被执行时，执行父类test中的run_phase</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">class</span> cb_mcdf_data_consistence_basic <span class="keyword">extends</span> cb_mcdf_base;    <span class="comment">//回调类</span></span><br><span class="line">   <span class="meta">`uvm_object_utils(cb_mcdf_data_consistence_basic)</span></span><br><span class="line">   <span class="keyword">function</span> <span class="keyword">new</span> (<span class="keyword">string</span> name = <span class="string">"cb_mcdf_data_consistence_basic"</span>);</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.new</span>(name);</span><br><span class="line">   <span class="keyword">endfunction</span></span><br><span class="line">   <span class="keyword">task</span> cb_do_reg();</span><br><span class="line">     <span class="keyword">bit</span>[<span class="number">31</span>:<span class="number">0</span>] wr_val, rd_val;</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.cb_do_reg</span>();</span><br><span class="line">     <span class="comment">// slv0 with len=8,  prio=0, en=1</span></span><br><span class="line">     wr_val = (<span class="number">1</span>&lt;&lt;<span class="number">3</span>)+(<span class="number">0</span>&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>;</span><br><span class="line">     test<span class="variable">.write_reg</span>(<span class="meta">`SLV0_RW_ADDR, wr_val);</span></span><br><span class="line">     test<span class="variable">.read_reg</span>(<span class="meta">`SLV0_RW_ADDR, rd_val);</span></span><br><span class="line">     <span class="keyword">void</span>'(test<span class="variable">.diff_value</span>(wr_val, rd_val, <span class="string">"SLV0_WR_REG"</span>));</span><br><span class="line"></span><br><span class="line">     <span class="comment">// slv1 with len=16, prio=1, en=1</span></span><br><span class="line">     wr_val = (<span class="number">2</span>&lt;&lt;<span class="number">3</span>)+(<span class="number">1</span>&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>;</span><br><span class="line">     test<span class="variable">.write_reg</span>(<span class="meta">`SLV1_RW_ADDR, wr_val);</span></span><br><span class="line">     test<span class="variable">.read_reg</span>(<span class="meta">`SLV1_RW_ADDR, rd_val);</span></span><br><span class="line">     <span class="keyword">void</span>'(test<span class="variable">.diff_value</span>(wr_val, rd_val, <span class="string">"SLV1_WR_REG"</span>));</span><br><span class="line"></span><br><span class="line">     <span class="comment">// slv2 with len=32, prio=2, en=1</span></span><br><span class="line">     wr_val = (<span class="number">3</span>&lt;&lt;<span class="number">3</span>)+(<span class="number">2</span>&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>;</span><br><span class="line">     test<span class="variable">.write_reg</span>(<span class="meta">`SLV2_RW_ADDR, wr_val);</span></span><br><span class="line">     test<span class="variable">.read_reg</span>(<span class="meta">`SLV2_RW_ADDR, rd_val);</span></span><br><span class="line">     <span class="keyword">void</span>'(test<span class="variable">.diff_value</span>(wr_val, rd_val, <span class="string">"SLV2_WR_REG"</span>));</span><br><span class="line"></span><br><span class="line">     <span class="comment">// send IDLE command</span></span><br><span class="line">     test<span class="variable">.idle_reg</span>();</span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">task</span> cb_do_formatter();</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.cb_do_formatter</span>();</span><br><span class="line">     <span class="keyword">void</span>'(test<span class="variable">.fmt_gen</span><span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;fifo == LONG_FIFO; bandwidth == HIGH_WIDTH;&#125;);</span><br><span class="line">     test<span class="variable">.fmt_gen</span><span class="variable">.start</span>();</span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">task</span> cb_do_data();</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.cb_do_data</span>();</span><br><span class="line">     <span class="keyword">void</span>'(test<span class="variable">.chnl_gens</span>[<span class="number">0</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans==<span class="number">100</span>; ch_id==<span class="number">0</span>; data_nidles==<span class="number">0</span>; pkt_nidles==<span class="number">1</span>; data_size==<span class="number">8</span>; &#125;);</span><br><span class="line">     <span class="keyword">void</span>'(test<span class="variable">.chnl_gens</span>[<span class="number">1</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans==<span class="number">100</span>; ch_id==<span class="number">1</span>; data_nidles==<span class="number">1</span>; pkt_nidles==<span class="number">4</span>; data_size==<span class="number">16</span>;&#125;);</span><br><span class="line">     <span class="keyword">void</span>'(test<span class="variable">.chnl_gens</span>[<span class="number">2</span>]<span class="variable">.randomize</span>() <span class="keyword">with</span> &#123;ntrans==<span class="number">100</span>; ch_id==<span class="number">2</span>; data_nidles==<span class="number">2</span>; pkt_nidles==<span class="number">8</span>; data_size==<span class="number">32</span>;&#125;);</span><br><span class="line">     <span class="keyword">fork</span></span><br><span class="line">       test<span class="variable">.chnl_gens</span>[<span class="number">0</span>]<span class="variable">.start</span>();</span><br><span class="line">       test<span class="variable">.chnl_gens</span>[<span class="number">1</span>]<span class="variable">.start</span>();</span><br><span class="line">       test<span class="variable">.chnl_gens</span>[<span class="number">2</span>]<span class="variable">.start</span>();</span><br><span class="line">     <span class="keyword">join</span></span><br><span class="line">     #<span class="number">10</span>us; <span class="comment">// wait until all data haven been transfered through MCDF</span></span><br><span class="line">   <span class="keyword">endtask</span></span><br><span class="line"> <span class="keyword">endclass</span>: cb_mcdf_data_consistence_basic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//cb_mcdf_data_consistence_basic_test 中并没有实现do_reg()、do_formatter()、do_data()，</span></span><br><span class="line"><span class="comment">//运行test时会调用cb_mcdf_data_consistence_basic这个回调类，这里面实现了那三种方法。</span></span><br><span class="line"> <span class="keyword">class</span> cb_mcdf_data_consistence_basic_test <span class="keyword">extends</span> mcdf_base_test;</span><br><span class="line">   cb_mcdf_data_consistence_basic cb;</span><br><span class="line">   <span class="meta">`uvm_component_utils(cb_mcdf_data_consistence_basic_test)</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">function</span> <span class="keyword">new</span>(<span class="keyword">string</span> name = <span class="string">"cb_mcdf_data_consistence_basic_test"</span>, uvm_component parent);</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.new</span>(name, parent);</span><br><span class="line">   <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">function</span> <span class="keyword">void</span> build_phase(uvm_phase phase);</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.build_phase</span>(phase);</span><br><span class="line">     cb = cb_mcdf_data_consistence_basic::type_id::create(<span class="string">"cb"</span>);		<span class="comment">//创建回调函数</span></span><br><span class="line">     uvm_callbacks<span class="variable">#(mcdf_base_test)::add(this, cb)</span>;		<span class="comment">//添加回调函数</span></span><br><span class="line">   <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">function</span> <span class="keyword">void</span> connect_phase(uvm_phase phase);</span><br><span class="line">     <span class="keyword">super</span><span class="variable">.connect_phase</span>(phase);</span><br><span class="line">     cb<span class="variable">.test</span> = <span class="keyword">this</span>;</span><br><span class="line">   <span class="keyword">endfunction</span></span><br><span class="line"> <span class="keyword">endclass</span>: cb_mcdf_data_consistence_basic_test</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E6%95%B0%E5%AD%97IC/" rel="tag"># 数字IC</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/09/03/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E7%BA%BF%E7%A8%8B/" rel="next" title="操作系统-线程">
                <i class="fa fa-chevron-left"></i> 操作系统-线程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/10/06/IC%E9%AA%8C%E8%AF%81-UVM/" rel="prev" title="UVM">
                UVM <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="xujunjie'blog" />
            
              <p class="site-author-name" itemprop="name">xujunjie'blog</p>
              <p class="site-description motion-element" itemprop="description">使一个人有限的生命更加有效也即等于延长了人的生命</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">58</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#实验3-1：SystemVerilog的真正引入"><span class="nav-text">实验3-1：SystemVerilog的真正引入</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#文件结构"><span class="nav-text">文件结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#包chnl-pck"><span class="nav-text">包chnl_pck</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tb文件"><span class="nav-text">tb文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实验3-2：generator提取"><span class="nav-text">实验3-2：generator提取</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#文件变化"><span class="nav-text">文件变化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#包chnl-pck-1"><span class="nav-text">包chnl_pck</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实验3-3：增加新组件monitor和checker"><span class="nav-text">实验3-3：增加新组件monitor和checker</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#新加入文件结构"><span class="nav-text">新加入文件结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#包chnl-pack"><span class="nav-text">包chnl_pack</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tb文件-1"><span class="nav-text">tb文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实验4：新增结构"><span class="nav-text">实验4：新增结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#文件结构-1"><span class="nav-text">文件结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#param-def-v"><span class="nav-text">param_def.v</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-包chnl-pack-基层包，无需导包"><span class="nav-text">1. 包chnl_pack(基层包，无需导包)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#interface"><span class="nav-text">interface</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#transcation"><span class="nav-text">transcation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#driver"><span class="nav-text">driver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#generator"><span class="nav-text">generator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#monitor"><span class="nav-text">monitor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#agent"><span class="nav-text">agent</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-package-rpt-pkg（report工具包）"><span class="nav-text">2. package rpt_pkg（report工具包）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-package-reg-pkg-导包：-include-“param-def-v”"><span class="nav-text">3. package reg_pkg(导包：&#96;include “param_def.v”)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#问："><span class="nav-text">问：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#interface-1"><span class="nav-text">interface</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#transcation-1"><span class="nav-text">transcation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#driver-1"><span class="nav-text">driver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#generator-1"><span class="nav-text">generator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#monitor-1"><span class="nav-text">monitor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#agent-1"><span class="nav-text">agent</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-package-fmt-pkg"><span class="nav-text">4. package fmt_pkg</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#interface-2"><span class="nav-text">interface</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#enum"><span class="nav-text">enum</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#transcation-2"><span class="nav-text">transcation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#driver-2"><span class="nav-text">driver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#generator-2"><span class="nav-text">generator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#monitor-2"><span class="nav-text">monitor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#agent-2"><span class="nav-text">agent</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-package-mcdf-pkg（顶层包）"><span class="nav-text">5. package mcdf_pkg（顶层包）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#问：-1"><span class="nav-text">问：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#interface-3"><span class="nav-text">interface</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#enum-reg-packet"><span class="nav-text">enum+reg_packet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mcdf-refmod"><span class="nav-text">mcdf_refmod</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mcdf-checker"><span class="nav-text">mcdf_checker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mcdf-env"><span class="nav-text">mcdf_env</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#base-test"><span class="nav-text">base_test</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mcdf-data-consistence-basic-test"><span class="nav-text">mcdf_data_consistence_basic_test</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mcdf-full-random-test"><span class="nav-text">mcdf_full_random_test</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证文件"><span class="nav-text">验证文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实验5：功能覆盖率"><span class="nav-text">实验5：功能覆盖率</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#coverage工具类"><span class="nav-text">coverage工具类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-寄存器读写覆盖"><span class="nav-text">1. 寄存器读写覆盖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-寄存器非法指令测试"><span class="nav-text">2. 寄存器非法指令测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-通道关闭测试"><span class="nav-text">3. 通道关闭测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#UVM-实验1"><span class="nav-text">UVM-实验1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-工厂的注册、创建和覆盖机制"><span class="nav-text">1.1 工厂的注册、创建和覆盖机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#object类型实例创建"><span class="nav-text">object类型实例创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#component实例创建"><span class="nav-text">component实例创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#object覆盖类型"><span class="nav-text">object覆盖类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#component覆盖类型"><span class="nav-text">component覆盖类型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-域自动化及UVM常用方法"><span class="nav-text">1.2 域自动化及UVM常用方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-phase机制"><span class="nav-text">1.3 phase机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-config机制"><span class="nav-text">1.4 config机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#接口uvm-config-if和对象uvm-config"><span class="nav-text">接口uvm_config_if和对象uvm_config</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#底层comp2和次底层comp1类"><span class="nav-text">底层comp2和次底层comp1类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#顶层test类"><span class="nav-text">顶层test类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#uvm-config模块"><span class="nav-text">uvm_config模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-message管理"><span class="nav-text">1.5 message管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-1"><span class="nav-text">总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#UVM-实验2"><span class="nav-text">UVM-实验2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-验证组件和层次构建"><span class="nav-text">1.1 验证组件和层次构建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-UVM文件结构"><span class="nav-text">1.2 UVM文件结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#chnl-trans类"><span class="nav-text">chnl_trans类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#chnl-driver类"><span class="nav-text">chnl_driver类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#chnl-generator类"><span class="nav-text">chnl_generator类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#chnl-monitor类"><span class="nav-text">chnl_monitor类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#chnl-agent类"><span class="nav-text">chnl_agent类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-mcdf"><span class="nav-text">1.3 mcdf</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试的开始和结束"><span class="nav-text">测试的开始和结束</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#UVM-实验3"><span class="nav-text">UVM-实验3</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-TLM单向通信和多向通信"><span class="nav-text">1. TLM单向通信和多向通信</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#agent-3"><span class="nav-text">agent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mcdf-pkg"><span class="nav-text">mcdf_pkg</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-TLM通信管道"><span class="nav-text">2. TLM通信管道</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-UVM回调类"><span class="nav-text">3. UVM回调类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#逻辑："><span class="nav-text">逻辑：</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xujunjie'blog</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>


  
  <script src='https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize("");
    }
  </script>


  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "./public/search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  


  

  

</body>
</html>
